<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deportivo Botafogo - App Gestión</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" xintegrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        /* --- Estilos CSS (sin cambios significativos respecto a la versión anterior) --- */
        :root {
            --bg-primary: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-sidebar: #e5e7eb; /* gray-200 */
            --bg-sidebar-hover: #d1d5db; /* gray-300 */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --text-sidebar: #374151; /* gray-700 */
            --text-sidebar-title: #111827; /* gray-900 */
            --text-sidebar-hover: #111827; /* gray-900 */
            --border-color: #e5e7eb; /* gray-200 */
            --border-input: #d1d5db; /* gray-300 */
            --border-input-focus: #2563eb; /* blue-600 */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --link-color: #2563eb; /* blue-600 */
            --link-hover-color: #1d4ed8; /* blue-700 */
            --button-action-bg: #2563eb; /* blue-600 */
            --button-action-hover-bg: #1d4ed8; /* blue-700 */
            --sidebar-border-color: #d1d5db; /* gray-300 */
            --button-green-bg: #16a34a; /* green-600 */
            --button-green-hover-bg: #15803d; /* green-700 */
            --button-cancel-text: #4b5563; /* gray-600 */
            --button-cancel-hover-bg: #f3f4f6; /* gray-100 */
            --button-generic-bg: #e5e7eb;
            --button-generic-hover-bg: #d1d5db;
        }
        html.dark {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-sidebar: #1f2937; /* gray-800 */
            --bg-sidebar-hover: #374151; /* gray-700 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --text-sidebar: #d1d5db; /* gray-300 */
            --text-sidebar-title: #f9fafb; /* gray-50 */
            --text-sidebar-hover: #ffffff; /* white */
            --border-color: #374151; /* gray-700 */
            --border-input: #4b5563; /* gray-600 */
            --border-input-focus: #60a5fa; /* blue-400 */
            --shadow-color: rgba(0, 0, 0, 0.4);
            --link-color: #60a5fa; /* blue-400 */
            --link-hover-color: #93c5fd; /* blue-300 */
            --button-action-bg: #60a5fa; /* blue-400 */
            --button-action-hover-bg: #3b82f6; /* blue-500 */
            --sidebar-border-color: #4b5563; /* gray-600 */
            --button-green-bg: #22c55e; /* green-500 */
            --button-green-hover-bg: #16a34a; /* green-600 */
            --button-cancel-text: #d1d5db; /* gray-300 */
            --button-cancel-hover-bg: #374151; /* gray-700 */
            --button-generic-bg: #374151;
            --button-generic-hover-bg: #4b5563;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        #login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-primary); }
        .login-box { background-color: var(--bg-secondary); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); padding: 2.5rem; border-radius: 0.5rem; width: 100%; max-width: 28rem; text-align: center;}
        .login-logo { max-width: 200px; height: auto; margin-bottom: 1.5rem; margin-left: auto; margin-right: auto; }
        .login-input { border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); appearance-none; display: block; width: 100%; padding: 0.75rem; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); margin-bottom: 1rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;}
        .login-input::placeholder { color: var(--text-secondary); }
        .login-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); }
        .login-button { display: inline-flex; justify-content: center; width: 100%; padding: 0.75rem 1rem; border: 1px solid transparent; background-color: var(--button-action-bg); color: white; font-weight: 600; font-size: 0.875rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; transition: background-color 0.15s ease-in-out; }
        .login-button:hover { background-color: var(--button-action-hover-bg); }
        .login-error { color: #dc2626; min-height: 1.25rem; }
        #app-screen { display: none; }
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-sidebar); transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar-title { color: var(--text-sidebar-title); font-weight: 700; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav ul li a { padding: 10px 16px; display: flex; align-items: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-sidebar); border-radius: 0.375rem; }
        .sidebar-nav ul li a i { margin-right: 10px; font-size: 1.25rem; width: 20px; text-align: center; }
        .sidebar-nav ul li a:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        .sidebar .border-t { border-color: var(--sidebar-border-color); }
        .collapse-button { color: var(--text-sidebar); }
        .collapse-button:hover { color: var(--text-sidebar-hover); }
        #logout-button { color: var(--text-sidebar); padding-top: 0.75rem; padding-bottom: 0.75rem; }
        #logout-button:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        aside.sidebar-collapsed { width: 80px !important; padding-left: 10px; padding-right: 10px; }
        .sidebar-collapsed .menu-item-text span { display: none; }
        .sidebar-collapsed .sidebar-nav ul li a { justify-content: center; padding: 10px 0; }
        .sidebar-collapsed .sidebar-nav ul li a i { margin-right: 0; }
        .sidebar-collapsed .sidebar-title { display: none; }
        .sidebar-collapsed #logout-button span { display: none; }
        .sidebar-collapsed #logout-button i { margin-right: 0; }
        .flex-container { display: flex; }
        .flex-main { flex-grow: 1; position: relative; background-color: var(--bg-primary); }
        #main-title { color: var(--text-primary); }
        #content-area p { color: var(--text-secondary); }
        #content-area .bg-white { background-color: var(--bg-secondary); }
        #content-area h2 { color: var(--text-primary); }
        #content-area label, #content-area span { color: var(--text-primary); }
        #content-area .text-gray-500 { color: var(--text-secondary); }
        #content-area .bg-gray-50 { background-color: var(--bg-primary); border-color: var(--border-color); }
        #content-area table { border-color: var(--border-input); }
        #content-area thead { background-color: var(--bg-secondary); }
        #content-area th { color: var(--text-secondary); border-color: var(--border-color); font-weight: 600; }
        #content-area tbody { background-color: var(--bg-secondary); }
        #content-area tbody tr { border-bottom: 1px solid var(--border-color); }
        #content-area tbody tr:last-child { border-bottom: none; }
        #content-area td { color: var(--text-primary); border-color: var(--border-color); }
        #content-area tr:hover { background-color: var(--bg-primary); }
        ::placeholder { color: var(--text-secondary); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-secondary); }
        ::-ms-input-placeholder { color: var(--text-secondary); }
        .action-button { cursor: pointer; transition: color 0.15s ease-in-out; }
        .hidden-file-input { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-label { cursor: pointer; display: inline-flex; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .file-input-label:hover { background-color: var(--bg-primary); }
        .file-input-label i { margin-right: 0.5rem; }
        .form-input-base { display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); color: var(--text-primary); background-color: var(--bg-secondary); font-size: 0.875rem; }
        .form-input-base::placeholder { color: var(--text-secondary); }
        .form-input-base:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; appearance: none; }
        html.dark .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        .edit-user-button { background-color: #fbbf24; color: #78350f; }
        .edit-user-button:hover { background-color: #f59e0b; }
        html.dark .edit-user-button { background-color: #fcd34d; color: #78350f; }
        html.dark .edit-user-button:hover { background-color: #fbbf24; }
        #add-user-error { color: #dc2626; min-height: 1.25rem; }
        .action-button[data-action="generate-pdf"] { color: var(--link-color); }
        .action-button[data-action="generate-pdf"]:hover { color: var(--link-hover-color); }
        .action-button[data-action="edit"] { color: #ca8a04; }
        .action-button[data-action="edit"]:hover { color: #a16207; }
        html.dark .action-button[data-action="edit"] { color: #fcd34d; }
        html.dark .action-button[data-action="edit"]:hover { color: #fbbf24; }
        .action-button[data-action="delete"], .delete-btn { color: #dc2626; } 
        .action-button[data-action="delete"]:hover, .delete-btn:hover { color: #b91c1c; } 
        html.dark .action-button[data-action="delete"], html.dark .delete-btn { color: #f87171; } 
        html.dark .action-button[data-action="delete"]:hover, html.dark .delete-btn:hover { color: #fb7185; } 
        #form-tramite button[type=submit], #form-autorizacion button[type=submit], #form-add-user #user-submit-button[class*="bg-green"], #generate-button { background-color: var(--button-action-bg); color: white; }
        #form-tramite button[type=submit]:hover, #form-autorizacion button[type=submit]:hover, #form-add-user #user-submit-button[class*="bg-green"]:hover, #generate-button:hover { background-color: var(--button-action-hover-bg); }
        #form-add-user #user-submit-button { background-color: var(--button-green-bg); color: white; }
        #form-add-user #user-submit-button:hover { background-color: var(--button-green-hover-bg); }
        #form-add-user #user-cancel-button { border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-secondary); }
        #form-add-user #user-cancel-button:hover { background-color: var(--bg-primary); }
        .cropper-container-wrapper { max-width: 500px; height: 400px; margin-top: 0.5rem; border: 1px dashed var(--border-color); background-color: var(--bg-primary); }
        #cropper-image { display: block; max-width: 100%; max-height: 100%; }
        .result-canvas-container { margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-input); background-color: var(--bg-primary); border-radius: 0.375rem; text-align: center; min-height: 150px; }
        #result-canvas { border: 1px solid var(--border-color); max-width: 100%; height: auto; display: none; margin: 0 auto; }
        .button-group button, .button-group .file-input-label { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .button-group button:last-child, .button-group .file-input-label:last-child { margin-right: 0; }
        .form-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .single-char-input { width: 2.25rem; height: 2.25rem; text-align: center; padding: 0.25rem; margin-left: 0.25rem; margin-right: 0.5rem; border-width: 1px; border-radius: 0.375rem; border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); text-transform: uppercase; font-size: 0.875rem; }
        .single-char-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        #dark-mode-toggle { position: fixed; top: 1rem; right: 1rem; background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 9999px; padding: 0.5rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; z-index: 50; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; }
        #dark-mode-toggle:hover { background-color: var(--bg-primary); color: var(--text-primary); }
        #dark-mode-toggle i { font-size: 1.1rem; }
        .perspective-canvas-wrapper { width: 100%; max-width: 500px; height: 350px; margin: 1rem auto; border: 1px solid var(--border-input); background-color: var(--bg-secondary); border-radius: 0.375rem; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .perspective-canvas-wrapper canvas { max-width: 100%; max-height: 100%; cursor: crosshair; }
        #cedula-identidad-section .button-group button,
        #cedula-identidad-section .file-input-label-cedula { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); padding: 0.5rem 1rem; border-radius: 0.375rem; margin: 0.25rem; transition: all 0.2s ease; cursor: pointer; display: inline-flex; align-items: center; }
        #cedula-identidad-section .button-group button:hover,
        #cedula-identidad-section .file-input-label-cedula:hover { background-color: var(--button-generic-hover-bg); }
        #cedula-identidad-section #ci-perspective-save-btn,
        #cedula-identidad-section #ci-generate-cedula-pdf-btn { background-color: var(--button-action-bg) !important; color: white !important; }
        #cedula-identidad-section #ci-generate-cedula-pdf-btn[disabled] { background-color: var(--button-generic-bg) !important; color: var(--text-secondary) !important; opacity: 0.5; }
        #cedula-identidad-section #ciCanvasPlaceholderCedula { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); background-color: var(--bg-secondary); }
        .saved-images-container { margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--border-color); }
        .saved-image-item { display: inline-block; margin: 0.5rem; text-align: center; }
        .saved-image-preview { width: 120px; height: auto; max-height: 80px; object-fit: contain; border: 1px solid var(--border-input); margin-bottom: 0.5rem; background-color: var(--bg-primary); }
        
        /* Estilos para el Modal de Confirmación */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--bg-secondary); color: var(--text-primary); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 90%; width: 400px; }
        .modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .modal-content p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal-buttons button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #confirm-delete-btn { background-color: #dc2626; /* red-600 */ color: white; margin-right: 0.5rem; }
        #confirm-delete-btn:hover { background-color: #b91c1c; /* red-700 */ }
        #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); }
        #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }
        html.dark #confirm-delete-btn { background-color: #f87171; /* red-400 */ }
        html.dark #confirm-delete-btn:hover { background-color: #ef4444; /* red-500 */ }
        html.dark #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border-color: var(--border-input); }
        html.dark #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }

    </style>
</head>
<body class="bg-primary">
    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.imgur.com/IAVAqup.jpeg" alt="Logo Botafogo" class="login-logo" onerror="this.src='https://placehold.co/200x100/cccccc/333333?text=LOGO'; this.onerror=null;">
            <h2 class="text-2xl font-bold text-primary mb-6">Bienvenido a BotafogoApp v2.9</h2>
            <form id="login-form">
                <div>
                    <label for="username" class="sr-only">Usuario</label>
                    <input type="text" id="username" name="username" class="login-input" placeholder="Usuario" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Clave</label>
                    <input type="password" id="password" name="password" class="login-input" placeholder="Clave" required>
                </div>
                <div id="login-error-message" class="login-error mt-2 text-sm"></div>
                <button type="submit" class="login-button mt-4">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="min-h-screen flex-container">
        <aside class="w-64 bg-sidebar text-sidebar p-6 space-y-6 rounded-r-lg flex flex-col justify-between sidebar" id="sidebar">
            <div>
                <div class="text-2xl font-bold mb-6 sidebar-title text-sidebar-title">BotafogoApp v2.9</div>
                <nav class="sidebar-nav">
                    <ul class="space-y-2">
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-tramite"><i class="fas fa-file-contract text-lg"></i> <span>Trámite Individual</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-autorizacion"><i class="fas fa-file-signature text-lg"></i> <span>Autorización</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-lista"><i class="fas fa-list-alt text-lg"></i> <span>Listado Jugadores</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-fotocarnet"><i class="fas fa-id-badge text-lg"></i> <span>Foto Carnet</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-cedula-identidad"><i class="fas fa-id-card text-lg"></i> <span>Cédula Identidad</span></a></li>
                        <li id="li-menu-usuarios"><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-usuarios"><i class="fas fa-users-cog text-lg"></i> <span>Gestión Usuarios</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="border-t border-t-sidebar-border pt-4 mt-4 flex flex-col items-center">
                <button class="text-sidebar hover:text-sidebar-hover focus:outline-none collapse-button mb-4" id="collapse-toggle" title="Colapsar/Expandir Menú">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <button class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-md text-sidebar hover:bg-sidebar-hover hover:text-sidebar-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sidebar focus:ring-white" id="logout-button">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-8 flex-main bg-primary overflow-y-auto">
            <button id="dark-mode-toggle" title="Cambiar modo claro/oscuro" class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-moon"></i>
            </button>
            <h1 class="text-3xl font-bold mb-6 text-primary" id="main-title">Bienvenido</h1>
            <div id="content-area" class="text-secondary">
                <p>Selecciona una opción del menú lateral para comenzar.</p>
            </div>
        </main>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmar Eliminación</h3>
            <p id="delete-modal-message">¿Estás seguro de que deseas eliminar este elemento?</p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn">Confirmar Eliminación</button>
                <button id="cancel-delete-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURACIÓN SUPABASE ==========
        const SUPABASE_URL = 'https://nqwdsutnoscagzsgpssv.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2RzdXRub3NjYWd6c2dwc3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2MTExMTYsImV4cCI6MjA2MzE4NzExNn0.3uiBrCxxwfuNYotqkYF68yp-XthI8jZt3obxVa2l2us'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Datos Globales ---
        let cropperInstance = null;
        let isCropperScriptLoaded = false;
        let itemToDelete = { id: null, type: null, name: '' }; 

        // --- Funciones Auxiliares ---
        function formatRut(rutInput) {
            if (!rutInput) return;
            let rut = rutInput.value.replace(/[^0-9kK]/g, '').toLowerCase();
            let formattedRut = '';
            if (rut.length > 1) {
                let dv = rut.slice(-1);
                let body = rut.slice(0, -1);
                let bodyFormatted = "";
                while (body.length > 3) {
                    bodyFormatted = "." + body.slice(-3) + bodyFormatted;
                    body = body.slice(0, -3);
                }
                bodyFormatted = body + bodyFormatted;
                formattedRut = bodyFormatted + '-' + dv;
            } else {
                formattedRut = rut;
            }
            rutInput.value = formattedRut.toUpperCase();
        }

        function formatUsernameRut(rutInput) { 
            if (!rutInput) return;
            let value = rutInput.value.replace(/[^0-9kK-]/g, ''); 
            const parts = value.split('-');
            let body = parts[0].replace(/[^0-9kK]/g, ''); 
            let dv = '';
            if (parts.length > 1) {
                dv = parts.slice(1).join('').replace(/[^0-9kK]/g, ''); 
                if (dv.length > 1) dv = dv.charAt(0); 
            }
            value = body;
            if (dv.match(/^[0-9kK]$/i)) { 
                value += '-' + dv;
            } else if (dv) { 
                 value = body;
            }
            rutInput.value = value.toUpperCase();
        }
        
        function formatLoginUsername(inputElement) { 
            if (!inputElement) return;
            let value = inputElement.value;
            value = value.replace(/[^0-9kK-]/gi, ""); 
            let firstHyphenIndex = value.indexOf('-');
            if (firstHyphenIndex !== -1) {
                let part1 = value.substring(0, firstHyphenIndex + 1);
                let part2 = value.substring(firstHyphenIndex + 1).replace(/-/g, "");
                value = part1 + part2;
            }
            inputElement.value = value.toUpperCase();
        }

        function formatFechaNacimiento(dateInput) {
            if (!dateInput) return;
            let date = dateInput.value.replace(/[^0-9]/g, '');
            let formattedDate = '';
            if (date.length >= 2) {
                formattedDate += date.substring(0, 2);
                if (date.length >= 4) {
                    formattedDate += '-' + date.substring(2, 4);
                    if (date.length >= 8) {
                        formattedDate += '-' + date.substring(4, 8);
                    } else if (date.length > 4) {
                        formattedDate += '-' + date.substring(4);
                    }
                } else if (date.length > 2) {
                    formattedDate += '-' + date.substring(2);
                }
            } else {
                formattedDate = date;
            }
            dateInput.value = formattedDate.substring(0, 10);
        }

        // --- Funciones del Modal de Confirmación ---
        function showDeleteConfirmModal(id, type, itemName) {
            itemToDelete = { id, type, name: itemName };
            const modal = document.getElementById('delete-confirm-modal');
            const messageElement = document.getElementById('delete-modal-message');
            messageElement.textContent = `¿Estás seguro de que deseas eliminar "${itemName}"? Esta acción no se puede deshacer.`;
            if (modal) modal.style.display = 'flex';
        }

        function hideDeleteConfirmModal() {
            const modal = document.getElementById('delete-confirm-modal');
            if (modal) modal.style.display = 'none';
            itemToDelete = { id: null, type: null, name: '' }; // Reset
        }

        async function proceedWithDeletion() {
            if (!itemToDelete.id || !itemToDelete.type) return;
            console.log(`[proceedWithDeletion] Confirmado. Eliminando ${itemToDelete.type} con ID/Username: ${itemToDelete.id}`);

            let error;
            if (itemToDelete.type === 'user') {
                const { error: deleteError } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('username', itemToDelete.id); 
                error = deleteError;
            } else if (itemToDelete.type === 'tramite') {
                const { error: deleteError } = await supabaseClient
                    .from('players')
                    .delete()
                    .eq('id', itemToDelete.id); 
                error = deleteError;
            } else if (itemToDelete.type === 'autorizacion') {
                const { error: deleteError } = await supabaseClient
                    .from('autorizaciones')
                    .delete()
                    .eq('id', itemToDelete.id); 
                error = deleteError;
            }

            if (error) {
                console.error(`[proceedWithDeletion] Error de Supabase al eliminar ${itemToDelete.type}:`, error);
                alert(`Error al eliminar ${itemToDelete.type}: ` + error.message);
            } else {
                alert(`${itemToDelete.type.charAt(0).toUpperCase() + itemToDelete.type.slice(1)} eliminado/a exitosamente.`);
                console.log(`[proceedWithDeletion] ${itemToDelete.type} eliminado de Supabase:`, itemToDelete.id);
                if (itemToDelete.type === 'user') {
                    renderUserManagementForm();
                } else {
                    renderPlayerList();
                }
            }
            hideDeleteConfirmModal();
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            const menuUsuariosLi = document.getElementById('li-menu-usuarios');
            if (menuUsuariosLi) {
                menuUsuariosLi.style.display = 'none';
            }
        }
        function showAppScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if(mainTitle) mainTitle.innerText = 'Bienvenido';
            if(contentArea) contentArea.innerHTML = '<p class="text-lg">Selecciona una opción del menú lateral para comenzar.</p>';
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const menuUsuariosLi = document.getElementById('li-menu-usuarios');
            if (menuUsuariosLi) {
                menuUsuariosLi.style.display = (currentUser && currentUser.role === 'admin') ? 'list-item' : 'none';
            }
        }

        async function renderPlayerList() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) { showLoginScreen(); return; }

            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Listado de Jugadores y Autorizaciones';

            let playersQuery = supabaseClient.from('players').select('*');
            let autorizacionesQuery = supabaseClient.from('autorizaciones').select('*');

            if (currentUser.role !== 'admin') {
                playersQuery = playersQuery.eq('user_id', currentUser.id);
                autorizacionesQuery = autorizacionesQuery.eq('user_id', currentUser.id);
            }

            const { data: playersData, error: playersError } = await playersQuery;
            const { data: autorizacionesData, error: authError } = await autorizacionesQuery;

            let listHtml = `<div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">`;
            listHtml += `
                <div class="mb-8 p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Trámites Individuales</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Cédula</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Paterno</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Materno</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombres</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Fec. Nac.</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th>
                                    ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-secondary">`;
            if (playersError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '7' : '6'}" class="px-6 py-4 text-center text-red-500">Error cargando trámites: ${playersError.message}</td></tr>`;
            } else if (!playersData || playersData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '7' : '6'}" class="px-6 py-4 text-center text-secondary">No hay trámites registrados.</td></tr>`;
            } else {
                playersData.forEach((p) => {
                    listHtml += `<tr class="hover:bg-primary">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.ci || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellido_paterno || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellido_materno || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.nombres || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.fecha_nac || ''}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color"><button class="action-button" data-action="generate-pdf" data-type="tramite" data-id="${p.id}" title="Generar PDF Trámite"><i class="fas fa-file-pdf fa-lg"></i></button></td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${p.id}" data-type="tramite" data-name="${p.nombres || p.ci}" title="Eliminar Trámite">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                 </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;

            listHtml += `
                <div class="p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Autorizaciones</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Apoderado</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">CI Apod.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Jugador</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Parentesco</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th>
                                    ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-secondary">`;
            if (authError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '6' : '5'}" class="px-6 py-4 text-center text-red-500">Error cargando autorizaciones: ${authError.message}</td></tr>`;
            } else if (!autorizacionesData || autorizacionesData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '6' : '5'}" class="px-6 py-4 text-center text-secondary">No hay autorizaciones registradas.</td></tr>`;
            } else {
                autorizacionesData.forEach((a) => {
                    listHtml += `<tr class="hover:bg-primary">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderado_nombre || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderado_ci || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.jugador_nombre || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.parentesco || ''}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color"><button class="action-button" data-action="generate-pdf" data-type="autorizacion" data-id="${a.id}" title="Generar PDF Autorización"><i class="fas fa-file-pdf fa-lg"></i></button></td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${a.id}" data-type="autorizacion" data-name="${a.jugador_nombre || 'Autorización'}" title="Eliminar Autorización">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                 </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div></div>`;
            contentArea.innerHTML = listHtml;
        }

        function renderTramiteForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Trámite Individual';
            const inputBaseClasses = "form-input-base";
            const singleCharInputClasses = "single-char-input";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Jugador</h2>
                    <form id="form-tramite">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label for="ci" class="block text-sm font-medium text-secondary mb-1">Cédula de Identidad:</label>
                                <input type="text" id="ci" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                            <div>
                                <label for="fecha-nac" class="block text-sm font-medium text-secondary mb-1">Fecha Nacimiento:</label>
                                <input type="text" id="fecha-nac" class="${inputBaseClasses}" placeholder="dd-mm-aaaa" required maxlength="10">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="apellido-paterno" class="block text-sm font-medium text-secondary mb-1">Apellido Paterno:</label>
                                <input type="text" id="apellido-paterno" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="apellido-materno" class="block text-sm font-medium text-secondary mb-1">Apellido Materno:</label>
                                <input type="text" id="apellido-materno" class="${inputBaseClasses}" required>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                            <input type="text" id="nombres" class="${inputBaseClasses}" required>
                        </div>
                        <div class="mb-6">
                            <span class="block text-sm font-medium text-secondary mb-2">Solicita (Marcar con 'X'):</span>
                            <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-3 items-center">
                                <div class="flex items-center"> <input type="text" id="solicita_inscripcion_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Inscripción</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_interno_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Interno</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_regional_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Regional</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_externo_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Externo</span> </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <span class="block text-sm font-medium text-secondary mb-2">Categoría (Marcar con 'X'):</span>
                            <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-x-4 gap-y-3 items-center">
                                <div class="flex items-center"> <input type="text" id="categoria_extranjero_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Extranjero</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_libertad_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Libertad Acción</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_adulto_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Adulto</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_femenina_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Femenina</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_infantil_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Infantil</span> </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="procede-club" class="block text-sm font-medium text-secondary mb-1">Procede del Club:</label>
                                <input type="text" id="procede-club" class="${inputBaseClasses}">
                            </div>
                            <div>
                                <label for="procede-asociacion" class="block text-sm font-medium text-secondary mb-1">Asociación de Procedencia:</label>
                                <input type="text" id="procede-asociacion" class="${inputBaseClasses}">
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Trámite</button>
                        </div>
                    </form>
                </div>`;
            const form = document.getElementById('form-tramite');
            if (form) form.addEventListener('submit', handleTramiteSubmit);
            const ciInput = document.getElementById('ci');
            if (ciInput) ciInput.addEventListener('input', () => formatRut(ciInput));
            const fechaNacInput = document.getElementById('fecha-nac');
            if (fechaNacInput) fechaNacInput.addEventListener('input', () => formatFechaNacimiento(fechaNacInput));
            const inputsToUpper = ['apellido-paterno', 'apellido-materno', 'nombres', 'procede-club', 'procede-asociacion'];
            inputsToUpper.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
            const singleCharInputs = document.querySelectorAll('.single-char-input');
            singleCharInputs.forEach(input => {
                input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
        }

        function renderAutorizacionForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Autorización de Jugadores';
            const inputBaseClasses = "form-input-base";
            const selectBaseClasses = inputBaseClasses + " form-select-base";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Autorizante</h2>
                    <form id="form-autorizacion">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                            <div class="md:col-span-2">
                                <label for="apoderado-nombre" class="block text-sm font-medium text-secondary mb-1">Nombre del Apoderado:</label>
                                <input type="text" id="apoderado-nombre" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="apoderado-ci" class="block text-sm font-medium text-secondary mb-1">Cédula de Identidad:</label>
                                <input type="text" id="apoderado-ci" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                            <div class="md:col-span-2">
                                <label for="jugador-nombre-auth" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador:</label>
                                <input type="text" id="jugador-nombre-auth" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="parentesco" class="block text-sm font-medium text-secondary mb-1">Parentesco:</label>
                                <select id="parentesco" class="${selectBaseClasses}" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hermana">Hermana</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Tutor Legal">Tutor Legal</option>
                                    <option value="Abuelo">Abuelo</option>
                                    <option value="Abuela">Abuela</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Autorización</button>
                        </div>
                    </form>
                </div>`;
            const form = document.getElementById('form-autorizacion');
            if (form) form.addEventListener('submit', handleAutorizacionSubmit);
            const apoderadoCiInput = document.getElementById('apoderado-ci');
            if (apoderadoCiInput) apoderadoCiInput.addEventListener('input', () => formatRut(apoderadoCiInput));
            ['apoderado-nombre', 'jugador-nombre-auth'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
        }

        async function renderUserManagementForm() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Acceso restringido a administradores');
                showAppScreen();
                return;
            }
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Gestión de Usuarios';
            const inputBaseClasses = "form-input-base";
            const { data: usersData, error: usersError } = await supabaseClient.from('users').select('*');
            if (usersError) {
                contentArea.innerHTML = `<p class="text-red-500">Error cargando usuarios: ${usersError.message}</p>`;
                return;
            }
            let formHtml = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md mb-8">
                    <h2 id="user-form-title" class="text-lg sm:text-xl font-semibold mb-4 text-primary">Agregar Nuevo Usuario</h2>
                    <form id="form-add-user">
                        <input type="hidden" id="edit-user-id" value="">
                        <div class="mb-4">
                            <label for="new-fullname" class="block text-sm font-medium text-secondary mb-1">Nombre Completo:</label>
                            <input type="text" id="new-fullname" class="${inputBaseClasses}" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                            <div>
                                <label for="new-username" class="block text-sm font-medium text-secondary mb-1">Usuario:</label>
                                <input type="text" id="new-username" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-secondary mb-1">Clave:</label>
                                <input type="password" id="new-password" class="${inputBaseClasses}" placeholder="(dejar en blanco para no cambiar)">
                            </div>
                            <div class="flex flex-col">
                                <button type="submit" id="user-submit-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2">
                                    <span id="user-submit-button-text">Agregar</span>
                                </button>
                                <button type="button" id="user-cancel-button" class="hidden w-full mt-2 inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Cancelar Edición
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="new-role" class="block text-sm font-medium text-secondary mb-1">Rol:</label>
                            <select id="new-role" class="${inputBaseClasses} form-select-base">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div id="add-user-error" class="text-sm mt-1 min-h-[1.25rem]"></div>
                    </form>
                </div>`;
            let listHtml = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">Usuarios Registrados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-primary">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Completo</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Usuario</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Rol</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Editar</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>
                                </tr>
                            </thead>
                            <tbody class="bg-secondary">`;
            if (!usersData || usersData.length === 0) {
                listHtml += '<tr><td colspan="5" class="px-6 py-4 text-center text-secondary">No hay usuarios registrados.</td></tr>';
            } else {
                usersData.forEach((user) => {
                    listHtml += `<tr class="hover:bg-primary">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.nombre_completo || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.username}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.role || 'user'}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color">
                                        <button class="action-button" data-action="edit" data-type="user" data-id="${user.id}" title="Editar Usuario">
                                            <i class="fas fa-edit fa-lg"></i>
                                        </button>
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        <button class="action-button delete-btn" data-action="delete" data-type="user" data-id="${user.username}" data-name="${user.nombre_completo || user.username}" title="Eliminar Usuario">
                                            <i class="fas fa-user-times fa-lg"></i>
                                        </button>
                                    </td>
                                 </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;
            contentArea.innerHTML = formHtml + listHtml;
            resetUserForm();
            const addUserForm = document.getElementById('form-add-user');
            if (addUserForm) addUserForm.addEventListener('submit', handleAddUserSubmit);
            const cancelEditButton = document.getElementById('user-cancel-button');
            if(cancelEditButton) cancelEditButton.addEventListener('click', resetUserForm);
            const newUsernameInput = document.getElementById('new-username');
            if (newUsernameInput) newUsernameInput.addEventListener('input', () => formatUsernameRut(newUsernameInput));
            const newFullnameInput = document.getElementById('new-fullname');
            if (newFullnameInput) newFullnameInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        }

        function renderFotoCarnetForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch (e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }
            mainTitle.innerText = 'Generar Foto Carnet';
            const inputBaseClasses = "form-input-base";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <div class="form-section pt-0 border-t-0"> <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">1. Sube y Ajusta tu Foto</h2>
                        <div class="mb-4 button-group">
                            <input type="file" id="image-upload" class="hidden-file-input" accept="image/*">
                            <label for="image-upload" class="file-input-label">
                                <i class="fas fa-upload"></i> <span>Seleccionar Foto</span>
                            </label>
                        </div>
                        <div class="cropper-container-wrapper mb-4 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                             <img id="cropper-image" src="" alt="Área para ajustar foto. Sube una imagen para empezar.">
                        </div>
                    </div>
                    <div class="form-section"> <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">2. Ingresa tus Datos</h2>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <label for="foto-nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                                <input type="text" id="foto-nombres" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="foto-apellidos" class="block text-sm font-medium text-secondary mb-1">Apellidos:</label>
                                <input type="text" id="foto-apellidos" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="foto-rut" class="block text-sm font-medium text-secondary mb-1">Cédula de Identidad:</label>
                                <input type="text" id="foto-rut" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-section"> <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">3. Generar Foto</h2>
                        <div class="button-group mb-4">
                            <button type="button" id="generate-button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50" disabled>
                                <i class="fas fa-cogs mr-2"></i>Generar Foto Carnet
                            </button>
                        </div>
                        <div class="result-canvas-container">
                            <canvas id="result-canvas"></canvas>
                            <p id="canvas-placeholder" class="text-secondary">Aquí aparecerá la foto generada.</p>
                        </div>
                    </div>
                </div>`;
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js', setupFotoCarnetListeners);
        }

        function loadScript(src, callback) {
            const existingScript = document.querySelector(`script[src="${src}"]`);
            if (existingScript) {
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                const checkGlobalVar = (varName, cb) => {
                    if (typeof window[varName] !== 'undefined') { if (cb) cb(); }
                    else { setTimeout(() => checkGlobalVar(varName, cb), 100); }
                };
                if (src.includes('cropper')) checkGlobalVar('Cropper', callback);
                else if (callback) callback();
                return;
            }
            const script = document.createElement('script');
            script.src = src;
            script.defer = true;
            script.onload = () => {
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                if (callback) callback();
            };
            script.onerror = () => {
                console.error(`Error al cargar el script: ${src}`);
                alert(`Error crítico: No se pudo cargar la librería ${src}.`);
                if (src.includes('cropper')) {
                    const generateButton = document.getElementById('generate-button');
                    if(generateButton) generateButton.disabled = true;
                    const cropperContainer = document.querySelector('.cropper-container-wrapper');
                    if(cropperContainer) cropperContainer.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: Herramienta de recorte no cargada.</p>';
                }
            };
            document.body.appendChild(script);
        }

        function setupFotoCarnetListeners() {
            if (typeof Cropper === 'undefined') {
                console.error("Cropper no está definido.");
                return;
            }
            const imageUpload = document.getElementById('image-upload');
            const generateButton = document.getElementById('generate-button');
            const rutInput = document.getElementById('foto-rut');
            const textInputs = ['foto-nombres', 'foto-apellidos', 'foto-rut'];
            if (imageUpload) imageUpload.addEventListener('change', handleImageUploadWithCropper);
            if (generateButton) generateButton.addEventListener('click', generateFotoCarnetWithCropper);
            if (rutInput) {
                rutInput.addEventListener('input', () => {
                    formatRut(rutInput);
                    checkEnableGenerateButton();
                });
            }
            textInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', (e) => {
                        if (id !== 'foto-rut') e.target.value = e.target.value.toUpperCase();
                        checkEnableGenerateButton();
                    });
                }
            });
            checkEnableGenerateButton();
        }

        function checkEnableGenerateButton() {
            const generateButton = document.getElementById('generate-button');
            if (!generateButton) return;
            const nombres = document.getElementById('foto-nombres')?.value.trim();
            const apellidos = document.getElementById('foto-apellidos')?.value.trim();
            const rut = document.getElementById('foto-rut')?.value.trim();
            const isCropperReady = cropperInstance !== null && typeof cropperInstance.getCroppedCanvas === 'function';
            generateButton.disabled = !(isCropperReady && nombres && apellidos && rut);
        }

        function handleImageUploadWithCropper(event) {
            const file = event.target.files[0];
            const imageElement = document.getElementById('cropper-image');
            const resultCanvas = document.getElementById('result-canvas');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch(e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }
            if (resultCanvas) {
                const ctx = resultCanvas.getContext('2d');
                ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                resultCanvas.style.display = 'none';
                if(canvasPlaceholder) canvasPlaceholder.style.display = 'block';
            }
            checkEnableGenerateButton();
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageElement.src = e.target.result;
                    imageElement.alt = "Imagen cargada para recortar";
                    if (typeof Cropper === 'undefined') {
                        alert("Error: La librería de recorte no se cargó.");
                        return;
                    }
                    try {
                        cropperInstance = new Cropper(imageElement, {
                            aspectRatio: 3 / 4, viewMode: 1, dragMode: 'move', autoCropArea: 0.9,
                            background: false, zoomable: true, movable: true, cropBoxResizable: true,
                            ready: checkEnableGenerateButton, crop: checkEnableGenerateButton
                        });
                    } catch (error) {
                        alert(`Error al inicializar recorte: ${error.message}`);
                        imageElement.src = ""; imageElement.alt = "Error al cargar imagen.";
                    }
                };
                reader.readAsDataURL(file);
            } else {
                imageElement.src = ""; imageElement.alt = "Área para ajustar foto.";
                if(file) alert("Por favor, selecciona un archivo de imagen válido.");
                checkEnableGenerateButton();
            }
        }

        function generateFotoCarnetWithCropper() {
            if (!cropperInstance || typeof cropperInstance.getCroppedCanvas !== 'function') {
                alert("Sube y ajusta una imagen primero.");
                return;
            }
            const nombres = document.getElementById('foto-nombres').value.trim();
            const apellidos = document.getElementById('foto-apellidos').value.trim();
            const rut = document.getElementById('foto-rut').value.trim();
            if (!nombres || !apellidos || !rut) {
                alert("Completa Nombres, Apellidos y RUT.");
                return;
            }
            let croppedCanvas;
            try {
                croppedCanvas = cropperInstance.getCroppedCanvas({
                    width: 300, imageSmoothingEnabled: true, imageSmoothingQuality: 'high',
                });
                if (!croppedCanvas.width || !croppedCanvas.height) throw new Error("Área recortada inválida.");
            } catch (error) {
                alert(`Error al recortar: ${error.message}.`);
                return;
            }
            const resultCanvas = document.getElementById('result-canvas');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const ctx = resultCanvas.getContext('2d');
            const photoWidth = croppedCanvas.width;
            const photoHeight = croppedCanvas.height;
            const textLineHeight = Math.max(18, photoWidth * 0.06);
            const textPaddingVertical = Math.max(10, photoWidth * 0.033);
            const fontSize = Math.max(16, photoWidth * 0.053);
            const textStripHeight = (textLineHeight * 3) + (textPaddingVertical * 2);
            resultCanvas.width = photoWidth; resultCanvas.height = photoHeight;
            ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            ctx.drawImage(croppedCanvas, 0, 0, resultCanvas.width, resultCanvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            const stripY = resultCanvas.height - textStripHeight;
            ctx.fillRect(0, stripY, resultCanvas.width, textStripHeight);
            ctx.fillStyle = 'white'; ctx.font = `bold ${fontSize}px Inter, sans-serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const textBaseY = stripY + textPaddingVertical;
            const textY1 = textBaseY + (textLineHeight / 2);
            const textY2 = textY1 + textLineHeight;
            const textY3 = textY2 + textLineHeight;
            ctx.fillText(nombres.toUpperCase(), resultCanvas.width / 2, textY1);
            ctx.fillText(apellidos.toUpperCase(), resultCanvas.width / 2, textY2);
            ctx.font = `${fontSize}px Inter, sans-serif`;
            ctx.fillText(rut.toUpperCase(), resultCanvas.width / 2, textY3);
            resultCanvas.style.display = 'block';
            if(canvasPlaceholder) canvasPlaceholder.style.display = 'none';
        }

        // --- Funciones Handler (Manejadores de Eventos) ---
        async function handleLoginSubmit(event) {
            event.preventDefault();
            const cedulaInput = document.getElementById('username');
            let cedula = cedulaInput.value; 
            
            cedula = cedula.replace(/\./g, ""); 

            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('login-error-message');
            errorMessage.textContent = '';

            console.log('[handleLoginSubmit] Intentando login con Cédula (username) procesada:', cedula);

            const { data: user, error } = await supabaseClient
                .from('users') 
                .select('*')
                .eq('username', cedula) 
                .single();

            if (error || !user) { 
                console.error('[handleLoginSubmit] Error de Supabase o usuario no encontrado:', error);
                errorMessage.textContent = 'Credenciales inválidas o error de conexión.';
                return;
            }
            
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', passwordData);
            const passwordHash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

            if (passwordHash === user.password_hash) {
                console.log('[handleLoginSubmit] Login exitoso para:', user.username);
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showAppScreen();
            } else {
                console.warn('[handleLoginSubmit] Contraseña incorrecta para:', cedula);
                errorMessage.textContent = 'Credenciales inválidas.';
            }
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        async function handleAddUserSubmit(event) {
            event.preventDefault();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Acceso no autorizado.'); return;
            }

            const nombre_completo = document.getElementById('new-fullname').value.trim();
            const cedula = document.getElementById('new-username').value.trim(); 
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const errorDiv = document.getElementById('add-user-error');
            const editUserId = document.getElementById('edit-user-id').value; 
            errorDiv.textContent = '';

            if (!nombre_completo || !cedula || !role) {
                errorDiv.textContent = 'Nombre Completo, Usuario y Rol son requeridos.';
                return;
            }

            let password_hash = null;
            if (password) { 
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                password_hash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            if (editUserId) { 
                const userDataToUpdate = {
                    nombre_completo: nombre_completo,
                    username: cedula, 
                    role: role,
                };
                if (password_hash) { 
                    userDataToUpdate.password_hash = password_hash;
                }
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update(userDataToUpdate)
                    .eq('id', editUserId);

                if (updateError) {
                    console.error("Error al actualizar usuario:", updateError);
                    errorDiv.textContent = 'Error al actualizar usuario: ' + updateError.message;
                } else {
                    alert('Usuario actualizado exitosamente.');
                    renderUserManagementForm();
                }
            } else { 
                if (!password_hash) { 
                    errorDiv.textContent = 'Debe ingresar la clave para un nuevo usuario.';
                    return;
                }
                const { data, error: insertError } = await supabaseClient
                    .from('users') 
                    .insert([{
                        username: cedula, 
                        password_hash: password_hash, 
                        nombre_completo: nombre_completo,
                        role: role
                    }]);

                if (insertError) {
                    console.error("Error al registrar usuario:", insertError);
                    if (insertError.message.includes('duplicate key value violates unique constraint')) {
                         errorDiv.textContent = 'Error: El usuario ya existe.';
                    } else {
                        errorDiv.textContent = 'Error al registrar usuario: ' + insertError.message;
                    }
                } else {
                    alert('Usuario registrado exitosamente.');
                    renderUserManagementForm();
                }
            }
        }
        
        async function populateUserEditForm(userId) { 
            const { data: user, error } = await supabaseClient.from('users').select('*').eq('id', userId).single();
            if (error || !user) { alert('No se pudo cargar el usuario para editar.'); return; }
            document.getElementById('new-fullname').value = user.nombre_completo || '';
            document.getElementById('new-username').value = user.username; 
            document.getElementById('new-password').value = '';
            document.getElementById('new-password').placeholder = 'Nueva Clave (o dejar en blanco)';
            document.getElementById('new-role').value = user.role || 'user';
            document.getElementById('edit-user-id').value = user.id; 
            document.getElementById('user-form-title').textContent = 'Editar Usuario';
            const submitButton = document.getElementById('user-submit-button');
            submitButton.classList.remove('bg-button-green-bg', 'hover:bg-button-green-hover-bg');
            submitButton.classList.add('edit-user-button');
            document.getElementById('user-submit-button-text').textContent = 'Guardar Cambios';
            document.getElementById('user-cancel-button').classList.remove('hidden');
            document.getElementById('add-user-error').textContent = '';
            document.getElementById('new-fullname').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-fullname').focus();
        }

        function resetUserForm() {
            const form = document.getElementById('form-add-user');
            if (form) form.reset();
            document.getElementById('edit-user-id').value = '';
            document.getElementById('user-form-title').textContent = 'Agregar Nuevo Usuario';
            const submitButton = document.getElementById('user-submit-button');
            if (submitButton) {
                submitButton.classList.remove('edit-user-button');
                submitButton.classList.add('bg-button-green-bg', 'hover:bg-button-green-hover-bg');
            }
            document.getElementById('user-submit-button-text').textContent = 'Agregar';
            document.getElementById('user-cancel-button').classList.add('hidden');
            const passwordInput = document.getElementById('new-password');
            if (passwordInput) passwordInput.placeholder = '';
            const roleInput = document.getElementById('new-role');
            if (roleInput) roleInput.value = 'user';
            document.getElementById('add-user-error').textContent = '';
        }

        async function handleTramiteSubmit(event) {
            event.preventDefault();
            console.log('[handleTramiteSubmit] Botón Guardar Trámite presionado.'); 
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) { alert("Debes iniciar sesión."); showLoginScreen(); return; }
            const tramiteData = {
                ci: document.getElementById('ci').value,
                fecha_nac: document.getElementById('fecha-nac').value,
                apellido_paterno: document.getElementById('apellido-paterno').value,
                apellido_materno: document.getElementById('apellido-materno').value,
                nombres: document.getElementById('nombres').value,
                solicita_inscripcion: document.getElementById('solicita_inscripcion_char').value.trim().toUpperCase() || null,
                solicita_pase_interno: document.getElementById('solicita_pase_interno_char').value.trim().toUpperCase() || null,
                solicita_pase_regional: document.getElementById('solicita_pase_regional_char').value.trim().toUpperCase() || null,
                solicita_pase_externo: document.getElementById('solicita_pase_externo_char').value.trim().toUpperCase() || null,
                categoria_extranjero: document.getElementById('categoria_extranjero_char').value.trim().toUpperCase() || null,
                categoria_libertad: document.getElementById('categoria_libertad_char').value.trim().toUpperCase() || null,
                categoria_adulto: document.getElementById('categoria_adulto_char').value.trim().toUpperCase() || null,
                categoria_femenina: document.getElementById('categoria_femenina_char').value.trim().toUpperCase() || null,
                categoria_infantil: document.getElementById('categoria_infantil_char').value.trim().toUpperCase() || null,
                procede_club: document.getElementById('procede-club').value,
                procede_asociacion: document.getElementById('procede-asociacion').value,
                user_id: currentUser.id
            };
            const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
            if (!dateRegex.test(tramiteData.fecha_nac)) { alert('Formato Fecha Nacimiento: DD-MM-AAAA.'); return; }
            const solicitaValue = Object.keys(tramiteData).filter(k => k.startsWith('solicita_') && tramiteData[k]).length > 0;
            const categoriaValue = Object.keys(tramiteData).filter(k => k.startsWith('categoria_') && tramiteData[k]).length > 0;
            if (!solicitaValue) { alert('Marque una opción en "Solicita".'); return; }
            if (!categoriaValue) { alert('Marque una opción en "Categoría".'); return; }
            
            console.log('[handleTramiteSubmit] Datos del trámite a guardar:', tramiteData);
            const { error } = await supabaseClient.from('players').insert([tramiteData]);
            if (error) {
                console.error('[handleTramiteSubmit] Error al guardar trámite:', error);
                alert('Error al guardar trámite: ' + error.message);
            } else { 
                alert('Trámite guardado exitosamente!'); 
                document.getElementById('form-tramite').reset(); 
                renderPlayerList(); 
            }
        }

        async function handleAutorizacionSubmit(event) { 
            event.preventDefault();
            console.log('[handleAutorizacionSubmit] Botón Guardar Autorización presionado.'); // Log para depuración
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.id) { // Verificación más robusta
                alert("Debes iniciar sesión para guardar una autorización. Falta ID de usuario.");
                console.error('[handleAutorizacionSubmit] currentUser o currentUser.id no definido:', currentUser);
                showLoginScreen();
                return;
            }
            
            const autorizacionData = {
                apoderado_nombre: document.getElementById('apoderado-nombre').value,
                apoderado_ci: document.getElementById('apoderado-ci').value,
                jugador_nombre: document.getElementById('jugador-nombre-auth').value,
                parentesco: document.getElementById('parentesco').value,
                user_id: currentUser.id 
            };

            if (autorizacionData.parentesco === "") {
                alert("Por favor, seleccione un parentesco.");
                return;
            }
            console.log('[handleAutorizacionSubmit] Datos de la autorización a guardar:', autorizacionData);
            const { error } = await supabaseClient
                .from('autorizaciones')
                .insert([autorizacionData]);

            if (error) {
                console.error('[handleAutorizacionSubmit] Error al guardar autorización:', error);
                alert('Error al guardar autorización: ' + error.message);
            } else {
                alert('Autorización guardada exitosamente en Supabase!');
                document.getElementById('form-autorizacion').reset();
                renderPlayerList(); 
            }
        }

        async function generatePdf(type, id) { 
            if (typeof PDFLib === 'undefined' || !PDFLib.PDFDocument) { alert("Librería PDF no lista."); return; }
            const { PDFDocument } = PDFLib;
            const urlTramite = "https://zkak0.github.io/BotafogoApp/tramite_individual.pdf";
            const urlAutorizacion = "https://zkak0.github.io/BotafogoApp/autorizacion_jugadores.pdf";
            let pdfUrlToLoad, dataToFill, outputFilename, isTramite = false;

            if (type === 'tramite') {
                isTramite = true;
                const { data, error } = await supabaseClient.from('players').select('*').eq('id', id).single();
                if (error || !data) { alert("Error: Trámite no encontrado."); return; }
                dataToFill = data; pdfUrlToLoad = urlTramite;
                outputFilename = `tramite_${(data.ci || 'jugador')}_${Date.now()}.pdf`;
            } else if (type === 'autorizacion') {
                const { data, error } = await supabaseClient.from('autorizaciones').select('*').eq('id', id).single();
                if (error || !data) { alert("Error: Autorización no encontrada."); return; }
                dataToFill = data; pdfUrlToLoad = urlAutorizacion;
                outputFilename = `autorizacion_${(dataToFill.jugador_nombre || 'jugador')}_${Date.now()}.pdf`;
            } else { alert('Error: Tipo de PDF desconocido.'); return; }

            try {
                const existingPdfBytes = await fetch(pdfUrlToLoad).then(res => {
                    if (!res.ok) throw new Error(`Error descarga plantilla (${res.status})`); return res.arrayBuffer();
                });
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                if (isTramite) {
                    const fieldMap = {
                        ci: 'CEDULA IDENTIDAD', fechaNac: 'FECHA NAC', apellidoPaterno: 'APELLIDO PATERNO',
                        apellidoMaterno: 'APELLIDO MATERNO', nombres: 'NOMBRES', procedeClub: 'PROCEDE DEL CLUB',
                        procedeAsociacion: 'ASOCIACION', solicita_inscripcion: 'INSCRIPCION',
                        solicita_pase_interno: 'PASE INTERNO', solicita_pase_regional: 'PASE REGIONAL',
                        solicita_pase_externo: 'PASE EXTERNO', categoria_extranjero: 'EXTRANJERO',
                        categoria_libertad: 'LIBERTAD ACCION', categoria_adulto: 'ADULTO',
                        categoria_femenina: 'FEMENINA', categoria_infantil: 'INFANTIL'
                    };
                    const dataForPdf = { 
                        ci: dataToFill.ci, fechaNac: dataToFill.fecha_nac, apellidoPaterno: dataToFill.apellido_paterno,
                        apellidoMaterno: dataToFill.apellido_materno, nombres: dataToFill.nombres,
                        procedeClub: dataToFill.procede_club, procedeAsociacion: dataToFill.procede_asociacion,
                        solicita_inscripcion: dataToFill.solicita_inscripcion, solicita_pase_interno: dataToFill.solicita_pase_interno,
                        solicita_pase_regional: dataToFill.solicita_pase_regional, solicita_pase_externo: dataToFill.solicita_pase_externo,
                        categoria_extranjero: dataToFill.categoria_extranjero, categoria_libertad: dataToFill.categoria_libertad,
                        categoria_adulto: dataToFill.categoria_adulto, categoria_femenina: dataToFill.categoria_femenina,
                        categoria_infantil: dataToFill.categoria_infantil
                    };
                    Object.keys(fieldMap).forEach(key => {
                        try {
                            const field = form.getTextField(fieldMap[key]);
                            field.setText((dataForPdf[key] || '').toString());
                            field.setAlignment(PDFLib.TextAlignment.Center);
                        } catch (e) { console.warn(`Campo no encontrado/rellenado (Trámite) '${fieldMap[key]}': ${e.message}`); }
                    });
                } else { 
                    const fieldMapAuth = { nombreAutorizante: 'NOMBRE AUTORIZANTE', cedulaIdentidad: 'CEDULA IDENTIDAD', nombreJugador: 'NOMBRE JUGADOR', parentesco: 'PARENTESCO' };
                    const authDataMap = { 
                        nombreAutorizante: dataToFill.apoderado_nombre, 
                        cedulaIdentidad: dataToFill.apoderado_ci, 
                        nombreJugador: dataToFill.jugador_nombre, 
                        parentesco: dataToFill.parentesco 
                    };
                    Object.keys(fieldMapAuth).forEach(key => {
                        try {
                            const field = form.getTextField(fieldMapAuth[key]);
                            field.setText((authDataMap[key] || '').toString());
                            field.setAlignment(PDFLib.TextAlignment.Center);
                        } catch (e) { console.warn(`Campo no encontrado/rellenado (Autorización) '${fieldMapAuth[key]}': ${e.message}`); }
                    });
                }
                try { form.flatten(); } catch (e) { console.warn("Error al aplanar PDF:", e); }
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob); link.download = outputFilename;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) { alert(`Error al procesar PDF: ${error.message}.`); }
        }

        async function deleteTramite(tramiteId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Solo los administradores pueden eliminar trámites.');
                return;
            }
            const { data: tramiteData, error: fetchError } = await supabaseClient
                .from('players')
                .select('nombres, ci')
                .eq('id', tramiteId)
                .single();
            
            let itemName = `el trámite ID ${tramiteId.substring(0,8)}...`;
            if (tramiteData) {
                itemName = `el trámite de ${tramiteData.nombres || tramiteData.ci}`;
            } else if (fetchError && fetchError.code !== 'PGRST116') {
                console.error('Error al buscar trámite para eliminar:', fetchError);
            }
            showDeleteConfirmModal(tramiteId, 'tramite', itemName);
        }
        
        async function deleteAutorizacion(autorizacionId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Solo los administradores pueden eliminar autorizaciones.');
                return;
            }
            const { data: authData, error: fetchError } = await supabaseClient
                .from('autorizaciones')
                .select('jugador_nombre')
                .eq('id', autorizacionId)
                .single();

            let itemName = `la autorización ID ${autorizacionId.substring(0,8)}...`;
            if (authData && authData.jugador_nombre) {
                itemName = `la autorización para ${authData.jugador_nombre}`;
            } else if (fetchError && fetchError.code !== 'PGRST116') {
                 console.error('Error al buscar autorización para eliminar:', fetchError);
            }
            showDeleteConfirmModal(autorizacionId, 'autorizacion', itemName);
        }

        async function deleteUser(cedula) { 
            console.log('[deleteUser] Iniciando para Cédula/Username:', cedula);
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!currentUser) {
                console.error('[deleteUser] Error: No hay usuario actual.');
                alert('Debes iniciar sesión.');
                return;
            }
             if (currentUser.username === cedula) { 
                alert('No puedes eliminar tu propia cuenta.');
                console.warn('[deleteUser] Intento de autoeliminación por Cédula:', currentUser.username);
                return;
            }
            if (currentUser.role !== 'admin') {
                alert('Acceso no autorizado.');
                console.warn('[deleteUser] Intento de eliminación por no-admin:', currentUser.username);
                return;
            }
            
            const { data: userToDeleteData, error: fetchErr } = await supabaseClient
                .from('users')
                .select('nombre_completo') 
                .eq('username', cedula) 
                .single();

            let itemName;
            if (userToDeleteData && userToDeleteData.nombre_completo) {
                itemName = userToDeleteData.nombre_completo; 
            } else {
                itemName = `al usuario con cédula ${cedula}`; 
            }
            
            if (fetchErr && fetchErr.code !== 'PGRST116') { 
                 console.error('[deleteUser] Error al buscar información del usuario a eliminar:', fetchErr);
            }
            
            showDeleteConfirmModal(cedula, 'user', itemName); 
        }

        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('sidebar-collapsed');
        }

        // --- INICIO: Lógica para Cédula Identidad (sin cambios) ---
        let ci_perspectiveImage = new Image();
        let ci_perspectivePoints = [];
        let ci_perspectiveOriginalCanvas, ci_perspectiveTransformedCanvas;
        let ci_perspectiveCtxOriginal, ci_perspectiveCtxTransformed;
        let ci_savedFoto1DataUrl = null, ci_savedFoto2DataUrl = null;
        let ci_currentSelectedFoto = 'foto1';
        const CI_FINAL_WIDTH = 340;
        const CI_FINAL_HEIGHT = 227;

        function renderCedulaIdentidadForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Corrector de Perspectiva para Cédulas';
            contentArea.innerHTML = `
                <div id="cedula-identidad-section" class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <span class="text-sm font-medium text-primary">Subir:</span>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="fotoCedulaSelect" value="foto1" class="form-radio h-4 w-4 text-blue-600" checked>
                                <span class="ml-2 text-sm text-primary">Foto 1 (Anverso)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="fotoCedulaSelect" value="foto2" class="form-radio h-4 w-4 text-blue-600">
                                <span class="ml-2 text-sm text-primary">Foto 2 (Reverso)</span>
                            </label>
                        </div>
                        <div class="button-group">
                            <input type="file" id="ciPerspectiveImageInput" class="hidden" accept="image/*">
                            <label for="ciPerspectiveImageInput" class="file-input-label-cedula"><i class="fas fa-upload mr-2"></i>Seleccionar Archivo</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-lg font-medium text-primary mb-2">Foto Original (Marcar 4 esquinas)</h3>
                            <div class="perspective-canvas-wrapper" id="ciOriginalCanvasContainer">
                                <canvas id="ciPerspectiveOriginalCanvas"></canvas>
                                <div id="ciCanvasPlaceholderCedula" class="text-sm">Sube una imagen para comenzar</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-primary mb-2">Foto Corregida</h3>
                            <div class="perspective-canvas-wrapper"><canvas id="ciPerspectiveTransformedCanvas"></canvas></div>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-2">
                        <button id="ci-perspective-save-btn" class="px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-save mr-2"></i>Guardar Imagen</button>
                        <button id="ci-perspective-reset-points-btn" class="px-4 py-2 rounded-md"><i class="fas fa-undo mr-2"></i>Reiniciar Puntos</button>
                    </div>
                    <div class="saved-images-container mt-8">
                        <h3 class="text-lg font-medium text-primary mb-4">Imágenes Guardadas para PDF</h3>
                        <div id="ciSavedImagesList" class="flex flex-wrap gap-4 items-start"></div>
                        <button id="ci-generate-cedula-pdf-btn" class="mt-4 px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-file-pdf mr-2"></i>Generar PDF</button>
                    </div>
                </div>`;
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js', initializeCedulaIdentidadLogic);
        }

        function initializeCedulaIdentidadLogic() {
            if (typeof numeric === 'undefined') { alert("Error: Falta librería de perspectiva."); return; }
            ci_perspectiveImage = new Image(); ci_perspectivePoints = []; ci_savedFoto1DataUrl = null; ci_savedFoto2DataUrl = null; ci_currentSelectedFoto = 'foto1';
            ci_perspectiveOriginalCanvas = document.getElementById('ciPerspectiveOriginalCanvas');
            ci_perspectiveTransformedCanvas = document.getElementById('ciPerspectiveTransformedCanvas');
            if (!ci_perspectiveOriginalCanvas || !ci_perspectiveTransformedCanvas) { console.error("Error: Canvas de cédula no encontrado."); return; }
            ci_perspectiveCtxOriginal = ci_perspectiveOriginalCanvas.getContext('2d');
            ci_perspectiveCtxTransformed = ci_perspectiveTransformedCanvas.getContext('2d');
            document.getElementById('ciPerspectiveImageInput')?.addEventListener('change', ci_handleImageUpload);
            ci_perspectiveOriginalCanvas.addEventListener('click', ci_handleCanvasClick);
            document.getElementById('ci-perspective-save-btn')?.addEventListener('click', ci_saveImage);
            document.getElementById('ci-generate-cedula-pdf-btn')?.addEventListener('click', ci_generatePDF);
            document.getElementById('ci-perspective-reset-points-btn')?.addEventListener('click', () => {
                ci_perspectivePoints = []; ci_drawPerspectivePointsAndLines();
                if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
                const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
            });
            document.querySelectorAll('input[name="fotoCedulaSelect"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    ci_currentSelectedFoto = e.target.value; ci_resetPerspectiveView(false);
                    if (ci_perspectiveImage.src) ci_drawImage();
                });
            });
            const initialRadio = document.querySelector('input[name="fotoCedulaSelect"]:checked');
            if (initialRadio) ci_currentSelectedFoto = initialRadio.value;
            ci_updatePDFButtonState(); ci_updateSavedImagesList();
        }

        function ci_handleImageUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            if (!file.type.match('image.*')) { alert('Archivo de imagen inválido.'); return; }
            if (file.size > 5 * 1024 * 1024) { alert('Tamaño máximo 5MB.'); e.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = (event) => {
                ci_perspectiveImage.onload = () => {
                    ci_updateCanvasDimensions(); ci_drawImage();
                    document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'none', 'important');
                    ci_perspectivePoints = [];
                    if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
                    const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
                };
                ci_perspectiveImage.onerror = () => document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important');
                ci_perspectiveImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function ci_updateCanvasDimensions() {
            const container = document.getElementById('ciOriginalCanvasContainer');
            if (!container || !ci_perspectiveImage.width || !ci_perspectiveImage.height) return;
            const ar = ci_perspectiveImage.width / ci_perspectiveImage.height;
            let nw = container.clientWidth, nh = nw / ar;
            if (nh > container.clientHeight) { nh = container.clientHeight; nw = nh * ar; }
            if (ci_perspectiveOriginalCanvas) { ci_perspectiveOriginalCanvas.width = nw; ci_perspectiveOriginalCanvas.height = nh; }
        }

        function ci_drawImage() {
            if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas || !ci_perspectiveImage.src) return;
            ci_perspectiveCtxOriginal.clearRect(0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
            ci_perspectiveCtxOriginal.drawImage(ci_perspectiveImage, 0, 0, ci_perspectiveImage.width, ci_perspectiveImage.height, 0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
        }

        function ci_handleCanvasClick(e) {
            if (ci_perspectivePoints.length >= 4 || !ci_perspectiveImage.src || !ci_perspectiveOriginalCanvas) return;
            const rect = ci_perspectiveOriginalCanvas.getBoundingClientRect();
            const sx = ci_perspectiveOriginalCanvas.width / rect.width, sy = ci_perspectiveOriginalCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * sx, y = (e.clientY - rect.top) * sy;
            ci_perspectivePoints.push({ x, y });
            ci_drawPerspectivePointsAndLines();
            if (ci_perspectivePoints.length === 4) {
                ci_applyPerspectiveTransform();
                const saveButton = document.getElementById('ci-perspective-save-btn'); if (saveButton) saveButton.disabled = false;
            }
        }

        function ci_drawPerspectivePointsAndLines() {
            if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas) return;
            ci_drawImage();
            ci_perspectiveCtxOriginal.strokeStyle = 'rgba(255,0,0,0.9)'; ci_perspectiveCtxOriginal.lineWidth = 2; ci_perspectiveCtxOriginal.fillStyle = 'rgba(255,0,0,0.7)';
            ci_perspectivePoints.forEach((p, i) => {
                ci_perspectiveCtxOriginal.beginPath(); ci_perspectiveCtxOriginal.arc(p.x, p.y, 6, 0, Math.PI*2); ci_perspectiveCtxOriginal.fill(); ci_perspectiveCtxOriginal.stroke();
                if (i > 0) { ci_perspectiveCtxOriginal.beginPath(); ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[i-1].x, ci_perspectivePoints[i-1].y); ci_perspectiveCtxOriginal.lineTo(p.x, p.y); ci_perspectiveCtxOriginal.stroke(); }
            });
            if (ci_perspectivePoints.length === 4) { ci_perspectiveCtxOriginal.beginPath(); ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[3].x, ci_perspectivePoints[3].y); ci_perspectiveCtxOriginal.lineTo(ci_perspectivePoints[0].x, ci_perspectivePoints[0].y); ci_perspectiveCtxOriginal.stroke(); }
        }

        async function ci_applyPerspectiveTransform() {
            if (ci_perspectivePoints.length<4 || !ci_perspectiveImage.src || !numeric) return;
            const ordered = ci_orderPoints(ci_perspectivePoints);
            if (!ordered || ordered.some(p=>p===undefined)) { alert("Error ordenando puntos."); ci_perspectivePoints=[]; ci_drawPerspectivePointsAndLines(); return; }
            const srcPts = ordered.map(p => ({ x: (p.x / ci_perspectiveOriginalCanvas.width) * ci_perspectiveImage.width, y: (p.y / ci_perspectiveOriginalCanvas.height) * ci_perspectiveImage.height }));
            const dstPts = [{x:0,y:0},{x:CI_FINAL_WIDTH,y:0},{x:CI_FINAL_WIDTH,y:CI_FINAL_HEIGHT},{x:0,y:CI_FINAL_HEIGHT}];
            try {
                const matrix = ci_computePerspectiveMatrix(srcPts, dstPts); if (!matrix) { alert("Error calculando transformación."); return; }
                const tempC = document.createElement('canvas'); tempC.width = ci_perspectiveImage.width; tempC.height = ci_perspectiveImage.height;
                const tempCtx = tempC.getContext('2d'); tempCtx.drawImage(ci_perspectiveImage, 0, 0);
                ci_perspectiveTransformedCanvas.width = CI_FINAL_WIDTH; ci_perspectiveTransformedCanvas.height = CI_FINAL_HEIGHT;
                ci_perspectiveCtxTransformed.clearRect(0,0,CI_FINAL_WIDTH,CI_FINAL_HEIGHT);
                const imgData = ci_perspectiveCtxTransformed.getImageData(0,0,CI_FINAL_WIDTH,CI_FINAL_HEIGHT); const pixels = imgData.data;
                const invM = numeric.inv(matrix);
                for (let y=0; y<CI_FINAL_HEIGHT; y++) {
                    for (let x=0; x<CI_FINAL_WIDTH; x++) {
                        const pD = [x,y,1], pSHom = numeric.dot(invM, pD);
                        const sX = pSHom[0]/pSHom[2], sY = pSHom[1]/pSHom[2];
                        if (sX>=0 && sX<ci_perspectiveImage.width && sY>=0 && sY<ci_perspectiveImage.height) {
                            const i = (Math.floor(sY)*ci_perspectiveImage.width + Math.floor(sX))*4;
                            const j = (y*CI_FINAL_WIDTH + x)*4;
                            const sPixData = tempCtx.getImageData(Math.floor(sX), Math.floor(sY), 1, 1).data;
                            pixels[j]=sPixData[0]; pixels[j+1]=sPixData[1]; pixels[j+2]=sPixData[2]; pixels[j+3]=255;
                        }
                    }
                }
                ci_perspectiveCtxTransformed.putImageData(imgData,0,0);
            } catch(err) { alert("Error transformando imagen."); }
        }

        function ci_computePerspectiveMatrix(src, dst) {
            const A=[], B=[];
            for(let i=0; i<4; i++) {
                const x=src[i].x, y=src[i].y, u=dst[i].x, v=dst[i].y;
                A.push([x,y,1,0,0,0,-u*x,-u*y]); A.push([0,0,0,x,y,1,-v*x,-v*y]);
                B.push(u); B.push(v);
            }
            try { const X = numeric.solve(A,B); return [[X[0],X[1],X[2]],[X[3],X[4],X[5]],[X[6],X[7],1]]; }
            catch(e) { return null; }
        }

        function ci_orderPoints(points) {
            points.sort((a,b) => (a.x+a.y) - (b.x+b.y));
            let [tl, p2, p3, br] = points;
            let others = [p2,p3].sort((a,b) => (a.y-a.x) - (b.y-b.x));
            let tr = others[0], bl = others[1];
            if ([tl,tr,br,bl].some(p=>p===undefined)) { // Fallback if simple sort fails
                const center = points.reduce((acc,p)=>({x:acc.x+p.x/4, y:acc.y+p.y/4}),{x:0,y:0});
                return points.sort((a,b)=>Math.atan2(a.y-center.y,a.x-center.x) - Math.atan2(b.y-center.y,b.x-center.x));
            }
            return [tl,tr,br,bl];
        }

        function ci_saveImage() {
            if (!ci_perspectiveTransformedCanvas || ci_perspectiveTransformedCanvas.width===0) { alert("No hay imagen corregida."); return; }
            const dataUrl = ci_perspectiveTransformedCanvas.toDataURL('image/png');
            if (ci_currentSelectedFoto === 'foto1') ci_savedFoto1DataUrl = dataUrl; else ci_savedFoto2DataUrl = dataUrl;
            ci_updateSavedImagesList(); ci_updatePDFButtonState();
            const imgInput = document.getElementById('ciPerspectiveImageInput'); if(imgInput) imgInput.value = '';
            ci_resetPerspectiveView(true);
            if (ci_currentSelectedFoto === 'foto1' && !ci_savedFoto2DataUrl) { const r = document.querySelector('input[name="fotoCedulaSelect"][value="foto2"]'); if (r) r.checked = true; ci_currentSelectedFoto = 'foto2'; }
            else if (ci_currentSelectedFoto === 'foto2' && !ci_savedFoto1DataUrl) { const r = document.querySelector('input[name="fotoCedulaSelect"][value="foto1"]'); if (r) r.checked = true; ci_currentSelectedFoto = 'foto1'; }
            alert("Imagen guardada.");
        }

        function ci_updateSavedImagesList() {
            const container = document.getElementById('ciSavedImagesList'); if (!container) return; container.innerHTML = '';
            const phStyle = "width:120px;height:100px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border-input);border-radius:0.375rem;background-color:var(--bg-primary);";
            container.innerHTML += ci_savedFoto1DataUrl ? `<div class="saved-image-item"><img src="${ci_savedFoto1DataUrl}" class="saved-image-preview" alt="Anverso"><p class="text-sm text-primary mt-1">Anverso</p></div>` : `<div class="saved-image-item" style="${phStyle}"><span class="text-xs text-secondary">Anverso</span></div>`;
            container.innerHTML += ci_savedFoto2DataUrl ? `<div class="saved-image-item"><img src="${ci_savedFoto2DataUrl}" class="saved-image-preview" alt="Reverso"><p class="text-sm text-primary mt-1">Reverso</p></div>` : `<div class="saved-image-item" style="${phStyle}"><span class="text-xs text-secondary">Reverso</span></div>`;
        }

        async function ci_generatePDF() {
            if (!ci_savedFoto1DataUrl || !ci_savedFoto2DataUrl) { alert('Guarda ambas caras primero.'); return; }
            if (!PDFLib || !PDFLib.PDFDocument) { alert("Librería PDF no lista."); return; }
            const { PDFDocument } = PDFLib;
            try {
                const pdfDoc = await PDFDocument.create(); const page = pdfDoc.addPage([595, 842]);
                const margin=50, imgDispW=290;
                const anversoBytes = await fetch(ci_savedFoto1DataUrl).then(r=>r.arrayBuffer());
                const anversoImg = await pdfDoc.embedPng(anversoBytes);
                const anversoDims = anversoImg.scaleToFit(imgDispW, (imgDispW/CI_FINAL_WIDTH)*CI_FINAL_HEIGHT);
                page.drawImage(anversoImg, {x:margin,y:page.getHeight()-margin-anversoDims.height, width:anversoDims.width, height:anversoDims.height});
                page.drawText('Anverso Cédula', {x:margin,y:page.getHeight()-margin-anversoDims.height-15,size:10});
                const reversoBytes = await fetch(ci_savedFoto2DataUrl).then(r=>r.arrayBuffer());
                const reversoImg = await pdfDoc.embedPng(reversoBytes);
                const reversoDims = reversoImg.scaleToFit(imgDispW, (imgDispW/CI_FINAL_WIDTH)*CI_FINAL_HEIGHT);
                page.drawImage(reversoImg, {x:margin,y:page.getHeight()-margin-anversoDims.height-30-reversoDims.height, width:reversoDims.width, height:reversoDims.height});
                page.drawText('Reverso Cédula', {x:margin,y:page.getHeight()-margin-anversoDims.height-30-reversoDims.height-15,size:10});
                const pdfBytes = await pdfDoc.save(); const blob = new Blob([pdfBytes],{type:'application/pdf'});
                const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=`cedula_identidad_${Date.now()}.pdf`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            } catch(e) { alert("Error al generar PDF: "+e.message); }
        }

        function ci_updatePDFButtonState() {
            const btn = document.getElementById('ci-generate-cedula-pdf-btn'); if(btn) btn.disabled = !(ci_savedFoto1DataUrl && ci_savedFoto2DataUrl);
        }

        function ci_resetPerspectiveView(clearFull = true) {
            if (clearFull && ci_perspectiveImage) { ci_perspectiveImage.src = ''; document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important'); }
            if (ci_perspectiveOriginalCanvas && ci_perspectiveCtxOriginal && clearFull) ci_perspectiveCtxOriginal.clearRect(0,0,ci_perspectiveOriginalCanvas.width,ci_perspectiveOriginalCanvas.height);
            ci_perspectivePoints = [];
            if (ci_perspectiveTransformedCanvas && ci_perspectiveCtxTransformed) ci_perspectiveCtxTransformed.clearRect(0,0,ci_perspectiveTransformedCanvas.width,ci_perspectiveTransformedCanvas.height);
            const saveBtn = document.getElementById('ci-perspective-save-btn'); if(saveBtn) saveBtn.disabled = true;
            if (!clearFull && ci_perspectiveImage.src && ci_perspectiveCtxOriginal) ci_drawImage();
        }
        // --- FIN: Lógica para Cédula Identidad ---

        // --- Inicialización y Listeners Globales ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const usernameLoginInput = document.getElementById('username'); 
            const menuTramite = document.getElementById('menu-tramite');
            const menuAutorizacion = document.getElementById('menu-autorizacion');
            const menuUsuarios = document.getElementById('menu-usuarios');
            const menuLista = document.getElementById('menu-lista');
            const menuFotoCarnet = document.getElementById('menu-fotocarnet');
            const menuCedulaIdentidad = document.getElementById('menu-cedula-identidad');
            const collapseToggle = document.getElementById('collapse-toggle');
            const contentArea = document.getElementById('content-area');
            const logoutButton = document.getElementById('logout-button');
            const darkModeToggle = document.getElementById('dark-mode-toggle');

            // Modal de confirmación
            const confirmModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteButton = document.getElementById('confirm-delete-btn');
            const cancelDeleteButton = document.getElementById('cancel-delete-btn');

            if(confirmDeleteButton) confirmDeleteButton.addEventListener('click', proceedWithDeletion);
            if(cancelDeleteButton) cancelDeleteButton.addEventListener('click', hideDeleteConfirmModal);


            const htmlElement = document.documentElement;
            const darkModeIcon = darkModeToggle.querySelector('i');
            const applyDarkMode = (isDark) => {
                htmlElement.classList.toggle('dark', isDark);
                darkModeIcon.classList.toggle('fa-sun', isDark);
                darkModeIcon.classList.toggle('fa-moon', !isDark);
            };
            const preferredDarkMode = localStorage.getItem('darkMode');
            applyDarkMode(preferredDarkMode === 'enabled');
            darkModeToggle.addEventListener('click', () => {
                const isDark = htmlElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
                applyDarkMode(isDark);
            });

            if (loginForm) loginForm.addEventListener('submit', handleLoginSubmit);
            if (usernameLoginInput) usernameLoginInput.addEventListener('input', () => formatLoginUsername(usernameLoginInput));

            if (menuTramite) menuTramite.addEventListener('click', (e) => { e.preventDefault(); renderTramiteForm(); });
            if (menuAutorizacion) menuAutorizacion.addEventListener('click', (e) => { e.preventDefault(); renderAutorizacionForm(); });
            if (menuUsuarios) menuUsuarios.addEventListener('click', (e) => { e.preventDefault(); renderUserManagementForm(); });
            if (menuLista) menuLista.addEventListener('click', (e) => { e.preventDefault(); renderPlayerList(); });
            if (menuFotoCarnet) menuFotoCarnet.addEventListener('click', (e) => { e.preventDefault(); renderFotoCarnetForm(); });
            if (menuCedulaIdentidad) menuCedulaIdentidad.addEventListener('click', (e) => { e.preventDefault(); renderCedulaIdentidadForm(); });
            if (collapseToggle) collapseToggle.addEventListener('click', toggleSidebar);
            if (logoutButton) logoutButton.addEventListener('click', handleLogout);

            if (contentArea) {
                contentArea.addEventListener('click', async (event) => { 
                    const targetButton = event.target.closest('button.delete-btn, button.action-button[data-action="generate-pdf"], button.action-button[data-action="edit"]');
                    if (!targetButton) return;
                
                    const action = targetButton.dataset.action;
                    const type = targetButton.dataset.type;
                    const id = targetButton.dataset.id; 
                    const name = targetButton.dataset.name || `elemento ID ${id ? (typeof id === 'string' ? id.substring(0,8) + "..." : id) : "desconocido"}`; 
                                        
                    if (action === 'delete') {
                        if (type === 'user' && id) { 
                            deleteUser(id); 
                        } else if (type === 'tramite' && id) { 
                            deleteTramite(id); 
                        } else if (type === 'autorizacion' && id) { 
                            deleteAutorizacion(id); 
                        }
                    } else if (action === 'edit' && type === 'user' && id) { 
                        populateUserEditForm(id);
                    } else if (action === 'generate-pdf' && id) { 
                        generatePdf(type, id);
                    }
                });
            }
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try { 
                    const user = JSON.parse(storedUser); 
                    showAppScreen(); 
                }
                catch (e) { localStorage.removeItem('currentUser'); showLoginScreen(); }
            } else showLoginScreen();
        });
    </script>
</body>
</html>
