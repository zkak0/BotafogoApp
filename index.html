<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deportivo Botafogo - App Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" integrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <style>
        /* --- Estilos CSS Actualizados --- */
        :root {
            --bg-primary: #f3f4f6; /* Tailwind gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-sidebar: #e5e7eb; /* Tailwind gray-200 */
            --bg-sidebar-hover: #d1d5db; /* Tailwind gray-300 */
            --text-primary: #1f2937; /* Tailwind gray-800 */
            --text-secondary: #6b7280; /* Tailwind gray-500 */
            --text-sidebar: #374151; /* Tailwind gray-700 */
            --text-sidebar-title: #111827; /* Tailwind gray-900 */
            --text-sidebar-hover: #111827; /* Tailwind gray-900 */
            --border-color: #cbd5e1; /* Tailwind slate-300 - More visible general borders */
            --border-input: #94a3b8; /* Tailwind slate-400 - Clearly marked input borders */
            --border-input-focus: #2563eb; /* Tailwind blue-600 */
            --shadow-color: rgba(0, 0, 0, 0.15); /* Slightly more pronounced shadows */
            --link-color: #2563eb; /* Tailwind blue-600 */
            --link-hover-color: #1d4ed8; /* Tailwind blue-700 */
            --button-action-bg: #2563eb; /* Tailwind blue-600 */
            --button-action-hover-bg: #1d4ed8; /* Tailwind blue-700 */
            --sidebar-border-color: #cbd5e1; /* Tailwind slate-300 */
            --button-green-bg: #16a34a; /* Tailwind green-600 */
            --button-green-hover-bg: #15803d; /* Tailwind green-700 */
            --button-cancel-text: #4b5563; /* Tailwind gray-600 */
            --button-cancel-hover-bg: #f3f4f6; /* Tailwind gray-100 */
            --button-generic-bg: #e5e7eb; /* Tailwind gray-200 */
            --button-generic-hover-bg: #d1d5db; /* Tailwind gray-300 */
            --slider-track-bg: #d1d5db; /* Tailwind gray-300 */
        }
        html.dark {
            --bg-primary: #0f172a; /* Tailwind slate-900 - Very dark blue-gray */
            --bg-secondary: #1e293b; /* Tailwind slate-800 - Cards, modals */
            --bg-sidebar: #1e293b; /* Tailwind slate-800 */
            --bg-sidebar-hover: #334155; /* Tailwind slate-700 */
            --text-primary: #f1f5f9; /* Tailwind slate-100 - Light text */
            --text-secondary: #94a3b8; /* Tailwind slate-400 - Softer secondary text */
            --text-sidebar: #cbd5e1; /* Tailwind slate-300 */
            --text-sidebar-title: #f1f5f9; /* Tailwind slate-100 */
            --text-sidebar-hover: #ffffff; /* white */
            --border-color: #334155; /* Tailwind slate-700 - Visible borders */
            --border-input: #475569; /* Tailwind slate-600 - Clearer input borders */
            --border-input-focus: #60a5fa; /* Tailwind blue-400 */
            --shadow-color: rgba(0, 0, 0, 0.3); /* Darker, defined shadows */
            --link-color: #93c5fd; /* Tailwind blue-300 - Brighter blue links */
            --link-hover-color: #60a5fa; /* Tailwind blue-400 */
            --button-action-bg: #2563eb; /* Tailwind blue-600 - Vibrant */
            --button-action-hover-bg: #1d4ed8; /* Tailwind blue-700 */
            --sidebar-border-color: #334155; /* Tailwind slate-700 */
            --button-green-bg: #22c55e; /* Tailwind green-500 */
            --button-green-hover-bg: #16a34a; /* Tailwind green-600 */
            --button-cancel-text: #cbd5e1; /* Tailwind slate-300 */
            --button-cancel-hover-bg: #334155; /* Tailwind slate-700 */
            --button-generic-bg: #334155; /* Tailwind slate-700 */
            --button-generic-hover-bg: #475569; /* Tailwind slate-600 */
            --slider-track-bg: #475569; /* Tailwind slate-600 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        #login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-primary); }
        .login-box { background-color: var(--bg-secondary); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); padding: 2.5rem; border-radius: 0.5rem; width: 100%; max-width: 28rem; text-align: center;}
        .login-logo { max-width: 150px; height: auto; margin-bottom: 1.5rem; margin-left: auto; margin-right: auto; }
        .login-input { border: 1px solid var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); appearance: none; display: block; width: 100%; padding: 0.75rem; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); margin-bottom: 1rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;}
        .login-input::placeholder { color: var(--text-secondary); }
        .login-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 3px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); }
        html.dark .login-input:focus { box-shadow: 0 0 0 3px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        .login-button { display: inline-flex; justify-content: center; width: 100%; padding: 0.75rem 1rem; border: 1px solid transparent; background-color: var(--button-action-bg); color: white; font-weight: 600; font-size: 0.875rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; transition: background-color 0.15s ease-in-out; }
        .login-button:hover { background-color: var(--button-action-hover-bg); }
        .login-error { color: #dc2626; min-height: 1.25rem; }
        #app-screen { display: none; }
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-sidebar); transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar-title { color: var(--text-sidebar-title); font-weight: 700; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav ul li a { padding: 10px 16px; display: flex; align-items: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-sidebar); border-radius: 0.375rem; }
        .sidebar-nav ul li a i { margin-right: 10px; font-size: 1.25rem; width: 20px; text-align: center; }
        .sidebar-nav ul li a:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        .sidebar .border-t { border-color: var(--sidebar-border-color); }
        .collapse-button { color: var(--text-sidebar); }
        .collapse-button:hover { color: var(--text-sidebar-hover); }
        #logout-button { color: var(--text-sidebar); padding-top: 0.75rem; padding-bottom: 0.75rem; }
        #logout-button:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        aside.sidebar-collapsed { width: 80px !important; padding-left: 10px; padding-right: 10px; }
        .sidebar-collapsed .menu-item-text span { display: none; }
        .sidebar-collapsed .sidebar-nav ul li a { justify-content: center; padding: 10px 0; }
        .sidebar-collapsed .sidebar-nav ul li a i { margin-right: 0; }
        .sidebar-collapsed .sidebar-title { display: none; }
        .sidebar-collapsed #logout-button span { display: none; }
        .sidebar-collapsed #logout-button i { margin-right: 0; }
        .flex-container { display: flex; }
        .flex-main { flex-grow: 1; position: relative; background-color: var(--bg-primary); }
        #main-title { color: var(--text-primary); }
        #content-area p { color: var(--text-secondary); }
        #content-area .bg-white { background-color: var(--bg-secondary); }
        #content-area h2 { color: var(--text-primary); }
        #content-area label, #content-area span { color: var(--text-primary); }
        #content-area .text-gray-500 { color: var(--text-secondary); }
        #content-area .bg-gray-50 { background-color: var(--bg-primary); border-color: var(--border-color); }
        #content-area table { border-color: var(--border-color); }
        #content-area thead { background-color: var(--bg-secondary); }
        html.dark #content-area thead { background-color: var(--bg-primary); }
        #content-area th { border-color: var(--border-color); font-weight: 600; }
        #content-area tbody { background-color: var(--bg-secondary); }
        #content-area tbody tr { border-bottom: 1px solid var(--border-color); }
        #content-area tbody tr:last-child { border-bottom: none; }
        #content-area td { color: var(--text-primary); border-color: var(--border-color); }
        #content-area tr:hover { background-color: var(--bg-primary); }
        html.dark #content-area tr:hover { background-color: #334155; }
        ::placeholder { color: var(--text-secondary); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-secondary); }
        ::-ms-input-placeholder { color: var(--text-secondary); }
        .action-button { cursor: pointer; transition: color 0.15s ease-in-out; background: none; border: none; padding: 0.25rem 0.5rem;}
        .hidden-file-input { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-label { cursor: pointer; display: inline-flex; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .file-input-label:hover { background-color: var(--bg-primary); }
        .file-input-label i { margin-right: 0.5rem; }
        .form-input-base { display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); color: var(--text-primary); background-color: var(--bg-secondary); font-size: 0.875rem; }
        .form-input-base::placeholder { color: var(--text-secondary); }
        .form-input-base:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); }
        html.dark .form-input-base:focus { box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; appearance: none; }
        html.dark .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        .edit-user-button { background-color: #fbbf24; color: #78350f; }
        .edit-user-button:hover { background-color: #f59e0b; }
        html.dark .edit-user-button { background-color: #fcd34d; color: #78350f; }
        html.dark .edit-user-button:hover { background-color: #fbbf24; }
        #add-user-error, #foto-carnet-message, #cedula-message { min-height: 1.25rem; margin-top: 0.5rem;}
        .action-button[data-action="generate-pdf"] { color: var(--link-color); }
        .action-button[data-action="generate-pdf"]:hover { color: var(--link-hover-color); }
        .action-button[data-action="edit"] { color: #ca8a04; }
        .action-button[data-action="edit"]:hover { color: #a16207; }
        html.dark .action-button[data-action="edit"] { color: #fcd34d; }
        html.dark .action-button[data-action="edit"]:hover { color: #fbbf24; }
        .action-button[data-action="delete"], .delete-btn { color: #dc2626; }
        .action-button[data-action="delete"]:hover, .delete-btn:hover { color: #b91c1c; }
        html.dark .action-button[data-action="delete"], html.dark .delete-btn { color: #f87171; }
        html.dark .action-button[data-action="delete"]:hover, html.dark .delete-btn:hover { color: #ef4444; }
        #form-tramite button[type=submit], #form-autorizacion button[type=submit], #form-poder-simple button[type=submit], #form-add-user #user-submit-button[class*="bg-green"], #preview-foto-carnet-button, #save-foto-carnet-button { background-color: var(--button-action-bg); color: white; }
        #form-tramite button[type=submit]:hover, #form-autorizacion button[type=submit]:hover, #form-poder-simple button[type=submit]:hover, #form-add-user #user-submit-button[class*="bg-green"]:hover, #preview-foto-carnet-button:hover, #save-foto-carnet-button:hover { background-color: var(--button-action-hover-bg); }
        #form-add-user #user-submit-button { background-color: var(--button-green-bg); color: white; }
        #form-add-user #user-submit-button:hover { background-color: var(--button-green-hover-bg); }
        #form-add-user #user-cancel-button { border: 1px solid var(--border-input); background-color: var(--bg-secondary); color: var(--text-secondary); }
        #form-add-user #user-cancel-button:hover { background-color: var(--bg-primary); }
        .cropper-container-wrapper { max-width: 500px; height: 400px; margin-top: 0.5rem; border: 1px dashed var(--border-color); background-color: var(--bg-primary); }
        #cropper-image { display: block; max-width: 100%; max-height: 100%; }
        .result-canvas-container { margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-input); background-color: var(--bg-primary); border-radius: 0.375rem; text-align: center; min-height: 150px; }
        #result-canvas { border: 1px solid var(--border-color); max-width: 100%; height: auto; display: none; margin: 0 auto; }
        .button-group button, .button-group .file-input-label { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .button-group button:last-child, .button-group .file-input-label:last-child { margin-right: 0; }
        .form-section { margin-top: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .single-char-input { width: 2.25rem; height: 2.25rem; text-align: center; padding: 0.25rem; margin-left: 0.25rem; margin-right: 0.5rem; border-width: 1px; border-radius: 0.375rem; border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); text-transform: uppercase; font-size: 0.875rem; }
        .single-char-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); }
        html.dark .single-char-input:focus { box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        .perspective-canvas-wrapper { width: 100%; max-width: 500px; height: 350px; margin: 1rem auto; border: 1px solid var(--border-input); background-color: var(--bg-secondary); border-radius: 0.375rem; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .perspective-canvas-wrapper canvas { max-width: 100%; max-height: 100%; cursor: crosshair; }
        #cedula-identidad-section .button-group button,
        #cedula-identidad-section .file-input-label-cedula { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); padding: 0.5rem 1rem; border-radius: 0.375rem; margin: 0.25rem; transition: all 0.2s ease; cursor: pointer; display: inline-flex; align-items: center; }
        #cedula-identidad-section .button-group button:hover,
        #cedula-identidad-section .file-input-label-cedula:hover { background-color: var(--button-generic-hover-bg); }
        #cedula-identidad-section #ci-perspective-save-btn,
        #cedula-identidad-section #ci-generate-cedula-pdf-btn { background-color: var(--button-action-bg) !important; color: white !important; }
        #cedula-identidad-section #ci-generate-cedula-pdf-btn[disabled] { background-color: var(--button-generic-bg) !important; color: var(--text-secondary) !important; opacity: 0.5; }
        #cedula-identidad-section #ciCanvasPlaceholderCedula { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); background-color: var(--bg-secondary); }
        .saved-images-container { margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--border-color); }
        .saved-image-item { display: inline-block; margin: 0.5rem; text-align: center; }
        .saved-image-preview { width: 120px; height: auto; max-height: 80px; object-fit: contain; border: 1px solid var(--border-input); margin-bottom: 0.5rem; background-color: var(--bg-primary); }
        .list-thumbnail { max-width: 80px; max-height: 60px; height: auto; object-fit: cover; border-radius: 0.25rem; border: 1px solid var(--border-color); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--bg-secondary); color: var(--text-primary); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 90%; width: 400px; }
        .modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .modal-content p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal-buttons button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #confirm-delete-btn { background-color: #dc2626; color: white; margin-right: 0.5rem; }
        #confirm-delete-btn:hover { background-color: #b91c1c; }
        #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); }
        #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }
        html.dark #confirm-delete-btn { background-color: #f87171; }
        html.dark #confirm-delete-btn:hover { background-color: #ef4444; }
        html.dark #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border-color: var(--border-input); }
        html.dark #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }

        .adjustment-control { display: flex; flex-direction: column; gap: 0.25rem; padding: 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; background-color: var(--bg-secondary); }
        .slider { width: 100%; height: 0.5rem; border-radius: 0.5rem; -webkit-appearance: none; appearance: none; cursor: pointer; background-color: var(--slider-track-bg); }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 9999px; background-color: var(--button-action-bg); cursor: pointer; border: 2px solid var(--bg-secondary); box-shadow: 0 0 2px rgba(0,0,0,0.3); }
        .slider::-moz-range-thumb { width: 1rem; height: 1rem; border-radius: 9999px; background-color: var(--button-action-bg); cursor: pointer; border: 2px solid var(--bg-secondary); box-shadow: 0 0 2px rgba(0,0,0,0.3); }
        
        #sidebar-logo {
            max-width: 100px;
            height: auto;
            transition: max-width 0.3s ease-in-out;
        }

        .sidebar-collapsed #sidebar-logo {
            max-width: 36px;
        }

        .top-right-controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            display: flex;
            gap: 0.5rem;
        }

        #dark-mode-toggle, #top-logout-button {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #dark-mode-toggle:hover, #top-logout-button:hover {
            background-color: var(--bg-primary);
        }
        #dark-mode-toggle i {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        #top-logout-button i {
            font-size: 1.1rem;
            color: #ef4444; /* Rojo de Tailwind (red-500) */
        }
        #top-logout-button:hover i {
            color: #dc2626; /* Rojo m√°s oscuro al pasar el mouse */
        }
        /* Color para el bot√≥n de descarga de Foto Carnet */
        .action-button[data-action="download-image"] {
            color: #16a34a; /* Verde (Tailwind green-600) */
        }
        .action-button[data-action="download-image"]:hover {
            color: #15803d; /* Verde m√°s oscuro al pasar el mouse */
        }

        /* Y su versi√≥n para el modo oscuro */
        html.dark .action-button[data-action="download-image"] {
            color: #22c55e; /* Verde m√°s brillante (green-500) */
        }
        html.dark .action-button[data-action="download-image"]:hover {
            color: #16a34a; /* Verde (green-600) */
        }
        
        /* ====================================================== */
        /* INICIO: C√ìDIGO A√ëADIDO PARA VISTAS M√ìVIL Y ESCRITORIO   */
        /* ====================================================== */
        
        /* Por defecto (vista m√≥vil), ocultamos la versi√≥n de escritorio. */
        .desktop-only {
            display: none;
        }
        /* Y mostramos la versi√≥n m√≥vil. */
        .mobile-only {
            display: block;
        }

        /* Cuando la pantalla sea de 768px o m√°s (tablets/escritorio)... */
        @media (min-width: 768px) {
            /* ...hacemos lo contrario: mostramos la de escritorio... */
            .desktop-only {
                display: block;
            }
            /* ...y ocultamos la m√≥vil. */
            .mobile-only {
                display: none;
            }
        }
        
        /* ====================================================== */
        /* FIN: C√ìDIGO A√ëADIDO                                    */
        /* ====================================================== */
    </style>
</head>
<body class="bg-primary">
    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.ibb.co/rKqWkJxt/Sin-t-tulo-1.png" alt="[Imagen del] Logo Botafogo" class="login-logo" onerror="this.src='https://placehold.co/200x100/cccccc/333333?text=LOGO'; this.onerror=null;">
            <h2 class="text-2xl font-bold text-primary mb-6">Bienvenido a BotafogoApp</h2>
            <form id="login-form">
                <div>
                    <label for="username" class="sr-only">Usuario</label>
                    <input type="text" id="username" name="username" class="login-input" placeholder="Usuario (RUT)" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Clave</label>
                    <input type="password" id="password" name="password" class="login-input" placeholder="Clave" required>
                </div>
                <div id="login-error-message" class="login-error mt-2 text-sm"></div>
                <button type="submit" class="login-button mt-4">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="min-h-screen flex-container">
        <aside class="w-64 bg-sidebar text-sidebar p-6 space-y-6 rounded-r-lg flex flex-col justify-between sidebar h-screen sticky top-0" id="sidebar">
            <div>

                <div class="flex justify-center mb-2">
            <img src="https://i.ibb.co/rKqWkJxt/Sin-t-tulo-1.png" alt="Logo Club" id="sidebar-logo">
        </div>

        <div class="text-2xl font-bold mb-8 sidebar-title text-sidebar-title text-center">
            BotafogoApp
        </div>
        <!-- === INICIO: L√çNEA DIVISORIA SUAVE === -->
        <div class="my-4 border-t border-gray-800 dark:border-gray-600"></div>
        <!-- === FIN: L√çNEA DIVISORIA SUAVE === -->
                <nav class="sidebar-nav">
                    <ul class="space-y-2">
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-tramite"><i class="fas fa-file-contract text-lg"></i> <span>Tr√°mite Individual</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-autorizacion"><i class="fas fa-file-signature text-lg"></i> <span>Autorizaci√≥n</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-fotocarnet"><i class="fas fa-id-badge text-lg"></i> <span>Foto Carnet</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-cedula-identidad"><i class="fas fa-id-card text-lg"></i> <span>C√©dula de Identidad</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-poder-simple"><i class="fas fa-file-signature text-lg"></i> <span>Poder Simple</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-lista"><i class="fas fa-list-alt text-lg"></i> <span>Tramites Guardados</span></a></li>
                        <li id="li-menu-usuarios"><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-usuarios"><i class="fas fa-users-cog text-lg"></i> <span>Gesti√≥n Usuarios</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="border-t border-t-sidebar-border pt-4 mt-4 flex flex-col items-center">
                <button class="text-sidebar hover:text-sidebar-hover focus:outline-none collapse-button mb-4" id="collapse-toggle" title="Colapsar/Expandir Men√∫">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-8 flex-main bg-primary overflow-y-auto">
            <div class="top-right-controls">
                <button id="dark-mode-toggle" title="Cambiar modo claro/oscuro">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="top-logout-button" title="Cerrar Sesi√≥n">
                    <i class="fas fa-right-from-bracket"></i>
                </button>
            </div>
            <h1 class="text-3xl font-bold mb-6 text-primary" id="main-title">Bienvenido</h1>
            <div id="content-area" class="text-secondary">
                <p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>
            </div>
        </main>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmar Eliminaci√≥n</h3>
            <p id="delete-modal-message">¬øEst√°s seguro de que deseas eliminar este elemento?</p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn">Confirmar Eliminaci√≥n</button>
                <button id="cancel-delete-btn">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script id="list-row-template" type="text/x-handlebars-template">
    {{#each items}}
    <tr class="hover:bg-primary dark:hover:bg-gray-700">
        {{#if (eq ../type "tramite")}}
            <td class="px-4 py-4 text-center border-b border-r border-border-input"><button class="action-button" data-action="generate-pdf" data-type="tramite" data-id="{{this.id}}" title="Generar PDF Tr√°mite"><i class="fas fa-file-pdf fa-lg"></i></button></td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.createdAtFormatted}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.ci}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.apellido_paterno}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.apellido_materno}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.nombres}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.fecha_nac}}</td>
        {{/if}}

        {{#if (eq ../type "autorizacion")}}
            <td class="px-4 py-4 text-center border-b border-r border-border-input"><button class="action-button" data-action="generate-pdf" data-type="autorizacion" data-id="{{this.id}}" title="Generar PDF Autorizaci√≥n"><i class="fas fa-file-pdf fa-lg"></i></button></td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.createdAtFormatted}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.apoderado_nombre}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.apoderado_ci}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.jugador_nombre}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.parentesco}}</td>
        {{/if}}

        {{#if (eq ../type "fotocarnet")}}
            <td class="px-4 py-4 text-center border-b border-r border-border-input">
                <button class="action-button" data-action="download-image" onclick="downloadDataUrlAsImage('{{this.imagen_dataurl}}', 'fotocarnet_{{this.nombre_completo_jugador}}_{{this.created_at}}.png')" title="Descargar Foto Carnet">
                    <i class="fas fa-download fa-lg"></i>
                </button>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.createdAtFormatted}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.nombre_completo_jugador}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.rut_jugador}}</td>
        {{/if}}

        {{#if (eq ../type "cedula")}}
            <td class="px-4 py-4 text-center border-b border-r border-border-input">
                <button class="action-button" data-action="generate-pdf" onclick="downloadDataUrlAsPdf('{{this.pdf_dataurl}}', 'cedula_{{this.nombre_jugador}}_{{this.created_at}}.pdf')" title="Descargar PDF C√©dula">
                    <i class="fas fa-file-pdf fa-lg"></i> </button>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.createdAtFormatted}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.nombre_jugador}}</td>
        {{/if}}

        {{#if (eq ../type "poder_simple")}}
            <td class="px-4 py-4 text-center border-b border-r border-border-input"><button class="action-button" data-action="generate-pdf" data-type="poder_simple" data-id="{{this.id}}" title="Generar PDF Poder Simple"><i class="fas fa-file-pdf fa-lg"></i></button></td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.createdAtFormatted}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.nombre_autorizante}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.ci_autorizante}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.nombre_hijo}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.ci_hijo}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-b border-r border-border-input">{{this.fecha}}</td>
        {{/if}}

        {{#if ../isAdmin}}
        <td class="px-4 py-4 text-center border-b border-border-input">
            <button class="action-button delete-btn" data-action="delete" data-id="{{this.id}}" data-type="{{../type}}" data-name="{{#if this.nombres}}{{this.nombres}}{{else if this.jugador_nombre}}{{this.jugador_nombre}}{{else if this.nombre_completo_jugador}}{{this.nombre_completo_jugador}}{{else}}Elemento{{/if}}" title="Eliminar"><i class="fas fa-trash fa-lg"></i>
            </button>
        </td>
        {{/if}}
    </tr>
    {{/each}}
</script>
    <script id="user-management-row-template" type="text/x-handlebars-template">
      {{#each users}}
        <tr class="hover:bg-primary dark:hover:bg-gray-700">
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">{{this.nombre_completo}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">{{this.username}}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">{{this.role}}</td>
            <td class="px-4 py-4 text-center border-r border-border-color">
                <button class="action-button" data-action="edit" data-type="user" data-id="{{this.id}}" title="Editar Usuario">
                    <i class="fas fa-edit fa-lg"></i>
                </button>
            </td>
            <td class="px-4 py-4 text-center">
                <button class="action-button delete-btn" data-action="delete" data-type="user" data-id="{{this.username}}" data-name="{{this.nombre_completo}}" title="Eliminar Usuario">
                    <i class="fas fa-user-times fa-lg"></i>
                </button>
            </td>
        </tr>
      {{/each}}
    </script>
    
    <script id="tramite-form-template-desktop" type="text/x-handlebars-template">
      <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
        <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Jugador</h2>
        <form id="form-tramite">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                    <input type="text" id="ci" class="form-input-base" placeholder="Ej: 12345678-K" required>
                </div>
                <div>
                    <label for="fecha-nac" class="block text-sm font-medium text-secondary mb-1">Fecha Nacimiento:</label>
                    <input type="text" id="fecha-nac" class="form-input-base" placeholder="dd-mm-aaaa" required maxlength="10">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="apellido-paterno" class="block text-sm font-medium text-secondary mb-1">Apellido Paterno:</label>
                    <input type="text" id="apellido-paterno" class="form-input-base" required>
                </div>
                <div>
                    <label for="apellido-materno" class="block text-sm font-medium text-secondary mb-1">Apellido Materno:</label>
                    <input type="text" id="apellido-materno" class="form-input-base" required>
                </div>
            </div>
            <div class="mb-6">
                <label for="nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                <input type="text" id="nombres" class="form-input-base" required>
            </div>
            <div class="mb-6">
                <span class="block text-sm font-medium text-secondary mb-2">Solicita (Marcar con 'X' una sola opci√≥n):</span>
                <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-3 items-center">
                    <div class="flex items-center"> <input type="text" id="solicita_inscripcion_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Inscripci√≥n</span> </div>
                    <div class="flex items-center"> <input type="text" id="solicita_pase_interno_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Interno</span> </div>
                    <div class="flex items-center"> <input type="text" id="solicita_pase_regional_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Regional</span> </div>
                    <div class="flex items-center"> <input type="text" id="solicita_pase_externo_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Externo</span> </div>
                </div>
            </div>
            <div class="mb-6">
                <span class="block text-sm font-medium text-secondary mb-2">Categor√≠a (Marcar con 'X' una sola opci√≥n):</span>
                <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-x-4 gap-y-3 items-center">
                    <div class="flex items-center"> <input type="text" id="categoria_extranjero_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Extranjero</span> </div>
                    <div class="flex items-center"> <input type="text" id="categoria_libertad_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Libertad Acci√≥n</span> </div>
                    <div class="flex items-center"> <input type="text" id="categoria_adulto_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Adulto</span> </div>
                    <div class="flex items-center"> <input type="text" id="categoria_femenina_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Femenina</span> </div>
                    <div class="flex items-center"> <input type="text" id="categoria_infantil_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Infantil</span> </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="procede-club" class="block text-sm font-medium text-secondary mb-1">Procede del Club:</label>
                    <input type="text" id="procede-club" class="form-input-base">
                </div>
                <div>
                    <label for="procede-asociacion" class="block text-sm font-medium text-secondary mb-1">Asociaci√≥n de Procedencia:</label>
                    <input type="text" id="procede-asociacion" class="form-input-base">
                </div>
            </div>
            <div class="mt-8 text-left">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Tr√°mite</button>
            </div>
        </form>
        <div id="tramite-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
      </div>
    </script>
    
    <script id="tramite-form-template-mobile" type="text/x-handlebars-template">
        <div class="bg-secondary p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-6 text-primary">Datos del Jugador</h2>
            <form id="form-tramite">
                <div class="space-y-4">
                    <div>
                        <label for="ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                        <input type="text" id="ci" class="form-input-base" placeholder="Ej: 12345678-K" required>
                    </div>
                    <div>
                        <label for="fecha-nac" class="block text-sm font-medium text-secondary mb-1">Fecha Nacimiento:</label>
                        <input type="text" id="fecha-nac" class="form-input-base" placeholder="dd-mm-aaaa" required maxlength="10">
                    </div>
                    <div>
                        <label for="apellido-paterno" class="block text-sm font-medium text-secondary mb-1">Apellido Paterno:</label>
                        <input type="text" id="apellido-paterno" class="form-input-base" required>
                    </div>
                    <div>
                        <label for="apellido-materno" class="block text-sm font-medium text-secondary mb-1">Apellido Materno:</label>
                        <input type="text" id="apellido-materno" class="form-input-base" required>
                    </div>
                    <div>
                        <label for="nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                        <input type="text" id="nombres" class="form-input-base" required>
                    </div>
                    <div class="mb-6">
                        <span class="block text-sm font-medium text-secondary mb-2">Solicita:</span>
                        <div class="mt-2 grid grid-cols-2 gap-4">
                            <div class="flex items-center"> <input type="text" id="solicita_inscripcion_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Inscripci√≥n</span> </div>
                            <div class="flex items-center"> <input type="text" id="solicita_pase_interno_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Interno</span> </div>
                            <div class="flex items-center"> <input type="text" id="solicita_pase_regional_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Regional</span> </div>
                            <div class="flex items-center"> <input type="text" id="solicita_pase_externo_char" maxlength="1" class="single-char-input solicita-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Pase Externo</span> </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <span class="block text-sm font-medium text-secondary mb-2">Categor√≠a:</span>
                        <div class="mt-2 grid grid-cols-2 gap-4">
                            <div class="flex items-center"> <input type="text" id="categoria_extranjero_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Extranjero</span> </div>
                            <div class="flex items-center"> <input type="text" id="categoria_libertad_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Libertad Acci√≥n</span> </div>
                            <div class="flex items-center"> <input type="text" id="categoria_adulto_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Adulto</span> </div>
                            <div class="flex items-center"> <input type="text" id="categoria_femenina_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Femenina</span> </div>
                            <div class="flex items-center"> <input type="text" id="categoria_infantil_char" maxlength="1" class="single-char-input categoria-option" readonly style="cursor: pointer;"> <span class="ml-2 text-sm text-primary">Infantil</span> </div>
                        </div>
                    </div>
                    <div>
                        <label for="procede-club" class="block text-sm font-medium text-secondary mb-1">Procede del Club:</label>
                        <input type="text" id="procede-club" class="form-input-base">
                    </div>
                    <div>
                        <label for="procede-asociacion" class="block text-sm font-medium text-secondary mb-1">Asociaci√≥n de Procedencia:</label>
                        <input type="text" id="procede-asociacion" class="form-input-base">
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Tr√°mite</button>
                </div>
            </form>
            <div id="tramite-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
        </div>
    </script>
    
    <script id="autorizacion-form-template-desktop" type="text/x-handlebars-template">
      <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
        <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Autorizante</h2>
        <form id="form-autorizacion">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                <div class="md:col-span-2">
                    <label for="apoderado-nombre" class="block text-sm font-medium text-secondary mb-1">Nombre del Apoderado:</label>
                    <input type="text" id="apoderado-nombre" class="form-input-base" required>
                </div>
                <div>
                    <label for="apoderado-ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                    <input type="text" id="apoderado-ci" class="form-input-base" placeholder="Ej: 12345678-K" required>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                <div class="md:col-span-2">
                    <label for="jugador-nombre-auth" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador:</label>
                    <input type="text" id="jugador-nombre-auth" class="form-input-base" required placeholder="Solo un nombre y los dos apellidos">
                </div>
                <div>
                    <label for="parentesco" class="block text-sm font-medium text-secondary mb-1">Parentesco:</label>
                    <select id="parentesco" class="form-input-base form-select-base" required>
                        <option value="">Seleccione...</option>
                        <option value="Padre">Padre</option>
                        <option value="Madre">Madre</option>
                        <option value="Hermana">Hermana</option>
                        <option value="Hermano">Hermano</option>
                        <option value="Tutor Legal">Tutor Legal</option>
                        <option value="Abuelo">Abuelo</option>
                        <option value="Abuela">Abuela</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 text-left">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Autorizaci√≥n</button>
            </div>
        </form>
        <div id="auth-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
      </div>
    </script>
    
    <script id="autorizacion-form-template-mobile" type="text/x-handlebars-template">
        <div class="bg-secondary p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-6 text-primary">Datos del Autorizante</h2>
            <form id="form-autorizacion">
                <div class="space-y-4">
                    <div>
                        <label for="apoderado-nombre" class="block text-sm font-medium text-secondary mb-1">Nombre del Apoderado:</label>
                        <input type="text" id="apoderado-nombre" class="form-input-base" required>
                    </div>
                    <div>
                        <label for="apoderado-ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                        <input type="text" id="apoderado-ci" class="form-input-base" placeholder="Ej: 12345678-K" required>
                    </div>
                    <div>
                        <label for="jugador-nombre-auth" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador:</label>
                       <input type="text" id="jugador-nombre-auth" class="form-input-base" required placeholder="Solo un nombre y los dos apellidos">
                    </div>
                    <div>
                        <label for="parentesco" class="block text-sm font-medium text-secondary mb-1">Parentesco:</label>
                        <select id="parentesco" class="form-input-base form-select-base" required>
                            <option value="">Seleccione...</option>
                            <option value="Padre">Padre</option>
                            <option value="Madre">Madre</option>
                            <option value="Hermana">Hermana</option>
                            <option value="Hermano">Hermano</option>
                            <option value="Tutor Legal">Tutor Legal</option>
                            <option value="Abuelo">Abuelo</option>
                            <option value="Abuela">Abuela</option>
                        </select>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Autorizaci√≥n</button>
                </div>
            </form>
            <div id="auth-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
        </div>
    </script>

    <script id="poder-simple-form-template-desktop" type="text/x-handlebars-template">
    <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
        <form id="form-poder-simple">
            <div class="form-section pt-0 border-t-0">
                <h3 class="text-lg font-semibold text-secondary mb-6">Datos del Autorizante</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label for="poder-nombre-autorizante" class="block text-sm font-medium text-secondary mb-1">Nombre Completo del Autorizante:</label>
                        <input type="text" id="poder-nombre-autorizante" class="form-input-base" required>
                    </div>
                    <div>
                        <label for="poder-ci-autorizante" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                        <input type="text" id="poder-ci-autorizante" class="form-input-base" placeholder="Ej: 12345678-K" required>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h3 class="text-lg font-semibold text-secondary mb-6">Datos del Jugador</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label for="poder-nombre-hijo" class="block text-sm font-medium text-secondary mb-1">Nombre Completo del Jugador:</label>
                        <input type="text" id="poder-nombre-hijo" class="form-input-base" required>
                    </div>
                    <div>
                        <label for="poder-ci-hijo" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                        <input type="text" id="poder-ci-hijo" class="form-input-base" placeholder="Ej: 23456789-K" required>
                    </div>
                </div>
            </div>
            <div class="form-section">
    <h3 class="text-lg font-semibold text-secondary mb-6">Fecha del Documento</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
            <input type="text" id="poder-fecha" class="form-input-base" placeholder="dd-mm-aaaa" required maxlength="10">
        </div>
    </div>
</div>
            <div class="mt-8 text-left">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Poder Simple</button>
            </div>
        </form>
        <div id="poder-simple-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
    </div>
</script>

        <script id="poder-simple-form-template-mobile" type="text/x-handlebars-template">
    <div class="bg-secondary p-4 rounded-lg shadow-md">
        <form id="form-poder-simple">
            <div class="space-y-4">
                <div>
                    <label for="poder-nombre-autorizante" class="block text-sm font-medium text-secondary mb-1">Yo, (Nombre Completo del Autorizante):</label>
                    <input type="text" id="poder-nombre-autorizante" class="form-input-base" required>
                </div>
                <div>
                    <label for="poder-ci-autorizante" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad del Autorizante:</label>
                    <input type="text" id="poder-ci-autorizante" class="form-input-base" placeholder="Ej: 12345678-K" required>
                </div>
                <hr class="my-6 border-[var(--border-color)]">
                <div>
                    <label for="poder-nombre-hijo" class="block text-sm font-medium text-secondary mb-1">Autorizo a mi hijo(a):</label>
                    <input type="text" id="poder-nombre-hijo" class="form-input-base" required>
                </div>
                <div>
                    <label for="poder-ci-hijo" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad del Jugador:</label>
                    <input type="text" id="poder-ci-hijo" class="form-input-base" placeholder="Ej: 23456789-K" required>
                </div>
            </div>
            <div>
    <input type="text" id="poder-fecha" class="form-input-base" placeholder="dd-mm-aaaa" required maxlength="10">
</div>
            <div class="mt-8 text-right">
                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Poder Simple</button>
            </div>
        </form>
        <div id="poder-simple-form-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
    </div>
</script>

    <script>
    // =================================================================================
    // CONFIGURACI√ìN Y VARIABLES GLOBALES
    // =================================================================================
    const SUPABASE_URL = 'https://isiesnydtoyzgsjmuqyf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzaWVzbnlkdG95emdzam11cXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODc3NjgsImV4cCI6MjA2NTg2Mzc2OH0.0f3wAuzXNbQ2UhxUI0TQCRRhK1uO1MskZven3Cu98Yw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales para funcionalidades espec√≠ficas
    let cropperInstance = null;
    let isCropperScriptLoaded = false; // Para asegurar que Cropper.js est√© cargado
    let itemToDelete = { id: null, type: null, name: '' }; // Para el modal de eliminaci√≥n

    // Ajustes para Foto Carnet
    let fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };

    // Ajustes para C√©dula de Identidad
    let ci_perspectiveImage = new Image();
    let ci_perspectivePoints = [];
    let ci_perspectiveOriginalCanvas, ci_perspectiveTransformedCanvas;
    let ci_perspectiveCtxOriginal, ci_perspectiveCtxTransformed;
    let ci_savedFoto1DataUrl = null, ci_savedFoto2DataUrl = null;
    let ci_currentSelectedFoto = 'foto1'; // 'foto1' (anverso) o 'foto2' (reverso)
    const CI_FINAL_WIDTH = 340;¬† // Ancho deseado para la imagen de c√©dula corregida
    const CI_FINAL_HEIGHT = 227; // Alto deseado para la imagen de c√©dula corregida
    let ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };

    // Cache de elementos del DOM frecuentemente usados
    let loginScreen, appScreen, mainTitleElement, contentAreaElement, sidebarElement,
        loginFormElement, usernameLoginInput, loginErrorMessage,
        menuTramiteLink, menuAutorizacionLink, menuUsuariosLink, menuListaLink,
        menuFotoCarnetLink, menuCedulaIdentidadLink, collapseToggleBtn, logoutBtn,
        darkModeToggleBtn, deleteConfirmModal, confirmDeleteBtn, cancelDeleteBtn,
        htmlTagElement, darkModeIconElement;


    // =================================================================================
    // FUNCIONES DE UTILIDAD GENERAL
    // =================================================================================

    /**
    * Convierte una fecha en formato 'AAAA-MM-DD' a formato largo en espa√±ol.
    * @param {string} dateString - La fecha en formato 'AAAA-MM-DD'.
    * @returns {string} - La fecha en formato 'DD de [mes] de AAAA'.
    */
    function formatDateToLongSpanish(dateString) {
        if (!dateString || !dateString.includes('-')) {
            return ''; // Devuelve vac√≠o si la fecha no es v√°lida
        }
        const months = [
            "enero", "febrero", "marzo", "abril", "mayo", "junio",
            "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
        ];
        const parts = dateString.split('-'); // [AAAA, MM, DD]
        if (parts.length !== 3) {
            return dateString; // Devuelve el original si no tiene el formato esperado
        }
        const year = parts[0];
        const monthIndex = parseInt(parts[1], 10) - 1; // El mes es 0-11
        const day = parseInt(parts[2], 10);
    
        if (isNaN(monthIndex) || isNaN(day)) {
            return dateString;
        }

            return `${day} de ${months[monthIndex]} de ${year}`;
    }

    function setupExclusiveChoice(inputElements) {
        inputElements.forEach(clickedInput => {
            clickedInput.addEventListener('click', () => {
                const currentValue = clickedInput.value;
                // Limpiar todos los inputs del grupo
                inputElements.forEach(otherInput => {
                    otherInput.value = '';
                });
                // Si el campo no estaba ya marcado, lo marca. Si ya lo estaba, lo deja limpio (efecto desmarcar).
                if (currentValue !== 'X') {
                    clickedInput.value = 'X';
                }
            });
        });
    }

    /**
     * Muestra un mensaje temporal en un elemento espec√≠fico.
     * @param {string} elementId - ID del elemento donde mostrar el mensaje.
     * @param {string} message - El mensaje a mostrar.
     * @param {boolean} [isError=false] - Si es true, el mensaje se mostrar√° como error.
     * @param {number} [duration=3000] - Duraci√≥n en milisegundos del mensaje.
     */
    function showTemporaryMessage(elementId, message, isError = false, duration = 3000) {
        const messageDiv = document.getElementById(elementId);
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `text-sm mt-2 min-h-[1.25rem] ${isError ? 'text-red-600' : 'text-green-600'}`;
            if (duration > 0) {
                setTimeout(() => {
                    if (messageDiv.textContent === message) { // Solo limpiar si el mensaje no ha cambiado
                        messageDiv.textContent = '';
                        messageDiv.className = 'text-sm mt-2 min-h-[1.25rem]';
                    }
                }, duration);
            }
        }
    }

    /**
     * Formatea el input de RUT (ej. 12.345.678-K).
     * @param {HTMLInputElement} rutInput - El elemento input del RUT.
     */
    function formatRut(rutInput) {
        if (!rutInput) return;
        let rut = rutInput.value.replace(/[^0-9kK]/g, '').toLowerCase();
        let formattedRut = '';
        if (rut.length > 1) {
            let dv = rut.slice(-1);
            let body = rut.slice(0, -1);
            let bodyFormatted = "";
            while (body.length > 3) {
                bodyFormatted = "." + body.slice(-3) + bodyFormatted;
                body = body.slice(0, -3);
            }
            bodyFormatted = body + bodyFormatted;
            formattedRut = bodyFormatted + '-' + dv;
        } else {
            formattedRut = rut;
        }
        rutInput.value = formattedRut.toUpperCase();
    }

    /**
     * Formatea el input de username/RUT para el formulario de usuarios (permite guion).
     * @param {HTMLInputElement} rutInput - El elemento input del RUT.
     */
    function formatUsernameRut(rutInput) {
        if (!rutInput) return;
        let value = rutInput.value.replace(/[^0-9kK-]/g, '');
        const parts = value.split('-');
        let body = parts[0].replace(/[^0-9kK]/g, '');
        let dv = '';
        if (parts.length > 1) {
            dv = parts.slice(1).join('').replace(/[^0-9kK]/g, '');
            if (dv.length > 1) dv = dv.charAt(0);
        }
        value = body;
        if (dv.match(/^[0-9kK]$/i)) {
            value += '-' + dv;
        } else if (dv) { // Si hay algo despu√©s del guion pero no es un DV v√°lido, solo mantener el cuerpo
             value = body;
        }
        rutInput.value = value.toUpperCase();
    }

    /**
     * Formatea el input de username para el login (permite un solo guion).
     * @param {HTMLInputElement} inputElement - El elemento input del username.
     */
    function formatLoginUsername(inputElement) {
        if (!inputElement) return;
        let value = inputElement.value;
        value = value.replace(/[^0-9kK-]/gi, ""); // Permitir n√∫meros, K, k, y guion
        // Asegurar que solo haya un guion y est√© en la posici√≥n correcta
        let firstHyphenIndex = value.indexOf('-');
        if (firstHyphenIndex !== -1) {
            let part1 = value.substring(0, firstHyphenIndex + 1);
            let part2 = value.substring(firstHyphenIndex + 1).replace(/-/g, ""); // Eliminar guiones adicionales
            value = part1 + part2;
        }
        inputElement.value = value.toUpperCase();
    }

    /**
     * Formatea el input de fecha de nacimiento (DD-MM-AAAA).
     * @param {HTMLInputElement} dateInput - El elemento input de la fecha.
     */
    function formatFechaNacimiento(dateInput) {
        if (!dateInput) return;
        let date = dateInput.value.replace(/[^0-9]/g, '');
        let formattedDate = '';
        if (date.length >= 2) {
            formattedDate += date.substring(0, 2);
            if (date.length >= 4) {
                formattedDate += '-' + date.substring(2, 4);
                if (date.length >= 8) {
                    formattedDate += '-' + date.substring(4, 8);
                } else if (date.length > 4) {
                    formattedDate += '-' + date.substring(4);
                }
            } else if (date.length > 2) {
                formattedDate += '-' + date.substring(2);
            }
        } else {
            formattedDate = date;
        }
        dateInput.value = formattedDate.substring(0, 10); // Limitar a 10 caracteres (DD-MM-AAAA)
    }

    /**
     * Carga un script din√°micamente y ejecuta un callback al finalizar.
     * @param {string} src - URL del script.
     * @param {function} callback - Funci√≥n a ejecutar despu√©s de cargar el script.
     */
    function loadScript(src, callback) {
        const existingScript = document.querySelector(`script[src="${src}"]`);
        if (existingScript) {
            if (src.includes('cropper')) isCropperScriptLoaded = true;

            // Si el script ya existe, verificar si la variable global est√° disponible antes de llamar al callback
            const checkGlobalVar = (varName, cb) => {
                if (typeof window[varName] !== 'undefined') {
                    if (cb) cb();
                } else {
                    setTimeout(() => checkGlobalVar(varName, cb), 100); // Reintentar
                }
            };

            if (src.includes('cropper')) checkGlobalVar('Cropper', callback);
            else if (src.includes('numeric')) checkGlobalVar('numeric', callback);
            else if (callback) callback(); // Para otros scripts sin variable global obvia
            return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.defer = true; // Asegurar que se ejecute despu√©s del parseo del HTML
        script.onload = () => {
            if (src.includes('cropper')) isCropperScriptLoaded = true;
            if (callback) callback();
        };
        script.onerror = () => {
            console.error(`Error al cargar el script: ${src}`);
            if (contentAreaElement) {
                const errorMsg = document.createElement('p');
                errorMsg.className = 'text-red-500 text-center font-bold p-4';
                errorMsg.textContent = `Error cr√≠tico: No se pudo cargar la librer√≠a ${src.split('/').pop()}. Algunas funcionalidades podr√≠an no estar disponibles. Intente recargar la p√°gina.`;
                contentAreaElement.prepend(errorMsg);
            }
            if (src.includes('cropper')) {
                const previewButton = document.getElementById('preview-foto-carnet-button');
                if(previewButton) previewButton.disabled = true;
                const cropperContainer = document.querySelector('.cropper-container-wrapper');
                if(cropperContainer) cropperContainer.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: Herramienta de recorte no cargada.</p>';
            }
        };
        document.body.appendChild(script);
    }

    /**
     * Descarga un Data URL como un archivo PDF.
     * @param {string} dataUrl - El Data URL del PDF.
     * @param {string} filename - Nombre del archivo a descargar.
     */
    function downloadDataUrlAsPdf(dataUrl, filename) {
        if (!dataUrl) return;
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /**
     * Descarga un Data URL como un archivo de imagen (ej. PNG).
     * @param {string} dataUrl - El Data URL de la imagen.
     * @param {string} filename - Nombre del archivo a descargar.
     */
    function downloadDataUrlAsImage(dataUrl, filename) { // Para Imagen (ej. PNG)
        if (!dataUrl) return;
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename; // Ej: "foto_carnet.png"
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    // =================================================================================
    // MANEJO DE ESTADO DE LA UI (LOGIN, APP SCREEN, SIDEBAR, DARK MODE)
    // =================================================================================

    function showLoginScreen() {
        if (loginScreen) loginScreen.style.display = 'flex';
        if (appScreen) appScreen.style.display = 'none';
        const menuUsuariosLi = document.getElementById('li-menu-usuarios');
        if (menuUsuariosLi) {
            menuUsuariosLi.style.display = 'none';
        }
    }

    function showAppScreen() {
        if (loginScreen) loginScreen.style.display = 'none';
        if (appScreen) appScreen.style.display = 'flex';
        if (mainTitleElement) mainTitleElement.innerText = 'Bienvenido';
        if (contentAreaElement) contentAreaElement.innerHTML = '<p class="text-lg">Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>';

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const menuUsuariosLi = document.getElementById('li-menu-usuarios');
        if (menuUsuariosLi) {
            menuUsuariosLi.style.display = (currentUser && currentUser.role === 'admin') ? 'list-item' : 'none';
        }
    }

    function toggleSidebar() {
        sidebarElement?.classList.toggle('sidebar-collapsed');
    }

    function setupDarkMode() {
        if (!darkModeToggleBtn || !htmlTagElement || !darkModeIconElement) return;

        const applyDarkMode = (isDark) => {
            htmlTagElement.classList.toggle('dark', isDark);
            darkModeIconElement.classList.toggle('fa-sun', isDark);
            darkModeIconElement.classList.toggle('fa-moon', !isDark);
        };

        const preferredDarkMode = localStorage.getItem('darkMode');
        applyDarkMode(preferredDarkMode === 'enabled');

        darkModeToggleBtn.addEventListener('click', () => {
            const isDark = htmlTagElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            applyDarkMode(isDark);
        });
    }

    // =================================================================================
    // MODAL DE CONFIRMACI√ìN
    // =================================================================================

    function showDeleteConfirmModal(id, type, itemName) {
        itemToDelete = { id, type, name: itemName };
        const messageElement = document.getElementById('delete-modal-message');
        if (messageElement) {
            messageElement.textContent = `¬øEst√°s seguro de que deseas eliminar "${itemName}"? Esta acci√≥n no se puede deshacer.`;
        }
        if (deleteConfirmModal) deleteConfirmModal.style.display = 'flex';
    }

    function hideDeleteConfirmModal() {
        if (deleteConfirmModal) deleteConfirmModal.style.display = 'none';
        itemToDelete = { id: null, type: null, name: '' }; // Resetear
    }

    async function proceedWithDeletion() {
        if (!itemToDelete.id || !itemToDelete.type) return;
        console.log(`[proceedWithDeletion] Confirmado. Eliminando ${itemToDelete.type} con ID: ${itemToDelete.id}`);

        let tableName = '';
        let idField = 'id'; // Por defecto es 'id'

        switch (itemToDelete.type) {
            case 'user':
                tableName = 'users'; // Tabla public.users
                idField = 'username'; // Se elimina por username (RUT) de public.users
                break;
            case 'tramite':
                tableName = 'players';
                break;
            case 'autorizacion':
                tableName = 'autorizaciones';
                break;
            case 'fotocarnet':
                tableName = 'fotocarnets';
                break;
            case 'cedula':
                tableName = 'cedulas_identidad';
                break;
            case 'poder_simple':
                tableName = 'poderes_simples';
                break;
            default:
                console.error("Tipo de eliminaci√≥n desconocido:", itemToDelete.type);
                hideDeleteConfirmModal();
                return;
        }

        const { error: deleteError } = await supabaseClient
            .from(tableName)
            .delete()
            .eq(idField, itemToDelete.id);

        if (deleteError) {
            console.error(`[proceedWithDeletion] Error de Supabase al eliminar ${itemToDelete.type}:`, deleteError);
            const modalMessage = document.getElementById('delete-modal-message');
            if(modalMessage) modalMessage.textContent = `Error al eliminar: ${deleteError.message}. Int√©ntalo de nuevo.`;
            // No ocultar modal en error para que el usuario vea el mensaje
        } else {
            console.log(`[proceedWithDeletion] ${itemToDelete.type} eliminado de Supabase:`, itemToDelete.id);
            if (itemToDelete.type === 'user') {
                renderUserManagementForm(); // Recargar lista de usuarios
            } else {
                renderPlayerList(); // Recargar lista de jugadores/autorizaciones/etc.
            }
            hideDeleteConfirmModal(); // Ocultar modal solo si tiene √©xito
        }
    }

    // =================================================================================
    // AUTENTICACI√ìN Y SESI√ìN
    // =================================================================================

    async function handleLoginSubmit(event) {
        event.preventDefault();
        if (!usernameLoginInput || !password || !loginErrorMessage) return;

        const username = usernameLoginInput.value; // RUT del usuario
        const passwordValue = document.getElementById('password').value;
        loginErrorMessage.textContent = '';

        console.log('[handleLoginSubmit] Intentando login con C√©dula (username) procesada:', username);

        const { data: user, error } = await supabaseClient
            .from('users') // Tabla public.users
            .select('*')
            .eq('username', username) // Login con RUT
            .single();

        if (error || !user) {
            loginErrorMessage.textContent = 'Usuario no encontrado o error de conexi√≥n.';
            console.error('[handleLoginSubmit] Error fetching from public.users or user not found:', error);
            return;
        }

        // Comparar hash de contrase√±a
        const encoder = new TextEncoder();
        const passwordData = encoder.encode(passwordValue);
        const hashBuffer = await crypto.subtle.digest('SHA-256', passwordData);
        const enteredPasswordHash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

        if (enteredPasswordHash === user.password_hash) {
            console.log('[handleLoginSubmit] Credenciales v√°lidas para (public.users):', user.username);
            localStorage.setItem('currentUser', JSON.stringify(user)); // Guardar usuario de public.users

            usernameLoginInput.value = ''; // Limpiar campos
            document.getElementById('password').value = '';
            showAppScreen();
        } else {
            console.warn('[handleLoginSubmit] Contrase√±a incorrecta para (public.users):', username);
            loginErrorMessage.textContent = 'Credenciales inv√°lidas.';
        }
    }

    function handleLogout() {
        localStorage.removeItem('currentUser'); // Limpiar usuario de public.users
        console.log("Sesi√≥n local cerrada.");
        showLoginScreen();
    }

    // =================================================================================
    // RENDERIZADO DE CONTENIDO DIN√ÅMICO (Formularios y Listas)
    // =================================================================================

function renderPoderSimpleForm() {
    if (!mainTitleElement || !contentAreaElement) return;
    mainTitleElement.innerText = 'Poder Simple';

    const desktopTemplateSource = document.getElementById('poder-simple-form-template-desktop').innerHTML;
    const mobileTemplateSource = document.getElementById('poder-simple-form-template-mobile').innerHTML;

    const desktopTemplate = Handlebars.compile(desktopTemplateSource);
    const mobileTemplate = Handlebars.compile(mobileTemplateSource);

    contentAreaElement.innerHTML = `
        <div class="desktop-only">${desktopTemplate()}</div>
        <div class="mobile-only">${mobileTemplate()}</div>
    `;
    
    document.getElementById('form-poder-simple').addEventListener('submit', handlePoderSimpleSubmit);
    document.getElementById('poder-ci-autorizante').addEventListener('input', (e) => formatRut(e.target));
    document.getElementById('poder-ci-hijo').addEventListener('input', (e) => formatRut(e.target));
    ['poder-nombre-autorizante', 'poder-nombre-hijo'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
    });
    // --- C√ìDIGO PARA FORMATEAR LA FECHA AL ESCRIBIR ---
        const fechaInput = document.getElementById('poder-fecha');
        if (fechaInput) {
    // A√±adir el listener para que se auto-formatee al escribir, usando la misma funci√≥n que "Fecha Nacimiento"
    fechaInput.addEventListener('input', (e) => formatFechaNacimiento(e.target));
        }
    // --- FIN DEL C√ìDIGO DE FECHA ---

    }

    async function renderPlayerList() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) { showLoginScreen(); return; }

        if (!mainTitleElement || !contentAreaElement) return;
        mainTitleElement.innerText = 'Tramites Guardados';

        const listContainerHtml = `
    <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md space-y-8">
        <div class="p-4 border border-border-color rounded-lg bg-primary">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Tr√°mites Individuales</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">PDF</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fec. Creaci√≥n</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">C√©dula</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">A. Paterno</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">A. Materno</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Nombres</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fec. Nac.</th>
                            ${currentUser.role === 'admin' ? '<th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-border-input">Eliminar</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="list-tramites-body" class="bg-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 border border-border-color rounded-lg bg-primary">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Autorizaciones</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">PDF</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fec. Creaci√≥n</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Apoderado</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">CI Apod.</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Jugador</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Parentesco</th>
                            ${currentUser.role === 'admin' ? '<th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-border-input">Eliminar</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="list-autorizaciones-body" class="bg-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 border border-border-color rounded-lg bg-primary">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Fotos Carnet</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">FOTO</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fecha Creaci√≥n</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Nombre Jugador</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">RUT Jugador</th>
                            ${currentUser.role === 'admin' ? '<th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-border-input">Eliminar</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="list-fotocarnets-body" class="bg-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 border border-border-color rounded-lg bg-primary">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">C√©dulas de Identidad</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">PDF</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fecha Creaci√≥n</th>
                            <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Nombre Jugador</th>
                            ${currentUser.role === 'admin' ? '<th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-border-input">Eliminar</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="list-cedulas-body" class="bg-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 border border-border-color rounded-lg bg-primary">
    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Poderes Simples</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">PDF</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fec. Creaci√≥n</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Autorizante</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">CI Autorizante</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Jugador</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">CI Jugador</th>
                    <th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider border-b-2 border-r border-border-input">Fecha Doc.</th>
                    ${currentUser.role === 'admin' ? '<th scope="col" class="bg-gray-400 text-white dark:bg-gray-700 dark:text-gray-200 px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider border-b-2 border-border-input">Eliminar</th>' : ''}
                </tr>
            </thead>
            <tbody id="list-poderes-simples-body" class="bg-secondary"></tbody>
        </table>
    </div>
</div>
    </div>`;
        contentAreaElement.innerHTML = listContainerHtml;

        const templateSource = document.getElementById('list-row-template').innerHTML;
        const template = Handlebars.compile(templateSource);

        const isAdmin = currentUser.role === 'admin';
        const emptyRowColspan = (type) => {
            const spans = { tramite: 6, autorizacion: 5, fotocarnet: 4, cedula: 3, poder_simple: 6 };
            return isAdmin ? spans[type] + 1 : spans[type];
        };

        const populateTable = async (tableName, bodyId, type, fields = '*') => {
    const tableBody = document.getElementById(bodyId);
    if (!tableBody) return;

    let query = supabaseClient.from(tableName).select(fields);
    if (!isAdmin) {
        query = query.eq('user_id', currentUser.id);
    }
    const { data, error } = await query;

    if (error) {
        tableBody.innerHTML = `<tr><td colspan="${emptyRowColspan(type)}" class="px-6 py-4 text-center text-red-500">Error cargando datos: ${error.message}</td></tr>`;
    } else if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${emptyRowColspan(type)}" class="px-6 py-4 text-center text-secondary">No hay elementos registrados.</td></tr>`;
    } else {
        data.forEach(item => {
            // Formatear la fecha de creaci√≥n (createdAtFormatted)
            if (item.created_at) {
                item.createdAtFormatted = new Date(item.created_at).toLocaleDateString('es-CL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } else {
                item.createdAtFormatted = 'N/A';
            }

            // --- INICIO DE LA MODIFICACI√ìN ---
            // Formatear la fecha del documento (fecha) si existe
            if (item.fecha) { // El campo 'fecha' viene de la base de datos como AAAA-MM-DD
                const parts = item.fecha.split('-');
                if (parts.length === 3) {
                    // La reordenamos para mostrarla como DD-MM-AAAA
                    item.fecha = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            // --- FIN DE LA MODIFICACI√ìN ---
        });
        
        const context = { items: data, isAdmin: isAdmin, type: type };
        tableBody.innerHTML = template(context);
    }
};

        populateTable('players', 'list-tramites-body', 'tramite');
        populateTable('autorizaciones', 'list-autorizaciones-body', 'autorizacion');
        populateTable('fotocarnets', 'list-fotocarnets-body', 'fotocarnet');
        populateTable('cedulas_identidad', 'list-cedulas-body', 'cedula');
        populateTable('poderes_simples', 'list-poderes-simples-body', 'poder_simple');
    }

    /**
     * Renderiza el formulario para un nuevo tr√°mite individual.
     */
    function renderTramiteForm() {
        if (!mainTitleElement || !contentAreaElement) return;
        mainTitleElement.innerText = 'Tr√°mite Individual';
        
        // --- INICIO DE LA MODIFICACI√ìN ---
        // Cargar ambas plantillas (desktop y mobile)
        const desktopTemplateSource = document.getElementById('tramite-form-template-desktop').innerHTML;
        const mobileTemplateSource = document.getElementById('tramite-form-template-mobile').innerHTML;
        
        const desktopTemplate = Handlebars.compile(desktopTemplateSource);
        const mobileTemplate = Handlebars.compile(mobileTemplateSource);

        // Insertar ambas versiones en el content-area, envueltas en sus divs con clases de control
        contentAreaElement.innerHTML = `
            <div class="desktop-only">${desktopTemplate()}</div>
            <div class="mobile-only">${mobileTemplate()}</div>
        `;
        // --- FIN DE LA MODIFICACI√ìN ---

        // --- La l√≥gica siguiente funciona para AMBAS versiones porque los IDs de los campos son los mismos ---
        const solicitaInputs = document.querySelectorAll('.solicita-option');
        const categoriaInputs = document.querySelectorAll('.categoria-option');
        setupExclusiveChoice(solicitaInputs);
        setupExclusiveChoice(categoriaInputs);
        
        document.getElementById('form-tramite').addEventListener('submit', handleTramiteSubmit);
        document.getElementById('ci').addEventListener('input', (e) => formatRut(e.target));
        document.getElementById('fecha-nac').addEventListener('input', (e) => formatFechaNacimiento(e.target));
        ['apellido-paterno', 'apellido-materno', 'nombres', 'procede-club', 'procede-asociacion'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        });
    }

    /**
     * Renderiza el formulario para una nueva autorizaci√≥n.
     */
    function renderAutorizacionForm() {
        if (!mainTitleElement || !contentAreaElement) return;
        mainTitleElement.innerText = 'Autorizaci√≥n de Jugadores';

        // --- INICIO DE LA MODIFICACI√ìN ---
        const desktopTemplateSource = document.getElementById('autorizacion-form-template-desktop').innerHTML;
        const mobileTemplateSource = document.getElementById('autorizacion-form-template-mobile').innerHTML;

        const desktopTemplate = Handlebars.compile(desktopTemplateSource);
        const mobileTemplate = Handlebars.compile(mobileTemplateSource);

        contentAreaElement.innerHTML = `
            <div class="desktop-only">${desktopTemplate()}</div>
            <div class="mobile-only">${mobileTemplate()}</div>
        `;
        // --- FIN DE LA MODIFICACI√ìN ---

        document.getElementById('form-autorizacion').addEventListener('submit', handleAutorizacionSubmit);
        document.getElementById('apoderado-ci').addEventListener('input', (e) => formatRut(e.target));
        ['apoderado-nombre', 'jugador-nombre-auth'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        });
    }

    /**
     * Renderiza el formulario de gesti√≥n de usuarios y la lista de usuarios.
     */
    async function renderUserManagementForm() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'admin') {
            if (contentAreaElement) contentAreaElement.innerHTML = '<p class="text-red-500 text-center font-semibold p-4">Acceso restringido a administradores.</p>';
            return;
        }
        if (!mainTitleElement || !contentAreaElement) return;
        mainTitleElement.innerText = 'Gesti√≥n de Usuarios';
        const inputBaseClasses = "form-input-base";

        // --- INICIO DE LA MODIFICACI√ìN ---
        const desktopForm = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                <div>
                    <label for="new-username" class="block text-sm font-medium text-secondary mb-1">Usuario (RUT):</label>
                    <input type="text" id="new-username" class="${inputBaseClasses}" placeholder="Ej: 12345678-K" required>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-secondary mb-1">Clave:</label>
                    <input type="password" id="new-password" class="${inputBaseClasses}" placeholder="(En blanco para no cambiar al editar)">
                </div>
                <div class="flex flex-col">
                    <button type="submit" id="user-submit-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2">
                        <span id="user-submit-button-text">Agregar</span>
                    </button>
                    <button type="button" id="user-cancel-button" class="hidden w-full mt-2 inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar Edici√≥n
                    </button>
                </div>
            </div>
        `;
        const mobileForm = `
            <div class="space-y-4">
                <div>
                    <label for="new-username" class="block text-sm font-medium text-secondary mb-1">Usuario (RUT):</label>
                    <input type="text" id="new-username" class="${inputBaseClasses}" placeholder="Ej: 12345678-K" required>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-secondary mb-1">Clave:</label>
                    <input type="password" id="new-password" class="${inputBaseClasses}" placeholder="(En blanco para no cambiar al editar)">
                </div>
                <div class="flex flex-col space-y-2">
                    <button type="submit" id="user-submit-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2">
                        <span id="user-submit-button-text">Agregar</span>
                    </button>
                    <button type="button" id="user-cancel-button" class="hidden w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar Edici√≥n
                    </button>
                </div>
            </div>
        `;

        const managementHtml = `
            <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md mb-8">
                <h2 id="user-form-title" class="text-lg sm:text-xl font-semibold mb-4 text-primary">Agregar Nuevo Usuario</h2>
                <form id="form-add-user">
                    <input type="hidden" id="edit-user-id" value="">
                    <div class="mb-4">
                        <label for="new-fullname" class="block text-sm font-medium text-secondary mb-1">Nombre Completo:</label>
                        <input type="text" id="new-fullname" class="${inputBaseClasses}" required>
                    </div>
                    
                    <div class="desktop-only">${desktopForm}</div>
                    <div class="mobile-only">${mobileForm}</div>

                    <div class="mb-4">
                        <label for="new-role" class="block text-sm font-medium text-secondary mb-1">Rol:</label>
                        <select id="new-role" class="${inputBaseClasses} form-select-base">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div id="add-user-error" class="text-sm mt-1 min-h-[1.25rem]"></div>
                </form>
            </div>
            <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">Usuarios Registrados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-border-color border border-border-input">
                        <thead class="bg-primary dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Completo</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Usuario (RUT)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Rol</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Editar</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="user-management-table-body" class="bg-secondary divide-y divide-border-color">
                        </tbody>
                    </table>
                </div>
            </div>`;
        // --- FIN DE LA MODIFICACI√ìN ---
            
        contentAreaElement.innerHTML = managementHtml;

        document.getElementById('form-add-user').addEventListener('submit', handleAddUserSubmit);
        document.getElementById('user-cancel-button').addEventListener('click', resetUserForm);
        document.getElementById('new-username').addEventListener('input', (e) => formatUsernameRut(e.target));
        document.getElementById('new-fullname').addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        resetUserForm();

        const userTableBody = document.getElementById('user-management-table-body');
        const { data: usersData, error: usersError } = await supabaseClient.from('users').select('*');

        if (usersError) {
            userTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error cargando usuarios: ${usersError.message}</td></tr>`;
            return;
        }
        if (!usersData || usersData.length === 0) {
            userTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-secondary">No hay usuarios registrados.</td></tr>`;
            return;
        }

        const templateSource = document.getElementById('user-management-row-template').innerHTML;
        const template = Handlebars.compile(templateSource);
        userTableBody.innerHTML = template({ users: usersData });
    }


    /**
     * Renderiza el formulario para generar Foto Carnet.
     */
    function renderFotoCarnetForm() {
        if (!mainTitleElement || !contentAreaElement) return;

        if (cropperInstance) {
            try { cropperInstance.destroy(); } catch (e) { console.warn("Error al destruir Cropper:", e); }
            cropperInstance = null;
        }
        fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };

        mainTitleElement.innerText = 'Generar Foto Carnet';
        const inputBaseClasses = "form-input-base";
        contentAreaElement.innerHTML = `
            <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
                <div class="form-section pt-0 border-t-0">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">1. Sube y Ajusta tu Foto</h2>
                    <div class="mb-4 button-group">
                        <input type="file" id="image-upload" class="hidden-file-input" accept="image/*">
                        <label for="image-upload" class="file-input-label">
                            <i class="fas fa-upload"></i> <span>Seleccionar Foto</span>
                        </label>
                    </div>
                    <div class="cropper-container-wrapper mb-4 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                         <img id="cropper-image" src="" alt=" Sube una imagen para empezar.">
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">2. Ingresa tus Datos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="foto-nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                            <input type="text" id="foto-nombres" class="${inputBaseClasses}" required>
                        </div>
                        <div>
                            <label for="foto-apellidos" class="block text-sm font-medium text-secondary mb-1">Apellidos:</label>
                            <input type="text" id="foto-apellidos" class="${inputBaseClasses}" required>
                        </div>
                        <div>
                            <label for="foto-rut" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                            <input type="text" id="foto-rut" class="${inputBaseClasses}" placeholder="Ej: 12345678-K" required>
                        </div>
                    </div>
                    <div class="mt-4">
                         <button type="button" id="preview-foto-carnet-button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50" disabled>
                            <i class="fas fa-eye mr-2"></i>Previsualizar
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">3. Previsualizaci√≥n y Ajustes</h2>
                    <div class="result-canvas-container mb-6 max-w-xs">
                        <canvas id="result-canvas"></canvas>
                        <p id="canvas-placeholder" class="text-secondary">Aqu√≠ aparecer√° la foto generada.</p>
                    </div>

                     <div class="foto-carnet-ajustes-container mb-6 max-w-md">
                        <h3 class="text-md font-medium text-primary mb-3 text-left">Ajustes de Imagen</h3>
                        <div class="foto-carnet-ajustes-grid grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="adjustment-control">
                                <label for="fcBrightness" class="block text-sm font-medium text-primary">Brillo: <span id="fcBrightnessValue">0</span>%</label>
                                <input type="range" id="fcBrightness" min="-50" max="50" value="0" class="slider">
                            </div>
                            <div class="adjustment-control">
                                <label for="fcContrast" class="block text-sm font-medium text-primary">Contraste: <span id="fcContrastValue">100</span>%</label>
                                <input type="range" id="fcContrast" min="50" max="150" value="100" class="slider">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section text-left">
                    <button type="button" id="save-foto-carnet-button" class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" disabled>
                        <i class="fas fa-save mr-2"></i>Guardar Foto
                    </button>
                    <div id="foto-carnet-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
                </div>
            </div>`;
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js', setupFotoCarnetListeners);
    }

    /**
     * Renderiza el formulario para C√©dula de Identidad.
     */
    function renderCedulaIdentidadForm() {
        if (!mainTitleElement || !contentAreaElement) return;
        mainTitleElement.innerText = 'Modificaci√≥n y Guardado de C√©dula de Identidad';
        contentAreaElement.innerHTML = `
            <div id="cedula-identidad-section" class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
                <div class="mb-4">
                    <label for="nombre-jugador-cedula" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador (solo para registro):</label>
                    <input type="text" id="nombre-jugador-cedula" class="form-input-base" placeholder="Ej: JUAN PEREZ" required>
                </div>
                <div class="flex flex-col space-y-4 mb-6">
    <div class="flex items-center space-x-2 sm:space-x-4">
        <span class="text-sm font-medium text-primary">Subir para:</span>
        <label class="flex items-center cursor-pointer">
            <input type="radio" name="fotoCedulaSelect" value="foto1" class="form-radio h-4 w-4 text-blue-600" checked>
            <span class="ml-2 text-sm text-primary">Foto 1 (Anverso)</span>
        </label>
        <label class="flex items-center cursor-pointer">
            <input type="radio" name="fotoCedulaSelect" value="foto2" class="form-radio h-4 w-4 text-blue-600">
            <span class="ml-2 text-sm text-primary">Foto 2 (Reverso)</span>
        </label>
    </div>
    <div class="button-group">
        <input type="file" id="ciPerspectiveImageInput" class="hidden" accept="image/*">
        <label for="ciPerspectiveImageInput" class="file-input-label-cedula"><i class="fas fa-upload mr-2"></i>Seleccionar Archivo</label>
    </div>
</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Foto Original (Marcar 4 esquinas)</h3>
                        <div class="perspective-canvas-wrapper" id="ciOriginalCanvasContainer">
                            <canvas id="ciPerspectiveOriginalCanvas"></canvas>
                            <div id="ciCanvasPlaceholderCedula" class="text-sm">Sube una imagen para comenzar</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Foto Corregida</h3>
                        <div class="perspective-canvas-wrapper"><canvas id="ciPerspectiveTransformedCanvas"></canvas></div>
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 mb-6">
                    <div class="adjustment-control">
                        <label for="ciBrightness" class="block text-sm font-medium text-primary">Brillo: <span id="ciBrightnessValue">0</span>%</label>
                        <input type="range" id="ciBrightness" min="-50" max="50" value="0" class="slider">
                    </div>
                    <div class="adjustment-control">
                        <label for="ciContrast" class="block text-sm font-medium text-primary">Contraste: <span id="ciContrastValue">100</span>%</label>
                        <input type="range" id="ciContrast" min="50" max="150" value="100" class="slider">
                    </div>
                    <div class="adjustment-control">
                        <label for="ciSharpness" class="block text-sm font-medium text-primary">Nitidez: <span id="ciSharpnessValue">0</span>%</label>
                        <input type="range" id="ciSharpness" min="0" max="100" value="0" class="slider">
                    </div>
                    <div class="adjustment-control">
                        <label for="ciTemperature" class="block text-sm font-medium text-primary">Temperatura: <span id="ciTemperatureValue">0</span></label>
                        <input type="range" id="ciTemperature" min="-100" max="100" value="0" class="slider">
                    </div>
                </div>
                <div class="mt-6 flex flex-wrap gap-2">
                    <button id="ci-perspective-save-btn" class="px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-save mr-2"></i>Guardar Imagen</button>
                    <button id="ci-perspective-reset-points-btn" class="px-4 py-2 rounded-md"><i class="fas fa-undo mr-2"></i>Reiniciar Puntos</button>
                </div>
                <div class="saved-images-container mt-8">
                    <h3 class="text-lg font-medium text-primary mb-4">Im√°genes Guardadas para PDF</h3>
                    <div id="ciSavedImagesList" class="flex flex-wrap gap-4 items-start"></div>
                    <button id="ci-generate-cedula-pdf-btn" class="mt-4 px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-file-pdf mr-2"></i>Guardar PDF</button>
                </div>
                <div id="cedula-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
            </div>`;
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js', initializeCedulaIdentidadLogic);
    }


    // =================================================================================
    // L√ìGICA DE FORMULARIOS Y MANEJO DE DATOS (SUBMIT HANDLERS)
    // =================================================================================

    /**
     * Maneja el env√≠o del formulario de tr√°mite individual.
     */
    async function handleTramiteSubmit(event) {
        event.preventDefault();
        const formTramite = document.getElementById('form-tramite');
        const messageDivId = 'tramite-form-message';

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || !currentUser.id) {
            showTemporaryMessage(messageDivId, "Debes iniciar sesi√≥n para guardar un tr√°mite.", true);
            return;
        }

        const tramiteData = {
            ci: document.getElementById('ci').value,
            fecha_nac: document.getElementById('fecha-nac').value,
            apellido_paterno: document.getElementById('apellido-paterno').value,
            apellido_materno: document.getElementById('apellido-materno').value,
            nombres: document.getElementById('nombres').value,
            solicita_inscripcion: document.getElementById('solicita_inscripcion_char').value.trim().toUpperCase() || null,
            solicita_pase_interno: document.getElementById('solicita_pase_interno_char').value.trim().toUpperCase() || null,
            solicita_pase_regional: document.getElementById('solicita_pase_regional_char').value.trim().toUpperCase() || null,
            solicita_pase_externo: document.getElementById('solicita_pase_externo_char').value.trim().toUpperCase() || null,
            categoria_extranjero: document.getElementById('categoria_extranjero_char').value.trim().toUpperCase() || null,
            categoria_libertad: document.getElementById('categoria_libertad_char').value.trim().toUpperCase() || null,
            categoria_adulto: document.getElementById('categoria_adulto_char').value.trim().toUpperCase() || null,
            categoria_femenina: document.getElementById('categoria_femenina_char').value.trim().toUpperCase() || null,
            categoria_infantil: document.getElementById('categoria_infantil_char').value.trim().toUpperCase() || null,
            procede_club: document.getElementById('procede-club').value,
            procede_asociacion: document.getElementById('procede-asociacion').value,
            user_id: currentUser.id // ID de la tabla public.users
        };

        const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
        if (!dateRegex.test(tramiteData.fecha_nac)) {
            showTemporaryMessage(messageDivId, 'Formato de Fecha de Nacimiento incorrecto. Use DD-MM-AAAA.', true);
            return;
        }
        const solicitaValue = Object.keys(tramiteData).filter(k => k.startsWith('solicita_') && tramiteData[k]).length > 0;
        const categoriaValue = Object.keys(tramiteData).filter(k => k.startsWith('categoria_') && tramiteData[k]).length > 0;

        if (!solicitaValue) {
            showTemporaryMessage(messageDivId, 'Debe marcar al menos una opci√≥n en "Solicita".', true);
            return;
        }
        if (!categoriaValue) {
            showTemporaryMessage(messageDivId, 'Debe marcar al menos una opci√≥n en "Categor√≠a".', true);
            return;
        }

        const { error } = await supabaseClient.from('players').insert([tramiteData]);

        if (error) {
            console.error('[handleTramiteSubmit] Error al guardar tr√°mite:', error);
            showTemporaryMessage(messageDivId, 'Error al guardar tr√°mite: ' + error.message, true);
        } else {
            showTemporaryMessage(messageDivId, 'Tr√°mite guardado exitosamente!', false);
            if (formTramite) formTramite.reset();
            setTimeout(() => renderPlayerList(), 1500); // Redirigir a la lista despu√©s de guardar
        }
    }

    /**
     * Maneja el env√≠o del formulario de autorizaci√≥n.
     */
    async function handleAutorizacionSubmit(event) {
        event.preventDefault();
        const formAuth = document.getElementById('form-autorizacion');
        const messageDivId = 'auth-form-message';

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || !currentUser.id) {
            showTemporaryMessage(messageDivId, "Debes iniciar sesi√≥n para guardar una autorizaci√≥n.", true);
            return;
        }

        const autorizacionData = {
            apoderado_nombre: document.getElementById('apoderado-nombre').value,
            apoderado_ci: document.getElementById('apoderado-ci').value,
            jugador_nombre: document.getElementById('jugador-nombre-auth').value,
            parentesco: document.getElementById('parentesco').value,
            user_id: currentUser.id // ID de la tabla public.users
        };

        if (autorizacionData.parentesco === "") {
            showTemporaryMessage(messageDivId, "Por favor, seleccione un parentesco.", true);
            return;
        }

        const { error } = await supabaseClient.from('autorizaciones').insert([autorizacionData]);

        if (error) {
            console.error('[handleAutorizacionSubmit] Error al guardar autorizaci√≥n:', error);
            showTemporaryMessage(messageDivId, 'Error al guardar autorizaci√≥n: ' + error.message, true);
        } else {
            showTemporaryMessage(messageDivId, 'Autorizaci√≥n guardada exitosamente!', false);
            if (formAuth) formAuth.reset();
            setTimeout(() => renderPlayerList(), 1500);
        }
    }

    /**
 * Maneja el env√≠o del formulario de Poder Simple.
 */
async function handlePoderSimpleSubmit(event) {
    event.preventDefault();
    const formPoder = document.getElementById('form-poder-simple');
    const messageDivId = 'poder-simple-form-message';

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || !currentUser.id) {
        showTemporaryMessage(messageDivId, "Debes iniciar sesi√≥n para guardar un poder simple.", true);
        return;
    }

    const poderSimpleData = {
        nombre_autorizante: document.getElementById('poder-nombre-autorizante').value,
        ci_autorizante: document.getElementById('poder-ci-autorizante').value,
        nombre_hijo: document.getElementById('poder-nombre-hijo').value,
        ci_hijo: document.getElementById('poder-ci-hijo').value,
        fecha: document.getElementById('poder-fecha').value.split('-').reverse().join('-'),
        user_id: currentUser.id 
    };

    // Nota: Necesitar√°s crear una tabla en Supabase llamada "poderes_simples"
    const { error } = await supabaseClient.from('poderes_simples').insert([poderSimpleData]);

    if (error) {
        console.error('[handlePoderSimpleSubmit] Error al guardar poder simple:', error);
        showTemporaryMessage(messageDivId, 'Error al guardar poder simple: ' + error.message, true);
    } else {
        showTemporaryMessage(messageDivId, 'Poder Simple guardado exitosamente!', false);
        if (formPoder) formPoder.reset();
        setTimeout(() => renderPlayerList(), 1500);
    }
}
    /**
     * Maneja el env√≠o del formulario para agregar o editar usuarios.
     */
    async function handleAddUserSubmit(event) {
        event.preventDefault();
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'admin') {
            showTemporaryMessage('add-user-error', 'Acceso no autorizado para esta acci√≥n.', true);
            return;
        }

        const nombre_completo = document.getElementById('new-fullname').value.trim();
        const username_rut = document.getElementById('new-username').value.trim(); // RUT
        const password = document.getElementById('new-password').value;
        const role_public_users = document.getElementById('new-role').value; // Rol para public.users
        const errorDivId = 'add-user-error';
        const editPublicUserId = document.getElementById('edit-user-id').value;

        showTemporaryMessage(errorDivId, '', false, 0); // Limpiar mensajes previos

        if (!nombre_completo || !username_rut || !role_public_users) {
            showTemporaryMessage(errorDivId, 'Nombre Completo, Usuario (RUT) y Rol son requeridos.', true);
            return;
        }

        let password_hash = null;
        if (password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            password_hash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        if (editPublicUserId) { // MODO EDICI√ìN
            const publicUserUpdateData = {
                nombre_completo: nombre_completo,
                username: username_rut,
                role: role_public_users,
            };
             if (password_hash) { // Solo actualizar hash si se provey√≥ una nueva contrase√±a
                publicUserUpdateData.password_hash = password_hash;
            }

            const { error: updatePublicUserError } = await supabaseClient
                .from('users')
                .update(publicUserUpdateData)
                .eq('id', editPublicUserId);

            if (updatePublicUserError) {
                console.error("Error al actualizar usuario en public.users:", updatePublicUserError);
                showTemporaryMessage(errorDivId, 'Error al actualizar datos: ' + updatePublicUserError.message, true);
            } else {
                showTemporaryMessage(errorDivId, 'Usuario actualizado exitosamente.', false);
                setTimeout(() => renderUserManagementForm(), 1500);
            }
        } else { // MODO AGREGAR NUEVO USUARIO
            if (!password_hash) { // La contrase√±a es obligatoria para nuevos usuarios
                showTemporaryMessage(errorDivId, 'La clave es requerida para nuevos usuarios.', true);
                return;
            }

            const { error: insertPublicUserError } = await supabaseClient
                .from('users') // Tabla public.users
                .insert([{
                    username: username_rut, // RUT como username
                    password_hash: password_hash, // Hash de la contrase√±a
                    nombre_completo: nombre_completo,
                    role: role_public_users
                }]);

            if (insertPublicUserError) {
                console.error("Error al registrar usuario en public.users:", insertPublicUserError);
                 if (insertPublicUserError.message.includes('duplicate key value violates unique constraint')) {
                      showTemporaryMessage(errorDivId, 'Error: El usuario (RUT) ya existe.', true);
                 } else {
                    showTemporaryMessage(errorDivId, 'Error al registrar usuario: ' + insertPublicUserError.message, true);
                 }
            } else {
                showTemporaryMessage(errorDivId, 'Usuario registrado exitosamente.', false);
                setTimeout(() => renderUserManagementForm(), 1500);
            }
        }
    }

    /**
     * Rellena el formulario de usuario para edici√≥n.
     */
    async function populateUserEditForm(publicUserId) {
        const { data: user, error } = await supabaseClient.from('users').select('*').eq('id', publicUserId).single();
        if (error || !user) {
            showTemporaryMessage('add-user-error', 'No se pudo cargar el usuario para editar.', true);
            return;
        }
        document.getElementById('new-fullname').value = user.nombre_completo || '';
        document.getElementById('new-username').value = user.username; // RUT
        document.getElementById('new-password').value = ''; // Limpiar campo de contrase√±a
        document.getElementById('new-password').placeholder = 'Nueva Clave (o dejar en blanco)';
        document.getElementById('new-role').value = user.role || 'user';
        document.getElementById('edit-user-id').value = user.id; // ID de public.users

        document.getElementById('user-form-title').textContent = 'Editar Usuario';
        const submitButton = document.getElementById('user-submit-button');
        submitButton.classList.remove('bg-button-green-bg', 'hover:bg-button-green-hover-bg');
        submitButton.classList.add('edit-user-button'); // Estilo de bot√≥n de edici√≥n
        document.getElementById('user-submit-button-text').textContent = 'Guardar Cambios';
        document.getElementById('user-cancel-button').classList.remove('hidden');
        showTemporaryMessage('add-user-error', '', false, 0); // Limpiar mensaje de error
        document.getElementById('new-fullname').scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('new-fullname').focus();
    }

    /**
     * Resetea el formulario de agregar/editar usuario.
     */
    function resetUserForm() {
        const form = document.getElementById('form-add-user');
        if (form) form.reset();
        document.getElementById('edit-user-id').value = '';
        document.getElementById('user-form-title').textContent = 'Agregar Nuevo Usuario';
        const submitButton = document.getElementById('user-submit-button');
        if (submitButton) {
            submitButton.classList.remove('edit-user-button');
            submitButton.classList.add('bg-button-green-bg', 'hover:bg-button-green-hover-bg'); // Estilo por defecto
        }
        document.getElementById('user-submit-button-text').textContent = 'Agregar';
        document.getElementById('user-cancel-button').classList.add('hidden');
        const passwordInput = document.getElementById('new-password');
        if (passwordInput) passwordInput.placeholder = '(dejar en blanco para no cambiar al editar)';
        const roleInput = document.getElementById('new-role');
        if (roleInput) roleInput.value = 'user'; // Rol por defecto
        showTemporaryMessage('add-user-error', '', false, 0); // Limpiar mensaje de error
    }


    // =================================================================================
    // L√ìGICA ESPEC√çFICA: FOTO CARNET (CROPPER.JS, AJUSTES, GUARDADO)
    // =================================================================================

    function setupFotoCarnetListeners() {
        if (typeof Cropper === 'undefined') {
            console.error("Cropper no est√° definido. La funcionalidad de recorte de imagen no estar√° disponible.");
            const cropperContainer = document.querySelector('.cropper-container-wrapper');
            if (cropperContainer) {
                cropperContainer.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: La herramienta de recorte de imagen no pudo cargarse. Intente recargar la p√°gina.</p>';
            }
            const previewButton = document.getElementById('preview-foto-carnet-button');
            if (previewButton) previewButton.disabled = true;
            const saveButton = document.getElementById('save-foto-carnet-button');
            if (saveButton) saveButton.disabled = true;
            return;
        }
        const imageUpload = document.getElementById('image-upload');
        const previewButton = document.getElementById('preview-foto-carnet-button');
        const saveButton = document.getElementById('save-foto-carnet-button');
        const rutInput = document.getElementById('foto-rut');
        const textInputs = ['foto-nombres', 'foto-apellidos', 'foto-rut'];

        if (imageUpload) imageUpload.addEventListener('change', handleImageUploadWithCropper);
        if (previewButton) previewButton.addEventListener('click', () => generateFotoCarnetWithCropper(true)); // true para preview
        if (saveButton) saveButton.addEventListener('click', () => generateFotoCarnetWithCropper(false)); // false para guardar

        if (rutInput) {
            rutInput.addEventListener('input', () => {
                formatRut(rutInput);
                checkEnableFotoCarnetButtons();
            });
        }
        textInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', (e) => {
                    if (id !== 'foto-rut') e.target.value = e.target.value.toUpperCase();
                    checkEnableFotoCarnetButtons();
                });
            }
        });

        // Event listeners para los controles de ajuste de imagen de Foto Carnet
        document.getElementById('fcBrightness')?.addEventListener('input', (e) => {
            fc_currentAdjustments.brightness = parseInt(e.target.value);
            document.getElementById('fcBrightnessValue').textContent = e.target.value;
            if (cropperInstance && cropperInstance.canvasData) { // Solo regenerar si hay una imagen cargada y recortada
                 generateFotoCarnetWithCropper(true); // Actualizar preview
            }
        });
        document.getElementById('fcContrast')?.addEventListener('input', (e) => {
            fc_currentAdjustments.contrast = parseInt(e.target.value) / 100;
            document.getElementById('fcContrastValue').textContent = e.target.value;
            if (cropperInstance && cropperInstance.canvasData) {
                 generateFotoCarnetWithCropper(true);
            }
        });
        document.getElementById('fcSharpness')?.addEventListener('input', (e) => {
            fc_currentAdjustments.sharpness = parseInt(e.target.value);
            document.getElementById('fcSharpnessValue').textContent = e.target.value;
            if (cropperInstance && cropperInstance.canvasData) {
                 generateFotoCarnetWithCropper(true);
            }
        });
        checkEnableFotoCarnetButtons(); // Estado inicial de los botones
    }

    function checkEnableFotoCarnetButtons() {
        const previewButton = document.getElementById('preview-foto-carnet-button');
        const saveButton = document.getElementById('save-foto-carnet-button');

        const nombres = document.getElementById('foto-nombres')?.value.trim();
        const apellidos = document.getElementById('foto-apellidos')?.value.trim();
        const rut = document.getElementById('foto-rut')?.value.trim();
        const isCropperReady = cropperInstance !== null && typeof cropperInstance.getCroppedCanvas === 'function';
        const resultCanvas = document.getElementById('result-canvas');
        const isPreviewGenerated = resultCanvas && resultCanvas.style.display === 'block' && resultCanvas.width > 0;

        if (previewButton) {
            previewButton.disabled = !(isCropperReady && nombres && apellidos && rut);
        }
        if (saveButton) {
            saveButton.disabled = !(isPreviewGenerated && nombres && apellidos && rut);
        }
    }

    function handleImageUploadWithCropper(event) {
        const file = event.target.files[0];
        const imageElement = document.getElementById('cropper-image');
        const resultCanvas = document.getElementById('result-canvas');
        const canvasPlaceholder = document.getElementById('canvas-placeholder');

        if (cropperInstance) {
            try { cropperInstance.destroy(); } catch(e) { console.warn("Error al destruir Cropper:", e); }
            cropperInstance = null;
        }
        if (resultCanvas) { // Limpiar canvas de resultado previo
            const ctx = resultCanvas.getContext('2d');
            ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCanvas.style.display = 'none';
            if(canvasPlaceholder) canvasPlaceholder.style.display = 'block';
        }

        // Resetear sliders y valores de ajuste de Foto Carnet
        document.getElementById('fcBrightness').value = 0;
        document.getElementById('fcContrast').value = 100;
        document.getElementById('fcSharpness').value = 0;
        fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
        document.getElementById('fcBrightnessValue').textContent = '0';
        document.getElementById('fcContrastValue').textContent = '100';
        document.getElementById('fcSharpnessValue').textContent = '0';

        checkEnableFotoCarnetButtons(); // Actualizar estado de botones

        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageElement.src = e.target.result;
                imageElement.alt = "[Imagen del] Imagen cargada para recortar";
                if (typeof Cropper === 'undefined') {
                    const errorDiv = document.querySelector('.cropper-container-wrapper') || contentAreaElement;
                    if (errorDiv) errorDiv.innerHTML = '<p class="text-red-500 text-center font-bold p-2">Error: La librer√≠a de recorte no se carg√≥. Intente recargar.</p>';
                    return;
                }
                try {
                    cropperInstance = new Cropper(imageElement, {
                        aspectRatio: 3 / 4, // Proporci√≥n t√≠pica para foto carnet
                        viewMode: 1,¬† ¬† ¬† ¬† // Restringir el √°rea de recorte al canvas
                        dragMode: 'move',¬† ¬†// Mover la imagen, no el recorte
                        autoCropArea: 0.9,¬† // √Årea inicial del recorte
                        background: false,¬† // Sin fondo de grid en el cropper
                        zoomable: true,
                        movable: true,
                        cropBoxResizable: true,
                        ready: () => {
                            checkEnableFotoCarnetButtons();
                            generateFotoCarnetWithCropper(true); // Generar preview inicial
                        },
                        crop: () => { // Se dispara continuamente al recortar
                            generateFotoCarnetWithCropper(true); // Actualizar preview din√°micamente
                            checkEnableFotoCarnetButtons();
                        }
                    });
                } catch (error) {
                    const errorDiv = document.querySelector('.cropper-container-wrapper') || contentAreaElement;
                    if (errorDiv) errorDiv.innerHTML = `<p class="text-red-500 text-center font-bold p-2">Error al inicializar recorte: ${error.message}</p>`;
                    imageElement.src = ""; imageElement.alt = "[Imagen del] Error al cargar imagen.";
                }
            };
            reader.readAsDataURL(file);
        } else {
            imageElement.src = ""; // Limpiar si no es imagen
            imageElement.alt = " Sube una imagen para empezar.";
            if(file) { // Si se seleccion√≥ un archivo pero no es imagen
                 const errorDiv = document.querySelector('.cropper-container-wrapper') || contentAreaElement;
                 if (errorDiv) errorDiv.insertAdjacentHTML('afterbegin', '<p class="text-yellow-500 text-center font-bold p-2">Por favor, selecciona un archivo de imagen v√°lido (ej: JPG, PNG).</p>');
            }
            checkEnableFotoCarnetButtons();
        }
    }

    function fc_applyImageAdjustments(imageData) {
        if (!imageData) return;
        const pixels = imageData.data;
        const brightness = fc_currentAdjustments.brightness;
        const contrast = fc_currentAdjustments.contrast; // Ya est√° en formato decimal (ej. 1.0 para 100%)

        for (let i = 0; i < pixels.length; i += 4) {
            let r = pixels[i], g = pixels[i+1], b = pixels[i+2];
            // Aplicar contraste
            r = (r - 128) * contrast + 128;
            g = (g - 128) * contrast + 128;
            b = (b - 128) * contrast + 128;
            // Aplicar brillo
            r += brightness;
            g += brightness;
            b += brightness;
            // Asegurar que los valores est√©n en el rango [0, 255]
            pixels[i]¬† ¬†= Math.min(255, Math.max(0, r));
            pixels[i+1] = Math.min(255, Math.max(0, g));
            pixels[i+2] = Math.min(255, Math.max(0, b));
        }
        if (fc_currentAdjustments.sharpness > 0) {
            fc_applySharpness(imageData);
        }
    }

    function fc_applySharpness(imageData) {
        const sharpnessFactor = fc_currentAdjustments.sharpness / 100; // Convertir porcentaje a factor
        if (sharpnessFactor <= 0) return;

        // Kernel de nitidez simple (Laplaciano modificado)
        const center = 1 + 4 * sharpnessFactor;
        const surround = -0.5 * sharpnessFactor;

        const kernel = [
            surround, surround, surround,
            surround, center,¬† ¬†surround,
            surround, surround, surround
        ];

        const pixels = imageData.data;
        const width = imageData.width;
        const height = imageData.height;
        const tempData = new Uint8ClampedArray(pixels); // Copia para leer valores originales

        for (let y = 1; y < height - 1; y++) { // Evitar bordes
            for (let x = 1; x < width - 1; x++) {
                for (let c = 0; c < 3; c++) { // Para R, G, B (ignorar Alpha)
                    let sum = 0;
                    let ki = 0; // √çndice del kernel
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                            sum += tempData[idx] * kernel[ki++];
                        }
                    }
                    const idxCurrent = (y * width + x) * 4 + c;
                    pixels[idxCurrent] = Math.min(255, Math.max(0, sum));
                }
            }
        }
    }

    async function generateFotoCarnetWithCropper(isPreview = false) {
        if (!cropperInstance || typeof cropperInstance.getCroppedCanvas !== 'function') {
            if (!isPreview) showTemporaryMessage('foto-carnet-message', "Por favor, sube y ajusta una imagen primero.", true);
            return;
        }
        const nombres = document.getElementById('foto-nombres').value.trim();
        const apellidos = document.getElementById('foto-apellidos').value.trim();
        const rut = document.getElementById('foto-rut').value.trim();

        if (!isPreview && (!nombres || !apellidos || !rut)) { // Validar solo al guardar, no en preview
            showTemporaryMessage('foto-carnet-message', "Completa Nombres, Apellidos y RUT antes de guardar.", true);
            return;
        }

        let croppedCanvas;
        try {
            croppedCanvas = cropperInstance.getCroppedCanvas({
                width: 300, // Ancho de salida deseado para la imagen recortada
                imageSmoothingEnabled: true, // Mejor calidad
                imageSmoothingQuality: 'high',
            });
            if (!croppedCanvas || !croppedCanvas.width || !croppedCanvas.height) throw new Error("El √°rea recortada es inv√°lida o el cropper no est√° listo.");
        } catch (error) {
            if (!isPreview) showTemporaryMessage('foto-carnet-message', `Error al recortar: ${error.message}. Aseg√∫rate de que la imagen est√© cargada y haya un √°rea de recorte.`, true);
            console.error("Error en getCroppedCanvas:", error);
            return;
        }

        const resultCanvas = document.getElementById('result-canvas');
        const canvasPlaceholder = document.getElementById('canvas-placeholder');
        const ctx = resultCanvas.getContext('2d');

        // Canvas temporal para aplicar ajustes sin afectar el original del cropper
        const tempAdjustedCanvas = document.createElement('canvas');
        tempAdjustedCanvas.width = croppedCanvas.width;
        tempAdjustedCanvas.height = croppedCanvas.height;
        const tempAdjustedCtx = tempAdjustedCanvas.getContext('2d');
        tempAdjustedCtx.drawImage(croppedCanvas, 0, 0); // Dibujar la imagen recortada

        // Aplicar ajustes de brillo, contraste, etc.
        const imageData = tempAdjustedCtx.getImageData(0, 0, tempAdjustedCanvas.width, tempAdjustedCanvas.height);
        fc_applyImageAdjustments(imageData); // Aplicar ajustes a este imageData
        tempAdjustedCtx.putImageData(imageData, 0, 0); // Poner la imagen ajustada de nuevo en el canvas temporal

        // Configurar el canvas final (resultCanvas)
        const photoWidth = 300; // Ancho final de la foto carnet
        const photoHeight = 400; // Alto final de la foto carnet
        resultCanvas.width = photoWidth;
        resultCanvas.height = photoHeight;
        ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
        ctx.drawImage(tempAdjustedCanvas, 0, 0, resultCanvas.width, resultCanvas.height); // Dibujar la imagen ajustada y escalada

        // A√±adir texto si los campos est√°n completos (incluso en preview)
        if (nombres && apellidos && rut) {
            const textLineHeight = Math.max(22, photoWidth * 0.08); // Ajustar din√°micamente
            const textPaddingVertical = Math.max(15, photoWidth * 0.05);
            const fontSize = Math.max(20, photoWidth * 0.065);
            const numTextLines = 3; // Nombres, Apellidos, RUT
            const textStripHeight = (textLineHeight * numTextLines) + (textPaddingVertical * 2);

            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)'; // Fondo semi-transparente para el texto
            const stripY = resultCanvas.height - textStripHeight;
            ctx.fillRect(0, stripY, resultCanvas.width, textStripHeight);

            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const textBaseY = stripY + textPaddingVertical; // Y base para la primera l√≠nea
            const textY1 = textBaseY + (textLineHeight / 2);
            const textY2 = textY1 + textLineHeight;
            const textY3 = textY2 + textLineHeight;

            ctx.font = `bold ${fontSize}px Inter, sans-serif`;
            ctx.fillText(nombres.toUpperCase(), resultCanvas.width / 2, textY1);
            ctx.fillText(apellidos.toUpperCase(), resultCanvas.width / 2, textY2);
            ctx.font = `bold ${fontSize}px Inter, sans-serif`; // Puede ser diferente para el RUT si se desea
            ctx.fillText(rut.toUpperCase(), resultCanvas.width / 2, textY3);
        }

        resultCanvas.style.display = 'block';
        if(canvasPlaceholder) canvasPlaceholder.style.display = 'none';
        checkEnableFotoCarnetButtons(); // Habilitar bot√≥n de guardar si todo est√° listo

        if (isPreview) { // Si solo es preview, no guardar en Supabase
            return;
        }

        // L√≥gica de guardado (solo si no es preview y los datos son v√°lidos)
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || !currentUser.id) {
            showTemporaryMessage('foto-carnet-message', "Error de sesi√≥n. Intenta reingresar.", true);
            console.error("Error: currentUser o currentUser.id no disponible en generateFotoCarnetWithCropper");
            return;
        }

        const imagen_dataurl = resultCanvas.toDataURL('image/png');
        const fotoCarnetData = {
            user_id: currentUser.id, // ID del usuario de public.users
            nombre_completo_jugador: `${nombres} ${apellidos}`.trim(),
            rut_jugador: rut,
            imagen_dataurl: imagen_dataurl
        };

        const { data, error } = await supabaseClient
            .from('fotocarnets')
            .insert([fotoCarnetData]);

        if (error) {
            console.error("Error al guardar foto carnet en Supabase:", error);
            showTemporaryMessage('foto-carnet-message', `Error al guardar: ${error.message}`, true);
        } else {
            showTemporaryMessage('foto-carnet-message', "Foto carnet generada y guardada exitosamente.", false);
        }
    }


    // =================================================================================
    // L√ìGICA ESPEC√çFICA: C√âDULA DE IDENTIDAD (PERSPECTIVA, AJUSTES, PDF)
    // =================================================================================

    function initializeCedulaIdentidadLogic() {
        if (typeof numeric === 'undefined') {
            const cedulaSection = document.getElementById('cedula-identidad-section');
            if(cedulaSection) cedulaSection.innerHTML = '<p class="text-red-500 font-bold text-center p-4">Error: Falta la librer√≠a \'numeric.js\'. Recargue la p√°gina.</p>';
            return;
        }
        // Resetear variables globales de C√©dula
        ci_perspectiveImage = new Image();
        ci_perspectivePoints = [];
        ci_savedFoto1DataUrl = null;
        ci_savedFoto2DataUrl = null;
        ci_currentSelectedFoto = 'foto1';
        ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };

        ci_perspectiveOriginalCanvas = document.getElementById('ciPerspectiveOriginalCanvas');
        ci_perspectiveTransformedCanvas = document.getElementById('ciPerspectiveTransformedCanvas');
        if (!ci_perspectiveOriginalCanvas || !ci_perspectiveTransformedCanvas) {
            console.error("Error: Canvas de c√©dula no encontrado."); return;
        }
        ci_perspectiveCtxOriginal = ci_perspectiveOriginalCanvas.getContext('2d');
        ci_perspectiveCtxTransformed = ci_perspectiveTransformedCanvas.getContext('2d');

        document.getElementById('nombre-jugador-cedula')?.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
            ci_updatePDFButtonState();
        });
        document.getElementById('ciPerspectiveImageInput')?.addEventListener('change', ci_handleImageUpload);
        ci_perspectiveOriginalCanvas.addEventListener('click', ci_handleCanvasClick);
        document.getElementById('ci-perspective-save-btn')?.addEventListener('click', ci_saveImage);
        document.getElementById('ci-generate-cedula-pdf-btn')?.addEventListener('click', ci_generateAndSavePDF);
        document.getElementById('ci-perspective-reset-points-btn')?.addEventListener('click', () => {
            ci_perspectivePoints = [];
            ci_drawPerspectivePointsAndLines(); // Redibujar canvas original sin puntos
            if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
            const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
            // Resetear sliders
            document.getElementById('ciBrightness').value = 0;
            document.getElementById('ciContrast').value = 100;
            document.getElementById('ciSharpness').value = 0;
            document.getElementById('ciTemperature').value = 0;
            ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
            document.getElementById('ciBrightnessValue').textContent = '0';
            document.getElementById('ciContrastValue').textContent = '100';
            document.getElementById('ciSharpnessValue').textContent = '0';
            document.getElementById('ciTemperatureValue').textContent = '0';
        });
        document.querySelectorAll('input[name="fotoCedulaSelect"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                ci_currentSelectedFoto = e.target.value;
                ci_resetPerspectiveView(false); // No limpiar la imagen cargada, solo los puntos y el canvas transformado
                if (ci_perspectiveImage.src) ci_drawImage(); // Redibujar si hay imagen
            });
        });

        ['ciBrightness', 'ciContrast', 'ciSharpness', 'ciTemperature'].forEach(sliderId => {
            document.getElementById(sliderId)?.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                const spanId = sliderId + 'Value';
                document.getElementById(spanId).textContent = value;

                if (sliderId === 'ciContrast') ci_currentAdjustments.contrast = value / 100; // Convertir a decimal
                else ci_currentAdjustments[sliderId.replace('ci','').toLowerCase()] = value;

                // Solo aplicar si hay una imagen transformada
                if (ci_perspectiveTransformedCanvas.width > 0 && ci_perspectiveImage.src && ci_perspectivePoints.length === 4) {
                    ci_applyPerspectiveTransform(); // Esto ya incluye ci_applyCedulaImageAdjustments
                }
            });
        });

        const initialRadio = document.querySelector('input[name="fotoCedulaSelect"]:checked');
        if (initialRadio) ci_currentSelectedFoto = initialRadio.value;
        ci_updatePDFButtonState();
        ci_updateSavedImagesList(); // Mostrar placeholders si no hay im√°genes
    }

    function ci_handleImageUpload(e) {
        const file = e.target.files[0]; if (!file) return;
        if (!file.type.match('image.*')) {
            showTemporaryMessage('cedula-message', "Por favor, selecciona un archivo de imagen.", true);
            return;
        }
        if (file.size > 5 * 1024 * 1024) { // L√≠mite de 5MB
            showTemporaryMessage('cedula-message', "El archivo es demasiado grande (m√°ximo 5MB).", true);
            e.target.value = ''; // Limpiar el input
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            ci_perspectiveImage.onload = () => {
                ci_updateCanvasDimensions(); // Ajustar tama√±o del canvas original
                ci_drawImage(); // Dibujar la imagen en el canvas original
                document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'none', 'important');
                // Resetear estado para la nueva imagen
                ci_perspectivePoints = [];
                if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
                const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
                // Resetear sliders
                document.getElementById('ciBrightness').value = 0;
                document.getElementById('ciContrast').value = 100;
                document.getElementById('ciSharpness').value = 0;
                document.getElementById('ciTemperature').value = 0;
                ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
                document.getElementById('ciBrightnessValue').textContent = '0';
                document.getElementById('ciContrastValue').textContent = '100';
                document.getElementById('ciSharpnessValue').textContent = '0';
                document.getElementById('ciTemperatureValue').textContent = '0';
            };
            ci_perspectiveImage.onerror = () => {
                document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important');
                showTemporaryMessage('cedula-message', "Error al cargar la imagen. Intente con otro archivo.", true);
            }
            ci_perspectiveImage.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function ci_updateCanvasDimensions() {
        const container = document.getElementById('ciOriginalCanvasContainer');
        if (!container || !ci_perspectiveImage.width || !ci_perspectiveImage.height) return; // Asegurar que la imagen est√© cargada

        const aspectRatio = ci_perspectiveImage.width / ci_perspectiveImage.height;
        let newWidth = container.clientWidth;
        let newHeight = newWidth / aspectRatio;

        if (newHeight > container.clientHeight) {
            newHeight = container.clientHeight;
            newWidth = newHeight * aspectRatio;
        }
        if (ci_perspectiveOriginalCanvas) { // Asegurar que el canvas exista
            ci_perspectiveOriginalCanvas.width = newWidth;
            ci_perspectiveOriginalCanvas.height = newHeight;
        }
    }

    function ci_drawImage() {
        if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas || !ci_perspectiveImage.src) return;
        ci_perspectiveCtxOriginal.clearRect(0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
        // Dibujar la imagen escalada para que quepa en el canvas
        ci_perspectiveCtxOriginal.drawImage(ci_perspectiveImage, 0, 0, ci_perspectiveImage.width, ci_perspectiveImage.height, 0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
    }

    function ci_handleCanvasClick(e) {
        if (ci_perspectivePoints.length >= 4 || !ci_perspectiveImage.src || !ci_perspectiveOriginalCanvas) return;
        const rect = ci_perspectiveOriginalCanvas.getBoundingClientRect();
        // Escalar coordenadas del click al tama√±o real del canvas (no el tama√±o mostrado)
        const scaleX = ci_perspectiveOriginalCanvas.width / rect.width;
        const scaleY = ci_perspectiveOriginalCanvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        ci_perspectivePoints.push({ x, y });
        ci_drawPerspectivePointsAndLines();

        if (ci_perspectivePoints.length === 4) {
            ci_applyPerspectiveTransform();
            const saveButton = document.getElementById('ci-perspective-save-btn'); if (saveButton) saveButton.disabled = false;
        }
    }

    function ci_drawPerspectivePointsAndLines() {
        if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas) return;
        ci_drawImage(); // Redibujar la imagen base primero

        ci_perspectiveCtxOriginal.strokeStyle = 'rgba(255,0,0,0.9)'; // Rojo brillante para l√≠neas y puntos
        ci_perspectiveCtxOriginal.lineWidth = 2; // Grosor de l√≠nea
        ci_perspectiveCtxOriginal.fillStyle = 'rgba(255,0,0,0.7)'; // Relleno de puntos

        ci_perspectivePoints.forEach((p, i) => {
            ci_perspectiveCtxOriginal.beginPath(); // Iniciar nuevo trazo para el c√≠rculo
            ci_perspectiveCtxOriginal.arc(p.x, p.y, 6, 0, Math.PI*2); // C√≠rculo m√°s grande
            ci_perspectiveCtxOriginal.fill(); // Rellenar el c√≠rculo
            ci_perspectiveCtxOriginal.stroke(); // Contorno del c√≠rculo

            if (i > 0) { // Dibujar l√≠nea al punto anterior
                ci_perspectiveCtxOriginal.beginPath(); // Iniciar nuevo trazo para la l√≠nea
                ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[i-1].x, ci_perspectivePoints[i-1].y);
                ci_perspectiveCtxOriginal.lineTo(p.x, p.y);
                ci_perspectiveCtxOriginal.stroke();
            }
        });
        if (ci_perspectivePoints.length === 4) { // Cerrar el pol√≠gono
            ci_perspectiveCtxOriginal.beginPath();
            ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[3].x, ci_perspectivePoints[3].y);
            ci_perspectiveCtxOriginal.lineTo(ci_perspectivePoints[0].x, ci_perspectivePoints[0].y);
            ci_perspectiveCtxOriginal.stroke();
        }
    }

    // Definici√≥n de ci_applySharpness (basada en fc_applySharpness pero usando ci_currentAdjustments)
    function ci_applySharpness(imageData) {
        const sharpnessFactor = ci_currentAdjustments.sharpness / 100; // Usar ci_currentAdjustments
        if (sharpnessFactor <= 0) return;

        const center = 1 + 4 * sharpnessFactor;
        const surround = -0.5 * sharpnessFactor;
        const kernel = [
            surround, surround, surround,
            surround, center,¬† ¬†surround,
            surround, surround, surround
        ];

        const pixels = imageData.data;
        const width = imageData.width;
        const height = imageData.height;
        const tempData = new Uint8ClampedArray(pixels);

        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                for (let c = 0; c < 3; c++) {
                    let sum = 0;
                    let ki = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                            sum += tempData[idx] * kernel[ki++];
                        }
                    }
                    const idxCurrent = (y * width + x) * 4 + c;
                    pixels[idxCurrent] = Math.min(255, Math.max(0, sum));
                }
            }
        }
    }


    async function ci_applyPerspectiveTransform() {
        if (ci_perspectivePoints.length < 4 || !ci_perspectiveImage.src || !numeric) return;

        const orderedPoints = ci_orderPoints(ci_perspectivePoints);
        if (!orderedPoints || orderedPoints.some(p => p === undefined)) {
            showTemporaryMessage('cedula-message', "Error al ordenar puntos. Intente de nuevo.", true);
            ci_perspectivePoints = []; ci_drawPerspectivePointsAndLines(); return; // Resetear puntos
        }

        // Mapear puntos del canvas original (escalados) a puntos de la imagen original
        const srcPoints = orderedPoints.map(p => ({
            x: (p.x / ci_perspectiveOriginalCanvas.width) * ci_perspectiveImage.width,
            y: (p.y / ci_perspectiveOriginalCanvas.height) * ci_perspectiveImage.height
        }));

        const dstPoints = [
            {x:0, y:0}, {x:CI_FINAL_WIDTH, y:0},
            {x:CI_FINAL_WIDTH, y:CI_FINAL_HEIGHT}, {x:0, y:CI_FINAL_HEIGHT}
        ];

        try {
            const matrix = ci_computePerspectiveMatrix(srcPoints, dstPoints);
            if (!matrix) { // Error en c√°lculo de matriz (e.g. puntos colineales)
                showTemporaryMessage('cedula-message', "Error al calcular transformaci√≥n. Verifique los puntos seleccionados (no deben ser colineales).", true);
                return;
            }

            // Usar un canvas temporal para obtener los p√≠xeles de la imagen original
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = ci_perspectiveImage.width; // Tama√±o real de la imagen
            tempCanvas.height = ci_perspectiveImage.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(ci_perspectiveImage, 0, 0); // Dibujar imagen original en canvas temporal

            // Configurar el canvas transformado
            ci_perspectiveTransformedCanvas.width = CI_FINAL_WIDTH;
            ci_perspectiveTransformedCanvas.height = CI_FINAL_HEIGHT;
            ci_perspectiveCtxTransformed.clearRect(0,0,CI_FINAL_WIDTH,CI_FINAL_HEIGHT);

            const imgData = ci_perspectiveCtxTransformed.createImageData(CI_FINAL_WIDTH,CI_FINAL_HEIGHT); // Para el canvas transformado
            const pixels = imgData.data;
            const invMatrix = numeric.inv(matrix); // Invertir matriz para mapeo inverso

            for (let y = 0; y < CI_FINAL_HEIGHT; y++) {
                for (let x = 0; x < CI_FINAL_WIDTH; x++) {
                    const pDest = [x, y, 1]; // Coordenada homog√©nea en el canvas destino
                    const pSrcHom = numeric.dot(invMatrix, pDest); // Mapear al canvas origen
                    const srcX = pSrcHom[0] / pSrcHom[2];
                    const srcY = pSrcHom[1] / pSrcHom[2];

                    if (srcX >= 0 && srcX < ci_perspectiveImage.width && srcY >= 0 && srcY < ci_perspectiveImage.height) {
                        // Obtener p√≠xel de la imagen original (del canvas temporal)
                        const srcPixelData = tempCtx.getImageData(Math.floor(srcX), Math.floor(srcY), 1, 1).data;
                        const destIdx = (y * CI_FINAL_WIDTH + x) * 4;
                        pixels[destIdx]¬† ¬†= srcPixelData[0]; // R
                        pixels[destIdx+1] = srcPixelData[1]; // G
                        pixels[destIdx+2] = srcPixelData[2]; // B
                        pixels[destIdx+3] = 255;¬† ¬† ¬† ¬† ¬† ¬† ¬†// Alpha
                    }
                }
            }
            ci_perspectiveCtxTransformed.putImageData(imgData, 0, 0); // Poner los p√≠xeles transformados
            ci_applyCedulaImageAdjustments(); // Aplicar ajustes de brillo/contraste a la imagen transformada

        } catch(err) {
            showTemporaryMessage('cedula-message', `Error en transformaci√≥n: ${err.message}. Verifique los puntos.`, true);
            console.error("Error en ci_applyPerspectiveTransform:", err);
        }
    }

    function ci_applyCedulaImageAdjustments() {
        if (!ci_perspectiveTransformedCanvas || ci_perspectiveTransformedCanvas.width === 0) return;
        const imageData = ci_perspectiveCtxTransformed.getImageData(0, 0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
        const pixels = imageData.data;

        const brightness = ci_currentAdjustments.brightness;
        const contrast = ci_currentAdjustments.contrast; // Ya es decimal

        for (let i = 0; i < pixels.length; i += 4) {
            let r = pixels[i], g = pixels[i+1], b = pixels[i+2];
            // Aplicar contraste
            r = (r - 128) * contrast + 128;
            g = (g - 128) * contrast + 128;
            b = (b - 128) * contrast + 128;
            // Aplicar brillo
            r += brightness;
            g += brightness;
            b += brightness;
            pixels[i]¬† ¬†= Math.min(255, Math.max(0, r));
            pixels[i+1] = Math.min(255, Math.max(0, g));
            pixels[i+2] = Math.min(255, Math.max(0, b));
        }

        // Aplicar ajuste de temperatura
        const tempAdjust = ci_currentAdjustments.temperature;
        for (let i = 0; i < pixels.length; i += 4) {
            pixels[i]¬† ¬†= Math.min(255, Math.max(0, pixels[i] + tempAdjust));¬† ¬†// Aumentar rojo
            pixels[i+2] = Math.min(255, Math.max(0, pixels[i+2] - tempAdjust)); // Disminuir azul
        }

        if (ci_currentAdjustments.sharpness > 0) {
            ci_applySharpness(imageData); // Usar la funci√≥n definida ci_applySharpness
        }
        ci_perspectiveCtxTransformed.putImageData(imageData, 0, 0);
    }

    function ci_computePerspectiveMatrix(src, dst) {
        const A = [], B = [];
        for(let i = 0; i < 4; i++) {
            const x = src[i].x, y = src[i].y, u = dst[i].x, v = dst[i].y;
            A.push([x, y, 1, 0, 0, 0, -u*x, -u*y]);
            A.push([0, 0, 0, x, y, 1, -v*x, -v*y]);
            B.push(u); B.push(v);
        }
        try {
            const X = numeric.solve(A, B); // Resolver sistema de ecuaciones lineales
            return [[X[0],X[1],X[2]], [X[3],X[4],X[5]], [X[6],X[7],1]]; // Matriz de transformaci√≥n 3x3
        } catch(e) {
            console.error("Error en numeric.solve (posiblemente puntos colineales):", e);
            // No mostrar mensaje aqu√≠, se maneja en ci_applyPerspectiveTransform
            return null;
        }
    }

    function ci_orderPoints(points) {
        // Ordenar puntos: tl, tr, br, bl
        // Suma de coordenadas para tl (m√≠nima) y br (m√°xima)
        points.sort((a, b) => (a.x + a.y) - (b.x + b.y));
        let [tl, p2, p3, br] = points;

        // Diferencia de coordenadas para tr (y-x m√≠nima) y bl (y-x m√°xima) entre los dos restantes
        let others = [p2, p3].sort((a, b) => (a.y - a.x) - (b.y - b.x)); // tr tendr√° y-x m√°s peque√±o
        let tr = others[0], bl = others[1];

        if ([tl, tr, br, bl].some(p => p === undefined)) {
            // Fallback si la ordenaci√≥n simple falla (e.g., forma muy irregular)
            // Ordenar por √°ngulo respecto al centroide (puede no ser siempre correcto para rect√°ngulos distorsionados)
            console.warn("Fallback de ordenaci√≥n de puntos para C√©dula. Puede no ser preciso.");
            const center = points.reduce((acc,p)=>({x:acc.x+p.x/4, y:acc.y+p.y/4}),{x:0,y:0});
            return points.sort((a,b)=>Math.atan2(a.y-center.y,a.x-center.x) - Math.atan2(b.y-center.y,b.x-center.x));
        }
        return [tl, tr, br, bl];
    }

    function ci_saveImage() {
        if (!ci_perspectiveTransformedCanvas || ci_perspectiveTransformedCanvas.width === 0) {
            showTemporaryMessage('cedula-message', "No hay imagen corregida para guardar.", true);
            return;
        }
        const dataUrl = ci_perspectiveTransformedCanvas.toDataURL('image/png');
        if (ci_currentSelectedFoto === 'foto1') ci_savedFoto1DataUrl = dataUrl;
        else ci_savedFoto2DataUrl = dataUrl;

        ci_updateSavedImagesList();
        ci_updatePDFButtonState();

        // Limpiar para la siguiente foto
        const imageInput = document.getElementById('ciPerspectiveImageInput'); if(imageInput) imageInput.value = ''; // Resetear input de archivo
        ci_resetPerspectiveView(true); // Limpiar canvas y puntos

        // Cambiar al siguiente radio button si es necesario
        if (ci_currentSelectedFoto === 'foto1' && !ci_savedFoto2DataUrl) { // Si se guard√≥ anverso y falta reverso
            const radioFoto2 = document.querySelector('input[name="fotoCedulaSelect"][value="foto2"]');
            if (radioFoto2) radioFoto2.checked = true;
            ci_currentSelectedFoto = 'foto2';
        } else if (ci_currentSelectedFoto === 'foto2' && !ci_savedFoto1DataUrl) { // Si se guard√≥ reverso y falta anverso
            const radioFoto1 = document.querySelector('input[name="fotoCedulaSelect"][value="foto1"]');
            if (radioFoto1) radioFoto1.checked = true;
            ci_currentSelectedFoto = 'foto1';
        }
        showTemporaryMessage('cedula-message', "Imagen corregida guardada temporalmente.", false);
    }

    function ci_updateSavedImagesList() {
        const container = document.getElementById('ciSavedImagesList'); if (!container) return;
        container.innerHTML = ''; // Limpiar contenedor
        const placeholderStyle = "width:120px;height:100px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border-input);border-radius:0.375rem;background-color:var(--bg-primary);";

        container.innerHTML += ci_savedFoto1DataUrl ?
            `<div class="saved-image-item"><img src="${ci_savedFoto1DataUrl}" class="saved-image-preview" alt="[Imagen del] Anverso C√©dula"><p class="text-sm text-primary mt-1">Anverso</p></div>` :
            `<div class="saved-image-item" style="${placeholderStyle}"><span class="text-xs text-secondary">Anverso (Vac√≠o)</span></div>`;
        container.innerHTML += ci_savedFoto2DataUrl ?
            `<div class="saved-image-item"><img src="${ci_savedFoto2DataUrl}" class="saved-image-preview" alt="[Imagen del] Reverso C√©dula"><p class="text-sm text-primary mt-1">Reverso</p></div>` :
            `<div class="saved-image-item" style="${placeholderStyle}"><span class="text-xs text-secondary">Reverso (Vac√≠o)</span></div>`;
    }

    async function ci_generateAndSavePDF() {
        const nombreJugadorInput = document.getElementById('nombre-jugador-cedula');
        const nombre_jugador = nombreJugadorInput?.value.trim().toUpperCase();

        if (!nombre_jugador) {
            showTemporaryMessage('cedula-message', "Por favor, ingresa el nombre del jugador.", true);
            nombreJugadorInput?.focus();
            return;
        }
        if (!ci_savedFoto1DataUrl || !ci_savedFoto2DataUrl) {
            showTemporaryMessage('cedula-message', "Debe guardar ambas caras de la c√©dula primero.", true);
            return;
        }
        if (!PDFLib || !PDFLib.PDFDocument) { // Asegurar que PDFLib est√© cargado
            showTemporaryMessage('cedula-message', "Librer√≠a PDF no lista. Intente de nuevo.", true);
            return;
        }
        const { PDFDocument } = PDFLib;

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || !currentUser.id) {
            showTemporaryMessage('cedula-message', "Error de sesi√≥n. Intenta reingresar.", true);
            console.error("Error: currentUser o currentUser.id no disponible en ci_generateAndSavePDF");
            return;
        }

        try {
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([595, 842]); // Tama√±o A4 (aproximado en puntos)
            const margin = 50;
            const imageDisplayWidth = 290; // Ancho para mostrar las im√°genes en el PDF

            // Anverso
            const anversoBytes = await fetch(ci_savedFoto1DataUrl).then(r=>r.arrayBuffer());
            const anversoImg = await pdfDoc.embedPng(anversoBytes);
            const anversoDims = anversoImg.scaleToFit(imageDisplayWidth, (imageDisplayWidth / CI_FINAL_WIDTH) * CI_FINAL_HEIGHT);
            page.drawImage(anversoImg, {
                x: margin,
                y: page.getHeight() - margin - anversoDims.height,
                width: anversoDims.width,
                height: anversoDims.height
            });
            page.drawText(`Anverso C√©dula - ${nombre_jugador}`, {x:margin, y:page.getHeight()-margin-anversoDims.height-15, size:10});

            // Reverso
            const reversoBytes = await fetch(ci_savedFoto2DataUrl).then(r=>r.arrayBuffer());
            const reversoImg = await pdfDoc.embedPng(reversoBytes);
            const reversoDims = reversoImg.scaleToFit(imageDisplayWidth, (imageDisplayWidth / CI_FINAL_WIDTH) * CI_FINAL_HEIGHT);
            page.drawImage(reversoImg, {
                x: margin,
                y: page.getHeight() - margin - anversoDims.height - 30 - reversoDims.height, // Espacio entre im√°genes
                width: reversoDims.width,
                height: reversoDims.height
            });
            page.drawText(`Reverso C√©dula - ${nombre_jugador}`, {x:margin, y:page.getHeight()-margin-anversoDims.height-30-reversoDims.height-15, size:10});

            const pdf_dataurl = await pdfDoc.saveAsBase64({ dataUri: true });

            const cedulaData = {
                user_id: currentUser.id, // ID del usuario de public.users
                nombre_jugador: nombre_jugador,
                pdf_dataurl: pdf_dataurl
            };
            const { data, error } = await supabaseClient
                .from('cedulas_identidad')
                .insert([cedulaData]);

            if (error) {
                console.error("Error al guardar PDF de c√©dula en Supabase:", error);
                showTemporaryMessage('cedula-message', `Error al guardar PDF: ${error.message}`, true);
            } else {
                showTemporaryMessage('cedula-message', "PDF de c√©dula generado y guardado exitosamente.", false);
            }

        } catch(e) {
            showTemporaryMessage('cedula-message', `Error al generar PDF: ${e.message}`, true);
            console.error("Error en ci_generateAndSavePDF:", e);
        }
    }

    function ci_updatePDFButtonState() {
        const btn = document.getElementById('ci-generate-cedula-pdf-btn');
        const nombreJugador = document.getElementById('nombre-jugador-cedula')?.value.trim();
        if(btn) btn.disabled = !(ci_savedFoto1DataUrl && ci_savedFoto2DataUrl && nombreJugador);
    }

    function ci_resetPerspectiveView(clearFullImage = true) {
        // --- INICIO DE LA CORRECCI√ìN ---
        // Desactivamos los listeners de la imagen para que no den falsas alarmas al limpiar.
        if (ci_perspectiveImage) {
            ci_perspectiveImage.onload = null;
            ci_perspectiveImage.onerror = null;
        }
        // --- FIN DE LA CORRECCI√ìN ---

        if (clearFullImage && ci_perspectiveImage) {
            ci_perspectiveImage.src = ''; // Limpiar la imagen cargada
            document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important');
        }
        if (ci_perspectiveOriginalCanvas && ci_perspectiveCtxOriginal && clearFullImage) {
            ci_perspectiveCtxOriginal.clearRect(0,0,ci_perspectiveOriginalCanvas.width,ci_perspectiveOriginalCanvas.height);
        }
        ci_perspectivePoints = [];
        if (ci_perspectiveTransformedCanvas && ci_perspectiveCtxTransformed) {
            ci_perspectiveCtxTransformed.clearRect(0,0,ci_perspectiveTransformedCanvas.width,ci_perspectiveTransformedCanvas.height);
        }
        const saveBtn = document.getElementById('ci-perspective-save-btn'); if(saveBtn) saveBtn.disabled = true;

        // Si no se limpia la imagen completa (ej. al cambiar radio button), pero hay imagen, redibujarla
        if (!clearFullImage && ci_perspectiveImage.src && ci_perspectiveCtxOriginal) {
            ci_drawImage();
        }
        ci_updatePDFButtonState(); // Actualizar estado del bot√≥n PDF
    }


    // =================================================================================
    // GENERACI√ìN DE PDFS (Tr√°mite y Autorizaci√≥n)
    // =================================================================================

    async function generatePdf(type, id) {
    // Limpiar el mensaje temporal de la UI y configurar la funci√≥n para mostrar mensajes
    let tempMessageDiv = document.getElementById('global-temp-message');
    if (!tempMessageDiv) {
        tempMessageDiv = document.createElement('div');
        tempMessageDiv.id = 'global-temp-message';
        tempMessageDiv.className = 'text-sm p-2 text-center fixed top-4 left-1/2 -translate-x-1/2 rounded shadow-lg z-[1001]';
        document.body.appendChild(tempMessageDiv);
    }
    const showTempGlobalMessage = (message, isError = false) => {
        tempMessageDiv.textContent = message;
        tempMessageDiv.className = `text-sm p-2 text-center fixed top-4 left-1/2 -translate-x-1/2 rounded shadow-lg z-[1001] ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        tempMessageDiv.style.display = 'block';
        setTimeout(() => { tempMessageDiv.style.display = 'none'; }, 4000);
    };

    try {
        if (typeof PDFLib === 'undefined' || !PDFLib.PDFDocument) {
            throw new Error("La librer√≠a PDF (PDFLib) no est√° cargada.");
        }
        const { PDFDocument, TextAlignment, StandardFonts } = PDFLib;
        
        const urlTramite = "https://zkak0.github.io/BotafogoApp/tramite_individual.pdf";
        const urlAutorizacion = "https://zkak0.github.io/BotafogoApp/autorizacion_jugadores.pdf";
        const urlPoderSimple = "https://zkak0.github.io/BotafogoApp/podersimple_botafogo.pdf";
        
        let pdfUrlToLoad, dataToFill, outputFilename;

        // 1. Obtener los datos correctos de Supabase
        if (type === 'tramite') {
            const { data, error } = await supabaseClient.from('players').select('*').eq('id', id).single();
            if (error || !data) throw new Error(`Tr√°mite no encontrado. Error DB: ${error?.message}`);
            dataToFill = data; pdfUrlToLoad = urlTramite;
            outputFilename = `tramite_${(data.ci || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        } else if (type === 'autorizacion') {
            const { data, error } = await supabaseClient.from('autorizaciones').select('*').eq('id', id).single();
            if (error || !data) throw new Error(`Autorizaci√≥n no encontrada. Error DB: ${error?.message}`);
            dataToFill = data; pdfUrlToLoad = urlAutorizacion;
            outputFilename = `autorizacion_${(data.jugador_nombre || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        } else if (type === 'poder_simple') {
            const { data, error } = await supabaseClient.from('poderes_simples').select('*').eq('id', id).single();
            if (error || !data) throw new Error(`Poder Simple no encontrado. Error DB: ${error?.message}`);
            dataToFill = data; pdfUrlToLoad = urlPoderSimple;
            outputFilename = `poder_simple_${(data.nombre_hijo || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        } else {
            throw new Error(`Tipo de PDF desconocido: '${type}'.`);
        }

        // 2. Descargar y cargar la plantilla PDF
        const existingPdfBytes = await fetch(pdfUrlToLoad).then(res => {
            if (!res.ok) throw new Error(`Error al descargar la plantilla PDF. Estado: ${res.status}`);
            return res.arrayBuffer();
        });
        
        const pdfDoc = await PDFDocument.load(existingPdfBytes);
        const form = pdfDoc.getForm();

        // 3. Rellenar los campos del PDF seg√∫n el tipo
        if (type === 'poder_simple') {
            // --- INICIO DE LA CORRECCI√ìN PARA PODER SIMPLE ---
            const fieldMapPoderSimple = {
                'Autorizante': dataToFill.nombre_autorizante,
                'Cedula_autorizante': dataToFill.ci_autorizante,
                'Jugador': dataToFill.nombre_hijo,
                'Cedula_jugador': dataToFill.ci_hijo,
        // --- L√çNEA MODIFICADA ---
        // Ahora usamos la nueva funci√≥n para formatear la fecha
                'Fecha_doc': formatDateToLongSpanish(dataToFill.fecha)
        };
            
            Object.keys(fieldMapPoderSimple).forEach(fieldName => {
                try {
                    const field = form.getTextField(fieldName);
                    field.setText(fieldMapPoderSimple[fieldName] || '');
                    field.setAlignment(TextAlignment.Center); // Centrar el texto
                } catch (e) { console.warn(`Campo no encontrado en PDF Poder Simple: '${fieldName}'`); }
            });
            // --- FIN DE LA CORRECCI√ìN ---
        } else {
            // L√≥gica existente para los otros formularios
            const fieldMap = type === 'tramite' ? {
                ci: 'CEDULA IDENTIDAD', fechaNac: 'FECHA NAC', apellidoPaterno: 'APELLIDO PATERNO',
                apellidoMaterno: 'APELLIDO MATERNO', nombres: 'NOMBRES', procedeClub: 'PROCEDE DEL CLUB',
                procedeAsociacion: 'ASOCIACION', solicita_inscripcion: 'INSCRIPCION',
                solicita_pase_interno: 'PASE INTERNO', solicita_pase_regional: 'PASE REGIONAL',
                solicita_pase_externo: 'PASE EXTERNO', categoria_extranjero: 'EXTRANJERO',
                categoria_libertad: 'LIBERTAD ACCION', categoria_adulto: 'ADULTO',
                categoria_femenina: 'FEMENINA', categoria_infantil: 'INFANTIL'
            } : {
                nombreAutorizante: 'NOMBRE AUTORIZANTE', cedulaIdentidad: 'CEDULA IDENTIDAD',
                nombreJugador: 'NOMBRE JUGADOR', parentesco: 'PARENTESCO'
            };
            const dataForPdf = type === 'tramite' ? {
                ci: dataToFill.ci, fechaNac: dataToFill.fecha_nac, apellidoPaterno: dataToFill.apellido_paterno,
                apellidoMaterno: dataToFill.apellido_materno, nombres: dataToFill.nombres,
                procedeClub: dataToFill.procede_club, procedeAsociacion: dataToFill.procede_asociacion,
                solicita_inscripcion: dataToFill.solicita_inscripcion, solicita_pase_interno: dataToFill.solicita_pase_interno,
                solicita_pase_regional: dataToFill.solicita_pase_regional, solicita_pase_externo: dataToFill.solicita_pase_externo,
                categoria_extranjero: dataToFill.categoria_extranjero, categoria_libertad: dataToFill.categoria_libertad,
                categoria_adulto: dataToFill.categoria_adulto, categoria_femenina: dataToFill.categoria_femenina,
                categoria_infantil: dataToFill.categoria_infantil
            } : {
                nombreAutorizante: dataToFill.apoderado_nombre, cedulaIdentidad: dataToFill.apoderado_ci,
                nombreJugador: dataToFill.jugador_nombre, parentesco: dataToFill.parentesco
            };
            
            Object.keys(fieldMap).forEach(key => {
                try {
                    const field = form.getTextField(fieldMap[key]);
                    field.setText((dataForPdf[key] || '').toString());
                    field.setAlignment(TextAlignment.Center);
                } catch (e) { console.warn(`Campo no encontrado o error al rellenar '${fieldMap[key]}': ${e.message}`); }
            });
        }
        
        try { form.flatten(); } catch (e) { console.warn("Error al aplanar el PDF (flatten):", e); }
        
        // 4. Guardar y descargar el PDF
        const pdfBytes = await pdfDoc.save();
        const blobUrl = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
        downloadDataUrlAsPdf(blobUrl, outputFilename);
        URL.revokeObjectURL(blobUrl);

        showTempGlobalMessage("PDF generado exitosamente.", false);

    } catch (error) {
        console.error("--- ERROR DETECTADO ---", error);
        showTempGlobalMessage(`Error al generar PDF: ${error.message}`, true);
    }
}

    // =================================================================================
    // INICIALIZACI√ìN Y LISTENERS GLOBALES
    // =================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Registrar helpers de Handlebars
        Handlebars.registerHelper('eq', (a, b) => a === b);

        // Cachear elementos del DOM
        let topLogoutBtn;
        loginScreen = document.getElementById('login-screen');
        appScreen = document.getElementById('app-screen');
        mainTitleElement = document.getElementById('main-title');
        contentAreaElement = document.getElementById('content-area');
        sidebarElement = document.getElementById('sidebar');
        loginFormElement = document.getElementById('login-form');
        usernameLoginInput = document.getElementById('username');
        loginErrorMessage = document.getElementById('login-error-message');
        menuTramiteLink = document.getElementById('menu-tramite');
        menuAutorizacionLink = document.getElementById('menu-autorizacion');
        menuUsuariosLink = document.getElementById('menu-usuarios');
        menuListaLink = document.getElementById('menu-lista');
        menuFotoCarnetLink = document.getElementById('menu-fotocarnet');
        menuCedulaIdentidadLink = document.getElementById('menu-cedula-identidad');
        menuPoderSimpleLink = document.getElementById('menu-poder-simple');
        collapseToggleBtn = document.getElementById('collapse-toggle');
        logoutBtn = document.getElementById('logout-button');
        darkModeToggleBtn = document.getElementById('dark-mode-toggle');
        topLogoutBtn = document.getElementById('top-logout-button');
        deleteConfirmModal = document.getElementById('delete-confirm-modal');
        confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        htmlTagElement = document.documentElement;
        darkModeIconElement = darkModeToggleBtn?.querySelector('i');

        // Listeners de Modales
        if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', proceedWithDeletion);
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', hideDeleteConfirmModal);

        // Configurar Dark Mode
        setupDarkMode();

        // Listener del Formulario de Login
        if (loginFormElement) loginFormElement.addEventListener('submit', handleLoginSubmit);
        if (usernameLoginInput) usernameLoginInput.addEventListener('input', () => formatLoginUsername(usernameLoginInput));

        // Listeners del Men√∫
        if (menuTramiteLink) menuTramiteLink.addEventListener('click', (e) => { e.preventDefault(); renderTramiteForm(); });
        if (menuAutorizacionLink) menuAutorizacionLink.addEventListener('click', (e) => { e.preventDefault(); renderAutorizacionForm(); });
        if (menuUsuariosLink) menuUsuariosLink.addEventListener('click', (e) => { e.preventDefault(); renderUserManagementForm(); });
        if (menuListaLink) menuListaLink.addEventListener('click', (e) => { e.preventDefault(); renderPlayerList(); });
        if (menuFotoCarnetLink) menuFotoCarnetLink.addEventListener('click', (e) => { e.preventDefault(); renderFotoCarnetForm(); });
        if (menuCedulaIdentidadLink) menuCedulaIdentidadLink.addEventListener('click', (e) => { e.preventDefault(); renderCedulaIdentidadForm(); });
        if (menuPoderSimpleLink) menuPoderSimpleLink.addEventListener('click', (e) => { e.preventDefault(); renderPoderSimpleForm(); });

        // Listeners de UI General
        if (collapseToggleBtn) collapseToggleBtn.addEventListener('click', toggleSidebar);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        if (topLogoutBtn) topLogoutBtn.addEventListener('click', handleLogout);

        // Listener de Eventos en Content Area (Delegaci√≥n)
        if (contentAreaElement) {
            contentAreaElement.addEventListener('click', async (event) => {
                const targetButton = event.target.closest('button.delete-btn, button.action-button[data-action="generate-pdf"], button.action-button[data-action="edit"]');
                if (!targetButton) return;

                const action = targetButton.dataset.action;
                const type = targetButton.dataset.type;
                const id = targetButton.dataset.id;
                const name = targetButton.dataset.name || `elemento ID ${id ? (typeof id === 'string' ? id.substring(0,8) + "..." : id) : "desconocido"}`;

                if (action === 'delete') {
                    if (type === 'user' && id) { showDeleteConfirmModal(id, 'user', name); } // id es username_rut
                    else if (type === 'tramite' && id) { showDeleteConfirmModal(id, 'tramite', name); }
                    else if (type === 'autorizacion' && id) { showDeleteConfirmModal(id, 'autorizacion', name); }
                    else if (type === 'fotocarnet' && id) { showDeleteConfirmModal(id, 'fotocarnet', name); }
                    else if (type === 'cedula' && id) { showDeleteConfirmModal(id, 'cedula', name); }
                    else if (type === 'poder_simple' && id) { showDeleteConfirmModal(id, 'poder_simple', name); }
                } else if (action === 'edit' && type === 'user' && id) {
                    populateUserEditForm(id); // id es el UUID de public.users
                } else if (action === 'generate-pdf' && id && (type === 'tramite' || type === 'autorizacion' || type === 'poder_simple')) {
                    generatePdf(type, id);
                }
            });
        }

        // Verificar sesi√≥n local al cargar la p√°gina
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            try {
                const user = JSON.parse(storedUser);
                if (user && user.id) { // Verificar que el usuario (de public.users) y su ID (UUID) existan
                    showAppScreen();
                } else { // Datos de usuario inv√°lidos en localStorage
                    localStorage.removeItem('currentUser');
                    showLoginScreen();
                }
            }
            catch (e) { // Error al parsear JSON
                localStorage.removeItem('currentUser');
                showLoginScreen();
            }
        } else {
            showLoginScreen();
        }
    });
    </script>
</body>
</html>
