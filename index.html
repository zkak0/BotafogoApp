<!DOCTYPE html>
<html lang="es" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deportivo Botafogo - App Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" integrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        /* --- Estilos CSS (sin cambios) --- */
        :root {
            --bg-primary: #f9fafb;       /* gray-50 */
            --bg-secondary: #ffffff;     /* white */
            --bg-sidebar: #e5e7eb;       /* gray-200 */
            --bg-sidebar-hover: #d1d5db; /* gray-300 */
            --text-primary: #1f2937;     /* gray-800 */
            --text-secondary: #6b7280;   /* gray-500 */
            --text-sidebar: #374151;     /* gray-700 */
            --text-sidebar-title: #111827; /* gray-900 */
            --text-sidebar-hover: #111827; /* gray-900 */
            --border-color: #e5e7eb;     /* gray-200 */
            --border-input: #d1d5db;     /* gray-300 */
            --border-input-focus: #2563eb; /* blue-600 */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --link-color: #2563eb;       /* blue-600 */
            --link-hover-color: #1d4ed8; /* blue-700 */
            --button-action-bg: #2563eb; /* blue-600 */
            --button-action-hover-bg: #1d4ed8; /* blue-700 */
            --sidebar-border-color: #d1d5db; /* gray-300 */
            --button-green-bg: #16a34a; /* green-600 */
            --button-green-hover-bg: #15803d; /* green-700 */
            --button-cancel-text: #4b5563; /* gray-600 */
            --button-cancel-hover-bg: #f3f4f6; /* gray-100 */
        }
        html.dark {
            --bg-primary: #111827;       /* gray-900 */
            --bg-secondary: #1f2937;     /* gray-800 */
            --bg-sidebar: #1f2937;       /* gray-800 */
            --bg-sidebar-hover: #374151; /* gray-700 */
            --text-primary: #f9fafb;     /* gray-50 */
            --text-secondary: #9ca3af;   /* gray-400 */
            --text-sidebar: #d1d5db;     /* gray-300 */
            --text-sidebar-title: #f9fafb; /* gray-50 */
            --text-sidebar-hover: #ffffff; /* white */
            --border-color: #374151;     /* gray-700 */
            --border-input: #4b5563;     /* gray-600 */
            --border-input-focus: #60a5fa; /* blue-400 */
            --shadow-color: rgba(0, 0, 0, 0.4);
            --link-color: #60a5fa;       /* blue-400 */
            --link-hover-color: #93c5fd; /* blue-300 */
            --button-action-bg: #60a5fa; /* blue-400 */
            --button-action-hover-bg: #3b82f6; /* blue-500 */
            --sidebar-border-color: #4b5563; /* gray-600 */
            --button-green-bg: #22c55e; /* green-500 */
            --button-green-hover-bg: #16a34a; /* green-600 */
            --button-cancel-text: #d1d5db; /* gray-300 */
            --button-cancel-hover-bg: #374151; /* gray-700 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        #login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-primary); }
        .login-box { background-color: var(--bg-secondary); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); padding: 2.5rem; border-radius: 0.5rem; width: 100%; max-width: 28rem; text-align: center;}
        .login-logo { max-width: 200px; height: auto; margin-bottom: 1.5rem; margin-left: auto; margin-right: auto; }
        .login-input { border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); appearance-none; block; width: 100%; padding: 0.75rem; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); placeholder-color: var(--text-secondary); margin-bottom: 1rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;}
        .login-input::placeholder { color: var(--text-secondary); }
        .login-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); }
        .login-button { display: inline-flex; justify-content: center; width: 100%; padding: 0.75rem 1rem; border: 1px solid transparent; background-color: var(--button-action-bg); color: white; font-weight: 600; font-size: 0.875rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; transition: background-color 0.15s ease-in-out; }
        .login-button:hover { background-color: var(--button-action-hover-bg); }
        .login-error { color: #dc2626; }
        #app-screen { display: none; }
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-sidebar); transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar-title { color: var(--text-sidebar-title); font-weight: 700; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav ul li a { padding: 10px 16px; display: flex; align-items: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-sidebar); border-radius: 0.375rem; }
        .sidebar-nav ul li a i { margin-right: 10px; font-size: 1.25rem; width: 20px; text-align: center; }
        .sidebar-nav ul li a:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        .sidebar .border-t { border-color: var(--sidebar-border-color); }
        .collapse-button { color: var(--text-sidebar); }
        .collapse-button:hover { color: var(--text-sidebar-hover); }
        #logout-button { color: var(--text-sidebar); padding-top: 0.75rem; padding-bottom: 0.75rem; }
        #logout-button:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        aside.sidebar-collapsed { width: 80px !important; padding-left: 10px; padding-right: 10px; }
        .sidebar-collapsed .menu-item-text span { display: none; }
        .sidebar-collapsed .sidebar-nav ul li a { justify-content: center; padding: 10px 0; }
        .sidebar-collapsed .sidebar-nav ul li a i { margin-right: 0; }
        .sidebar-collapsed .sidebar-title { display: none; }
        .sidebar-collapsed #logout-button span { display: none; }
        .sidebar-collapsed #logout-button i { margin-right: 0; }
        .flex-container { display: flex; }
        .flex-main { flex-grow: 1; position: relative; background-color: var(--bg-primary); }
        #main-title { color: var(--text-primary); }
        #content-area p { color: var(--text-secondary); }
        #content-area .bg-white { background-color: var(--bg-secondary); }
        #content-area h2 { color: var(--text-primary); }
        #content-area label, #content-area span { color: var(--text-primary); }
        #content-area .text-gray-500 { color: var(--text-secondary); }
        #content-area .bg-gray-50 { background-color: var(--bg-primary); border-color: var(--border-color); }
        #content-area table { border-color: var(--border-input); }
        #content-area thead { background-color: var(--bg-secondary); }
        #content-area th { color: var(--text-secondary); border-color: var(--border-color); font-weight: 600; }
        #content-area tbody { background-color: var(--bg-secondary); divide-color: var(--border-color); }
        #content-area td { color: var(--text-primary); border-color: var(--border-color); }
        #content-area tr:hover { background-color: var(--bg-primary); }
        ::placeholder { color: var(--text-secondary); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-secondary); }
        ::-ms-input-placeholder { color: var(--text-secondary); }
        .action-button { cursor: pointer; transition: color 0.15s ease-in-out; }
        .hidden-file-input { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-label { cursor: pointer; display: inline-flex; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .file-input-label:hover { background-color: var(--bg-primary); }
        .file-input-label i { margin-right: 0.5rem; }
        .form-input-base { appearance-none; block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); placeholder-color: var(--text-secondary); color: var(--text-primary); background-color: var(--bg-secondary); font-size: 0.875rem; }
        .form-input-base:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        html.dark .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        .edit-user-button { background-color: #fbbf24; color: #78350f; }
        .edit-user-button:hover { background-color: #f59e0b; }
        html.dark .edit-user-button { background-color: #fcd34d; color: #78350f; }
        html.dark .edit-user-button:hover { background-color: #fbbf24; }
        #add-user-error { color: #dc2626; }
        /* Botones de acci√≥n en tablas */
        .action-button[data-action="generate-pdf"] { color: var(--link-color); }
        .action-button[data-action="generate-pdf"]:hover { color: var(--link-hover-color); }
        .action-button[data-action="edit"] { color: #ca8a04; } /* yellow-600 */
        .action-button[data-action="edit"]:hover { color: #a16207; } /* yellow-700 */
        html.dark .action-button[data-action="edit"] { color: #fcd34d; } /* yellow-300 */
        html.dark .action-button[data-action="edit"]:hover { color: #fbbf24; } /* yellow-400 */
        .action-button[data-action="delete"] { color: #dc2626; } /* red-600 */
        .action-button[data-action="delete"]:hover { color: #b91c1c; } /* red-700 */
        html.dark .action-button[data-action="delete"] { color: #f87171; } /* red-400 */
        html.dark .action-button[data-action="delete"]:hover { color: #fb7185; } /* red-300 */
        /* Botones principales de formularios */
        #form-tramite button[type=submit], #form-autorizacion button[type=submit], #form-add-user #user-submit-button[class*="bg-green"], #generate-button { background-color: var(--button-action-bg); color: white; }
        #form-tramite button[type=submit]:hover, #form-autorizacion button[type=submit]:hover, #form-add-user #user-submit-button[class*="bg-green"]:hover, #generate-button:hover { background-color: var(--button-action-hover-bg); }
        /* Bot√≥n Agregar espec√≠ficamente */
        #form-add-user #user-submit-button { background-color: var(--button-green-bg); color: white; }
        #form-add-user #user-submit-button:hover { background-color: var(--button-green-hover-bg); }
        #form-add-user #user-cancel-button { border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-secondary); }
        #form-add-user #user-cancel-button:hover { background-color: var(--bg-primary); }
        /* --- Estilos Foto Carnet --- */
        .cropper-container-wrapper { max-width: 500px; height: 400px; margin-top: 0.5rem; border: 1px dashed var(--border-color); background-color: var(--bg-primary); }
        #cropper-image { display: block; max-width: 100%; }
        .result-canvas-container { margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-input); background-color: var(--bg-primary); border-radius: 0.375rem; text-align: center; min-height: 150px; }
        #result-canvas { border: 1px solid var(--border-color); max-width: 100%; height: auto; display: none; margin: 0 auto; }
        .button-group button, .button-group .file-input-label { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .button-group button:last-child, .button-group .file-input-label:last-child { margin-right: 0; }
        .form-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        /* Input de 1 letra */
        .single-char-input {
             width: 1.75rem; /* w-7 */
             height: 1.75rem; /* h-7 */
             text-align: center;
             padding: 0.1rem; /* Ajusta padding si es necesario */
             margin-left: 0.25rem; /* ml-1 */
             margin-right: 0.5rem; /* mr-2 */
             border-width: 1px;
             border-radius: 0.25rem; /* rounded-sm */
             border-color: var(--border-input);
             background-color: var(--bg-secondary);
             color: var(--text-primary);
             text-transform: uppercase; /* Para que sea may√∫scula */
        }
         .single-char-input:focus {
             outline: none;
             border-color: var(--border-input-focus);
             box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
         }
        /* Bot√≥n Dark Mode */
         #dark-mode-toggle {
             position: absolute;
             top: 1rem;
             right: 1rem;
             background-color: var(--bg-secondary);
             color: var(--text-secondary);
             border: 1px solid var(--border-color);
             border-radius: 9999px;
             padding: 0.5rem;
             cursor: pointer;
             transition: background-color 0.2s ease, color 0.2s ease;
             z-index: 50;
             width: 2.5rem; height: 2.5rem;
             display: flex; align-items: center; justify-content: center;
         }
          #dark-mode-toggle:hover {
              background-color: var(--bg-primary);
              color: var(--text-primary);
          }
         #dark-mode-toggle i { font-size: 1.1rem; }
		 
    </style>
    </head>
<body class="bg-primary"> <div id="login-screen">
        <div class="login-box">
            <img src="https://i.imgur.com/IAVAqup.jpeg" alt="Logo Botafogo" class="login-logo" onerror="this.src='https://placehold.co/200x200/cccccc/333333?text=LOGO'; this.onerror=null;">
            <h2 class="text-2xl font-bold text-primary mb-6">Bienvenido a Botafogo App</h2>
            <form id="login-form">
                <div>
                    <label for="username" class="sr-only">Usuario</label>
                    <input type="text" id="username" name="username" class="login-input" placeholder="Usuario" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Clave</label>
                    <input type="password" id="password" name="password" class="login-input" placeholder="Clave" required>
                </div>
                <div id="login-error-message" class="login-error"></div>
                <button type="submit" class="login-button mt-4">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="min-h-screen flex-container">
        <aside class="w-64 bg-sidebar text-sidebar p-6 space-y-6 rounded-r-lg flex flex-col justify-between sidebar" id="sidebar"> <div>
                <div class="text-2xl font-bold mb-6 sidebar-title text-sidebar-title">Botafogo App</div> <nav class="sidebar-nav">
                    <ul class="space-y-2">
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-tramite"><i class="fas fa-file-contract text-lg"></i> <span>Tr√°mite Individual</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-autorizacion"><i class="fas fa-file-signature text-lg"></i> <span>Autorizaci√≥n</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-lista"><i class="fas fa-list-alt text-lg"></i> <span>Listado Jugadores</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-fotocarnet"><i class="fas fa-id-badge text-lg"></i> <span>Foto Carnet</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-usuarios"><i class="fas fa-users-cog text-lg"></i> <span>Gesti√≥n Usuarios</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="border-t border-t-sidebar-border pt-4 mt-4 flex flex-col items-center"> <button class="text-sidebar hover:text-sidebar-hover focus:outline-none collapse-button mb-4" id="collapse-toggle">
                     <i class="fas fa-bars text-xl"></i> </button>
                 <button class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-md text-sidebar hover:bg-sidebar-hover hover:text-sidebar-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sidebar focus:ring-white" id="logout-button"> <i class="fas fa-sign-out-alt mr-2"></i>
                     <span>Cerrar Sesi√≥n</span> </button>
            </div>
        </aside>

        <main class="flex-1 p-8 flex-main bg-primary">
             <button id="dark-mode-toggle" title="Cambiar modo claro/oscuro" class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                 <i class="fas fa-moon"></i>
             </button>

            <h1 class="text-3xl font-bold mb-6 text-primary" id="main-title">Bienvenido</h1>
            <div id="content-area" class="text-secondary">
                <p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>
            </div>
        </main>
    </div>

    <script>
        // --- Datos Globales ---
        let players = [];
        let autorizaciones = [];
        // Array 'users' para simulaci√≥n local (INSEGURO PARA PRODUCCI√ìN)
        let users = [
			{ username: '15974472-8', password: 'CLAUDIA', nombreCompleto: 'CLAUDIA ALEJANDRA ROJAS ARMIJO' }
        ];
        let cropperInstance = null;
        let isCropperScriptLoaded = false; // Flag para carga din√°mica

        // --- Funciones Auxiliares (formatRut, formatFechaNacimiento) ---
        function formatRut(rutInput) { if (!rutInput) return; let rut = rutInput.value.replace(/[^0-9kK]/g, '').toLowerCase(); let formattedRut = ''; if (rut.length > 1) { let dv = rut.slice(-1); let body = rut.slice(0, -1); let bodyFormatted = ""; while (body.length > 3) { bodyFormatted = "." + body.slice(-3) + bodyFormatted; body = body.slice(0, -3); } bodyFormatted = body + bodyFormatted; formattedRut = bodyFormatted + '-' + dv; } else { formattedRut = rut; } rutInput.value = formattedRut; }
        function formatFechaNacimiento(dateInput) { if (!dateInput) return; let date = dateInput.value.replace(/[^0-9]/g, ''); let formattedDate = ''; if (date.length >= 2) { formattedDate += date.substring(0, 2); if (date.length >= 4) { formattedDate += '-' + date.substring(2, 4); if (date.length >= 8) { formattedDate += '-' + date.substring(4, 8); } else if (date.length > 4) { formattedDate += '-' + date.substring(4); } } else if (date.length > 2) { formattedDate += '-' + date.substring(2); } } else { formattedDate = date; } dateInput.value = formattedDate.substring(0, 10); }

        // --- Funciones de Visibilidad Pantallas ---
        function showLoginScreen() { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('app-screen').style.display = 'none'; }
        function showAppScreen() { document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'flex'; const mainTitle = document.getElementById('main-title'); const contentArea = document.getElementById('content-area'); if(mainTitle) mainTitle.innerText = 'Bienvenido'; if(contentArea) contentArea.innerHTML = '<p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>'; }

        // --- Funciones de Renderizado (App Principal) ---
        function renderPlayerList() { const mainTitle = document.getElementById('main-title'); const contentArea = document.getElementById('content-area'); if (!mainTitle || !contentArea) return; mainTitle.innerText = 'Listado de Jugadores y Autorizaciones'; let listHtml = '<div class="bg-secondary p-6 rounded-lg shadow-md">'; listHtml += '<div class="mb-8 p-4 border border-border-color rounded-lg bg-primary"><h2 class="text-2xl font-semibold mb-4 text-primary">Tr√°mites Individuales</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-border-color border border-border-input"><thead class="bg-secondary"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">C√©dula</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Paterno</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Materno</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombres</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Fec. Nac.</th><th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th><th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th></tr></thead><tbody class="bg-secondary divide-y divide-border-color">'; if (players.length === 0) { listHtml += '<tr><td colspan="7" class="px-6 py-4 text-center text-secondary">No hay tr√°mites registrados.</td></tr>'; } else { players.forEach((p, i) => { listHtml += `<tr class="hover:bg-primary">`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.ci || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellidoPaterno || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellidoMaterno || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.nombres || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.fechaNac || ''}</td>`; listHtml += `<td class="px-6 py-4 text-center border-r border-border-color"><button class="text-link-color hover:text-link-hover-color action-button" data-action="generate-pdf" data-type="tramite" data-index="${i}" title="Generar PDF"><i class="fas fa-file-pdf fa-lg"></i></button></td>`; listHtml += `<td class="px-6 py-4 text-center"><button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 action-button" data-action="delete" data-type="tramite" data-index="${i}" title="Eliminar"><i class="fas fa-trash fa-lg"></i></button></td>`; listHtml += `</tr>`; }); } listHtml += '</tbody></table></div></div>'; listHtml += '<div class="p-4 border border-border-color rounded-lg bg-primary"><h2 class="text-2xl font-semibold mb-4 text-primary">Autorizaciones</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-border-color border border-border-input"><thead class="bg-secondary"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Apoderado</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">CI Apod.</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Jugador</th><th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Parentesco</th><th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th><th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th></tr></thead><tbody class="bg-secondary divide-y divide-border-color">'; if (autorizaciones.length === 0) { listHtml += '<tr><td colspan="6" class="px-6 py-4 text-center text-secondary">No hay autorizaciones registradas.</td></tr>'; } else { autorizaciones.forEach((a, i) => { listHtml += `<tr class="hover:bg-primary">`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderadoNombre || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderadoCi || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.jugadorNombre || ''}</td>`; listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.parentesco || ''}</td>`; listHtml += `<td class="px-6 py-4 text-center border-r border-border-color"><button class="text-link-color hover:text-link-hover-color action-button" data-action="generate-pdf" data-type="autorizacion" data-index="${i}" title="Generar PDF"><i class="fas fa-file-pdf fa-lg"></i></button></td>`; listHtml += `<td class="px-6 py-4 text-center"><button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 action-button" data-action="delete" data-type="autorizacion" data-index="${i}" title="Eliminar"><i class="fas fa-trash fa-lg"></i></button></td>`; listHtml += `</tr>`; }); } listHtml += '</tbody></table></div></div>'; listHtml += '</div>'; contentArea.innerHTML = listHtml; }
        function renderTramiteForm() {
             const mainTitle = document.getElementById('main-title');
             const contentArea = document.getElementById('content-area');
             if (!mainTitle || !contentArea) return;
             mainTitle.innerText = 'Tr√°mite Individual';
             const inputBaseClasses = "form-input-base";
             const singleCharInputClasses = "single-char-input form-input-base"; // Clases para input de 1 letra

             contentArea.innerHTML = `
                 <div class="bg-secondary p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                     <h2 class="text-2xl font-semibold mb-6 text-primary">Datos del Jugador</h2>
                     <form id="form-tramite">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                             <div>
                                 <label for="ci" class="block text-sm font-medium text-secondary mb-1">C√©dula Identidad (RUT):</label>
                                 <input type="text" id="ci" class="${inputBaseClasses}" placeholder="Ej: 12.345.678-9" required>
                             </div>
                             <div>
                                 <label for="fecha-nac" class="block text-sm font-medium text-secondary mb-1">Fecha Nacimiento:</label>
                                 <input type="text" id="fecha-nac" class="${inputBaseClasses}" placeholder="dd-mm-aaaa" required maxlength="10">
                             </div>
                         </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <div>
                                 <label for="apellido-paterno" class="block text-sm font-medium text-secondary mb-1">Apellido Paterno:</label>
                                 <input type="text" id="apellido-paterno" class="${inputBaseClasses}" required>
                             </div>
                             <div>
                                 <label for="apellido-materno" class="block text-sm font-medium text-secondary mb-1">Apellido Materno:</label>
                                 <input type="text" id="apellido-materno" class="${inputBaseClasses}" required>
                             </div>
                         </div>
                         <div class="mb-6">
                             <label for="nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                             <input type="text" id="nombres" class="${inputBaseClasses}" required>
                         </div>

                         <div class="mb-6">
                             <span class="block text-sm font-medium text-secondary mb-2">Solicita:</span>
                             <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-2 items-center">
                                 <div class="flex items-center">
                                     <input type="text" id="solicita_inscripcion_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Inscripci√≥n</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="solicita_pase_interno_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Pase Interno</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="solicita_pase_regional_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Pase Regional</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="solicita_pase_externo_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Pase Externo</span>
                                 </div>
                             </div>
                         </div>

                         <div class="mb-6">
                             <span class="block text-sm font-medium text-secondary mb-2">Categor√≠a:</span>
                             <div class="mt-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-x-6 gap-y-2 items-center">
                                 <div class="flex items-center">
                                     <input type="text" id="categoria_extranjero_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Extranjero</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="categoria_libertad_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Libertad Acci√≥n</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="categoria_adulto_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Adulto</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="categoria_femenina_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Femenina</span>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="text" id="categoria_infantil_char" maxlength="1" class="${singleCharInputClasses}">
                                     <span class="ml-2 text-sm text-secondary">Infantil</span>
                                 </div>
                             </div>
                         </div>

                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <div>
                                 <label for="procede-club" class="block text-sm font-medium text-secondary mb-1">Procede del Club:</label>
                                 <input type="text" id="procede-club" class="${inputBaseClasses}">
                             </div>
                             <div>
                                 <label for="procede-asociacion" class="block text-sm font-medium text-secondary mb-1">Asociaci√≥n de Procedencia:</label>
                                 <input type="text" id="procede-asociacion" class="${inputBaseClasses}">
                             </div>
                         </div>
                         <div class="mt-8 text-right">
                             <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-button-action-bg hover:bg-button-action-hover-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Tr√°mite</button>
                         </div>
                     </form>
                 </div>`;

             const form = document.getElementById('form-tramite');
             if (form) {
                 form.addEventListener('submit', handleTramiteSubmit);
             }
             const ciInput = document.getElementById('ci');
             if (ciInput) {
                 ciInput.addEventListener('input', () => formatRut(ciInput));
             }
             const fechaNacInput = document.getElementById('fecha-nac');
             if (fechaNacInput) {
                 fechaNacInput.addEventListener('input', () => formatFechaNacimiento(fechaNacInput));
             }
             // Convertir a may√∫sculas inputs de texto normales
             const inputsToUpper = ['apellido-paterno', 'apellido-materno', 'nombres', 'procede-club', 'procede-asociacion'];
             inputsToUpper.forEach(id => {
                 const input = document.getElementById(id);
                 if (input) {
                     input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
                 }
             });
             // Convertir a may√∫sculas inputs de 1 letra
             const singleCharInputs = document.querySelectorAll('.single-char-input');
             singleCharInputs.forEach(input => {
                 input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
             });
         }
        function renderAutorizacionForm() { const mainTitle = document.getElementById('main-title'); const contentArea = document.getElementById('content-area'); if (!mainTitle || !contentArea) return; mainTitle.innerText = 'Autorizaci√≥n de Jugadores'; const inputBaseClasses = "form-input-base"; const selectBaseClasses = inputBaseClasses + " form-select-base"; contentArea.innerHTML = `<div class="bg-secondary p-6 rounded-lg shadow-md max-w-4xl mx-auto"><h2 class="text-2xl font-semibold mb-6 text-primary">Datos de Autorizaci√≥n</h2><form id="form-autorizacion"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end"><div class="md:col-span-2"><label for="apoderado-nombre" class="block text-sm font-medium text-secondary mb-1">Nombre del Apoderado/Tutor:</label><input type="text" id="apoderado-nombre" class="${inputBaseClasses}" required></div><div><label for="apoderado-ci" class="block text-sm font-medium text-secondary mb-1">C√©dula Identidad Apoderado:</label><input type="text" id="apoderado-ci" class="${inputBaseClasses}" placeholder="Ej: 12.345.678-9" required></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end"><div class="md:col-span-2"><label for="jugador-nombre-auth" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador:</label><input type="text" id="jugador-nombre-auth" class="${inputBaseClasses}" required></div><div><label for="parentesco" class="block text-sm font-medium text-secondary mb-1">Parentesco:</label><select id="parentesco" class="${selectBaseClasses}" required><option value="">Seleccione...</option><option value="Padre">Padre</option><option value="Madre">Madre</option><option value="Hermana">Hermana</option><option value="Hermano">Hermano</option><option value="Tutor">Tutor Legal</option><option value="Abuelo">Abuelo</option><option value="Abuela">Abuela</option><option value="Otro">Otro</option></select></div></div><div class="mt-8 text-right"><button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-button-action-bg hover:bg-button-action-hover-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Autorizaci√≥n</button></div></form></div>`; const form = document.getElementById('form-autorizacion'); if (form) { form.addEventListener('submit', handleAutorizacionSubmit); } const apoderadoCiInput = document.getElementById('apoderado-ci'); if (apoderadoCiInput) { apoderadoCiInput.addEventListener('input', () => formatRut(apoderadoCiInput)); } const apoderadoNombreInput = document.getElementById('apoderado-nombre'); if (apoderadoNombreInput) { apoderadoNombreInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); }); } const jugadorNombreAuthInput = document.getElementById('jugador-nombre-auth'); if (jugadorNombreAuthInput) { jugadorNombreAuthInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); }); } }
        function renderUserManagementForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;

            mainTitle.innerText = 'Gesti√≥n de Usuarios';
            const inputBaseClasses = "form-input-base";

            let formHtml = `
                <div class="bg-secondary p-6 rounded-lg shadow-md mb-8">
                    <h2 id="user-form-title" class="text-xl font-semibold mb-4 text-primary">Agregar Nuevo Usuario</h2>
                    <form id="form-add-user">
                        <input type="hidden" id="edit-user-index" value="-1"> <div class="mb-4">
                            <label for="new-fullname" class="block text-sm font-medium text-secondary mb-1">Nombre Completo:</label>
                            <input type="text" id="new-fullname" class="${inputBaseClasses}" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end"> <div>
                                <label for="new-username" class="block text-sm font-medium text-secondary mb-1">Usuario (C√©dula):</label>
                                <input type="text" id="new-username" class="${inputBaseClasses}" placeholder="Ej: 12345678-9" required> </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-secondary mb-1">Clave:</label>
                                <input type="password" id="new-password" class="${inputBaseClasses}" placeholder="Clave" required> </div> <div>
                                <button type="submit" id="user-submit-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-button-green-bg hover:bg-button-green-hover-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                     <span id="user-submit-button-text">Agregar</span>
                                </button>
                                <button type="button" id="user-cancel-button" class="hidden w-full mt-2 inline-flex justify-center py-2 px-4 border border-border-input shadow-sm text-sm font-medium rounded-md text-secondary bg-secondary hover:bg-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Cancelar Edici√≥n
                                </button>
                            </div>
                        </div>
                         <div id="add-user-error" class="text-red-600 dark:text-red-400 text-sm mt-1 min-h-[1.25rem]"></div>
                    </form>
                </div>`;

            let listHtml = `
                <div class="bg-secondary p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Usuarios Registrados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-primary">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Completo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Usuario (C√©dula)</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Editar</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>
                                </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;

            // Mostrar usuarios locales (con advertencia de seguridad)
            if (users.length === 0) {
                listHtml += '<tr><td colspan="4" class="px-6 py-4 text-center text-secondary">No hay usuarios registrados.</td></tr>';
            } else {
                users.forEach((user, index) => {
                    listHtml += `<tr class="hover:bg-primary">`;
                    listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.nombreCompleto || ''}</td>`;
                    listHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.username}</td>`;
                    listHtml += `<td class="px-6 py-4 text-center border-r border-border-color">
                                     <button class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 action-button"
                                             data-action="edit"
                                             data-type="user"
                                             data-index="${index}"
                                             title="Editar Usuario">
                                        <i class="fas fa-edit fa-lg"></i>
                                    </button>
                                 </td>`;
                    listHtml += `<td class="px-6 py-4 text-center">
                                     <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 action-button"
                                             data-action="delete"
                                             data-type="user"
                                             data-index="${index}"
                                             title="Eliminar Usuario">
                                        <i class="fas fa-user-times fa-lg"></i>
                                    </button>
                                 </td>`;
                    listHtml += `</tr>`;
                });
            }


            listHtml += `</tbody></table></div></div>`;

            contentArea.innerHTML = formHtml + listHtml;

            const addUserForm = document.getElementById('form-add-user');
            const cancelEditButton = document.getElementById('user-cancel-button');

            if (addUserForm) {
                addUserForm.addEventListener('submit', handleAddUserSubmit);
            }
            if(cancelEditButton) {
                cancelEditButton.addEventListener('click', resetUserForm);
            }

             const newUsernameInput = document.getElementById('new-username');
             const newFullnameInput = document.getElementById('new-fullname');
             if (newFullnameInput) {
                  newFullnameInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
             }
        }

        /**
         * Renderiza el formulario para la foto carnet.
         */
        function renderFotoCarnetForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;

            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch (e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }

            mainTitle.innerText = 'Generar Foto Carnet';
            const inputBaseClasses = "form-input-base";

            contentArea.innerHTML = `
                <div class="bg-secondary p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-primary">1. Sube y Ajusta tu Foto</h2>
                    <div class="mb-4 button-group">
                        <input type="file" id="image-upload" class="hidden-file-input" accept="image/*">
                        <label for="image-upload" class="file-input-label">
                            <i class="fas fa-upload"></i> <span>Seleccionar Foto</span>
                        </label>
                    </div>
                    <div class="cropper-container-wrapper mb-4">
                         <img id="cropper-image" src="" alt="√Årea para ajustar foto">
                    </div>

                    <div class="form-section">
                        <h2 class="text-xl font-semibold mb-4 text-primary">2. Ingresa tus Datos</h2>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <label for="foto-nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                                <input type="text" id="foto-nombres" class="${inputBaseClasses}" required>
                            </div>
                             <div>
                                <label for="foto-apellidos" class="block text-sm font-medium text-secondary mb-1">Apellidos:</label>
                                <input type="text" id="foto-apellidos" class="${inputBaseClasses}" required>
                            </div>
                             <div>
                                <label for="foto-rut" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad (RUT):</label>
                                <input type="text" id="foto-rut" class="${inputBaseClasses}" placeholder="Ej: 12345678-9" required>
                            </div>
                        </div>
                    </div>

                     <div class="form-section">
                         <h2 class="text-xl font-semibold mb-4 text-primary">3. Generar Foto</h2>
                         <div class="button-group mb-4">
                             <button type="button" id="generate-button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-button-action-bg hover:bg-button-action-hover-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50" disabled>
                                 <i class="fas fa-cogs mr-2"></i>Generar Foto Carnet
                             </button>
                             </div>
                         <div class="result-canvas-container">
                             <canvas id="result-canvas"></canvas>
                             </div>
                     </div>
                </div>
            `;

            // Cargar din√°micamente Cropper.js y luego inicializar listeners
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js', setupFotoCarnetListeners);
        }

        /**
         * Carga un script din√°micamente y ejecuta un callback al cargar.
         */
        function loadScript(src, callback) {
            const existingScript = document.querySelector(`script[src="${src}"]`);
            if (existingScript) {
                console.log(`Script ${src} ya presente.`);
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                const checkGlobalVar = (varName, cb) => {
                    if (typeof window[varName] !== 'undefined') {
                        console.log(`${varName} disponible.`);
                        if (cb) cb();
                    } else {
                        console.warn(`Script tag presente, pero ${varName} no definido. Reintentando...`);
                        setTimeout(() => checkGlobalVar(varName, cb), 100);
                    }
                };
                if (src.includes('cropper')) checkGlobalVar('Cropper', callback);
                else if (callback) callback();
                return;
            }

            console.log(`Cargando script: ${src}`);
            const script = document.createElement('script');
            script.src = src;
            script.defer = true; // Usar defer
            script.onload = () => {
                console.log(`Script ${src} cargado din√°micamente.`);
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                if (callback) callback();
            };
            script.onerror = () => {
                console.error(`Error al cargar el script: ${src}`);
                alert(`Error cr√≠tico: No se pudo cargar la librer√≠a ${src}. La funcionalidad dependiente no estar√° disponible.`);
                 if (src.includes('cropper')) {
                     const generateButton = document.getElementById('generate-button');
                     const imageUploadLabel = document.querySelector('label[for="image-upload"]');
                     if(generateButton) generateButton.disabled = true;
                     if(imageUploadLabel) imageUploadLabel.style.display = 'none';
                 }
            };
            document.body.appendChild(script);
        }


        /**
         * Configura los listeners para la secci√≥n Foto Carnet.
         */
        function setupFotoCarnetListeners() {
            if (typeof Cropper === 'undefined') {
                 console.error("setupFotoCarnetListeners: Cropper no est√° definido. No se a√±adir√°n listeners.");
                 const contentArea = document.getElementById('content-area');
                 if(contentArea?.querySelector) {
                      const container = contentArea.querySelector('.cropper-container-wrapper');
                      if(container) {
                          container.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: La herramienta de recorte no pudo cargarse. Intenta recargar la p√°gina.</p>';
                      }
                 }
                 return;
            }
            console.log("Configurando listeners de Foto Carnet...");

            const imageUpload = document.getElementById('image-upload');
            const generateButton = document.getElementById('generate-button');
            // const copyButton = document.getElementById('copy-button'); // Eliminado
            const rutInput = document.getElementById('foto-rut');
            const textInputs = ['foto-nombres', 'foto-apellidos', 'foto-rut'];

            if (imageUpload) {
                imageUpload.addEventListener('change', handleImageUploadWithCropper);
            }
            if (generateButton) {
                generateButton.addEventListener('click', generateFotoCarnetWithCropper);
            }
            // Listener para copyButton eliminado
             if (rutInput) {
                 rutInput.addEventListener('input', () => {
                     formatRut(rutInput);
                     checkEnableGenerateButton();
                 });
             }
             textInputs.forEach(id => {
                 const input = document.getElementById(id);
                 if (input && id !== 'foto-rut') {
                     input.addEventListener('input', (e) => {
                         e.target.value = e.target.value.toUpperCase();
                         checkEnableGenerateButton();
                     });
                 } else if (input && id === 'foto-rut') {
                    // Listener ya a√±adido arriba
                 }
             });
        }

        /**
         * Verifica si se debe habilitar el bot√≥n "Generar Foto Carnet".
         */
        function checkEnableGenerateButton() {
            const generateButton = document.getElementById('generate-button');
            if (!generateButton) return;

            const nombres = document.getElementById('foto-nombres')?.value.trim();
            const apellidos = document.getElementById('foto-apellidos')?.value.trim();
            const rut = document.getElementById('foto-rut')?.value.trim();
            const isCropperReady = cropperInstance !== null;

            generateButton.disabled = !(isCropperReady && nombres && apellidos && rut);
        }


        /**
         * Maneja la carga de la imagen y inicializa Cropper.js.
         */
        function handleImageUploadWithCropper(event) {
            const file = event.target.files[0];
            const imageElement = document.getElementById('cropper-image');
            const generateButton = document.getElementById('generate-button');
            // const copyButton = document.getElementById('copy-button'); // Eliminado
            const resultCanvas = document.getElementById('result-canvas');

            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch(e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }
             if (resultCanvas) {
                 resultCanvas.getContext('2d').clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                 resultCanvas.style.display = 'none';
             }
             checkEnableGenerateButton();
             // if(copyButton) copyButton.disabled = true; // Bot√≥n eliminado
             // const copyStatus = document.getElementById('copy-status'); // Elemento p eliminado
             // if(copyStatus) copyStatus.textContent = '';


            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageElement.src = e.target.result;

                    // Verifica que Cropper est√© definido ANTES de usarlo
                    if (typeof Cropper === 'undefined') {
                        console.error("Cropper no est√° definido al intentar inicializar.");
                        alert("Error: La librer√≠a de recorte no se carg√≥ correctamente. Intenta recargar la p√°gina o verifica tu conexi√≥n.");
                        return;
                    }

                     try {
                         if (cropperInstance) { cropperInstance.destroy(); }
                         cropperInstance = new Cropper(imageElement, {
                            aspectRatio: 3 / 4,
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 0.8,
                            background: false,
                            zoomable: true,
                            movable: true,
                            cropBoxResizable: true,
                            ready: () => {
                                 checkEnableGenerateButton();
                                 console.log("Cropper listo");
                            }
                        });
                    } catch (error) {
                         console.error("Error al inicializar Cropper:", error);
                         alert(`Error al inicializar la herramienta de recorte: ${error.message}`);
                    }
                };
                reader.readAsDataURL(file);
            } else {
                imageElement.src = "";
                if(file) alert("Por favor, selecciona un archivo de imagen v√°lido.");
                checkEnableGenerateButton();
            }
        }

        /**
         * Genera la imagen final combinando la foto recortada y el texto.
         */
        function generateFotoCarnetWithCropper() {
            console.log("generateFotoCarnetWithCropper iniciado");
            if (!cropperInstance) {
                alert("Primero sube y ajusta una imagen.");
                return;
            }

            const nombres = document.getElementById('foto-nombres').value.trim();
            const apellidos = document.getElementById('foto-apellidos').value.trim();
            const rut = document.getElementById('foto-rut').value.trim();

            if (!nombres || !apellidos || !rut) {
                alert("Por favor, completa Nombres, Apellidos y RUT.");
                return;
            }
            console.log("Datos:", {nombres, apellidos, rut});

            let croppedCanvas;
            try {
                croppedCanvas = cropperInstance.getCroppedCanvas({
                    width: 300,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });
                 console.log("Canvas recortado obtenido:", croppedCanvas.width, croppedCanvas.height);
                 if (!croppedCanvas.width || !croppedCanvas.height) {
                     throw new Error("El √°rea recortada tiene dimensiones inv√°lidas (0).");
                 }
            } catch (error) {
                 console.error("Error en getCroppedCanvas:", error);
                 alert(`Error al recortar la imagen: ${error.message}. Aseg√∫rate de que el √°rea de recorte sea v√°lida.`);
                 return;
            }

            const resultCanvas = document.getElementById('result-canvas');
            const ctx = resultCanvas.getContext('2d');
            // const copyButton = document.getElementById('copy-button'); // Eliminado

            // --- Calcular dimensiones y dibujar ---
            const photoWidth = croppedCanvas.width;
            const photoHeight = croppedCanvas.height;

            // *** Ajustes para franja negra y texto m√°s grandes ***
            const textLineHeight = 24;
            const textPadding = 15;
            const fontSize = 18;
            const numTextLines = 3;
            const textStripHeight = (textLineHeight * numTextLines) + (textPadding * 2);

            resultCanvas.width = photoWidth;
            resultCanvas.height = photoHeight;

            console.log(`Dimensiones canvas resultado: ${resultCanvas.width}x${resultCanvas.height}`);

            ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            ctx.drawImage(croppedCanvas, 0, 0, resultCanvas.width, resultCanvas.height);
            console.log("Foto recortada dibujada en canvas final");

            ctx.fillStyle = 'black';
            const stripY = resultCanvas.height - textStripHeight;
            ctx.fillRect(0, stripY, resultCanvas.width, textStripHeight);
            console.log("Franja negra dibujada sobre la imagen");

            ctx.fillStyle = 'white';
            ctx.font = `bold ${fontSize}px Inter, sans-serif`; // Fuente m√°s grande y negrita
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const textBaseY = stripY + textPadding;
            const textY1 = textBaseY + (textLineHeight / 2);
            const textY2 = textY1 + textLineHeight;
            const textY3 = textY2 + textLineHeight;

            ctx.fillText(nombres.toUpperCase(), resultCanvas.width / 2, textY1);
            ctx.fillText(apellidos.toUpperCase(), resultCanvas.width / 2, textY2);
            ctx.font = `bold ${fontSize}px Inter, sans-serif`; // RUT tambi√©n en negrita
            ctx.fillText(rut, resultCanvas.width / 2, textY3);
            console.log("Texto dibujado sobre la franja");

            resultCanvas.style.display = 'block';
            // No habilitar el bot√≥n copiar
            // if(copyButton) copyButton.disabled = false;
            // const copyStatus = document.getElementById('copy-status'); // Elemento p eliminado
            // if(copyStatus) copyStatus.textContent = '';
            console.log("Generaci√≥n completa, canvas visible");
        }


        /**
         * Intenta copiar la imagen generada al portapapeles. (Funci√≥n eliminada ya que no se usa)
         */
        // async function copyGeneratedImage() { ... }


        // --- Funciones Handler (Submit y Acciones - Sin cambios en estas) ---
        function handleLoginSubmit(event) {
             event.preventDefault();
             const usernameInput = document.getElementById('username');
             const passwordInput = document.getElementById('password');
             const errorMessage = document.getElementById('login-error-message');
             errorMessage.textContent = '';

             const username = usernameInput.value;
             const password = passwordInput.value;

             // *** SIMULACI√ìN DE LOGIN (SIN BACKEND - INSEGURO PARA PRODUCCI√ìN) ***
             const foundUser = users.find(user => user.username === username && user.password === password);

             if (foundUser) {
                 console.log("Login exitoso");
                 usernameInput.value = '';
                 passwordInput.value = '';
                 showAppScreen();
             } else {
                 console.log("Login fallido");
                 errorMessage.textContent = 'Usuario o clave incorrectos.';
             }
         }
        function handleLogout() { showLoginScreen(); }
        function handleAddUserSubmit(event) {
            event.preventDefault();
            // L√≥gica para a√±adir/editar usuarios localmente (INSEGURO)
            const form = event.target;
            const fullnameInput = document.getElementById('new-fullname');
            const usernameInput = document.getElementById('new-username');
            const passwordInput = document.getElementById('new-password');
            const errorDiv = document.getElementById('add-user-error');
            const editIndexInput = document.getElementById('edit-user-index');
            errorDiv.textContent = '';

            const fullname = fullnameInput.value.trim();
            const username = usernameInput.value;
            const password = passwordInput.value;
            const editIndex = parseInt(editIndexInput.value, 10);

            if (!fullname || !username) {
                errorDiv.textContent = 'Debe ingresar Nombre Completo y Usuario.';
                return;
            }

            if (editIndex > -1) { // Modo Edici√≥n
                if (editIndex >= 0 && editIndex < users.length) {
                    const existingUserIndex = users.findIndex((user, index) => user.username === username && index !== editIndex);
                    if (existingUserIndex !== -1) {
                        errorDiv.textContent = 'El nuevo usuario (C√©dula) ya est√° en uso por otro usuario.';
                        return;
                    }
                    users[editIndex].nombreCompleto = fullname;
                    users[editIndex].username = username;
                    if (password) { // Solo actualiza si se ingres√≥ nueva clave
                        users[editIndex].password = password;
                        console.log(`Usuario ${username} actualizado (clave cambiada).`);
                    } else {
                        console.log(`Usuario ${username} actualizado (clave NO cambiada).`);
                    }
                    alert('Usuario actualizado exitosamente.');
                    resetUserForm();
                    renderUserManagementForm(); // Actualiza la lista
                } else {
                    errorDiv.textContent = 'Error: √çndice de usuario a editar inv√°lido.';
                    resetUserForm();
                }
            } else { // Modo Agregar
                 if (!password) {
                     errorDiv.textContent = 'Debe ingresar la clave para un nuevo usuario.';
                     return;
                 }
                const userExists = users.some(user => user.username === username);
                if (userExists) {
                    errorDiv.textContent = 'El usuario (C√©dula) ya existe.';
                    return;
                }
                users.push({ username: username, password: password, nombreCompleto: fullname });
                console.log("Usuario agregado:", { username: username, nombreCompleto: fullname, password: '***' });
                form.reset();
                renderUserManagementForm(); // Actualiza la lista
                alert('Usuario agregado exitosamente.');
            }
        }
        function populateUserEditForm(index) {
             if (index < 0 || index >= users.length) { console.error("√çndice inv√°lido para editar usuario:", index); return; }
             const user = users[index];
             const fullnameInput = document.getElementById('new-fullname');
             const usernameInput = document.getElementById('new-username');
             const passwordInput = document.getElementById('new-password');
             const editIndexInput = document.getElementById('edit-user-index');
             const formTitle = document.getElementById('user-form-title');
             const submitButton = document.getElementById('user-submit-button');
             const submitButtonText = document.getElementById('user-submit-button-text');
             const cancelButton = document.getElementById('user-cancel-button');
             const errorDiv = document.getElementById('add-user-error');
             if (!fullnameInput || !usernameInput || !passwordInput || !editIndexInput || !formTitle || !submitButton || !submitButtonText || !cancelButton || !errorDiv) { console.error("Error: Faltan elementos del formulario para editar."); return; }
             fullnameInput.value = user.nombreCompleto || '';
             usernameInput.value = user.username;
             passwordInput.value = '';
             passwordInput.placeholder = 'Ingrese nueva clave (o dejar en blanco)'; // Placeholder para editar
             passwordInput.required = false; // No requerida al editar
             editIndexInput.value = index;
             formTitle.textContent = 'Editar Usuario';
             submitButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
             submitButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'focus:ring-yellow-500', 'edit-user-button');
             submitButtonText.textContent = 'Guardar Cambios';
             cancelButton.classList.remove('hidden');
             errorDiv.textContent = '';
             fullnameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
             fullnameInput.focus();
        }
        function resetUserForm() { const form = document.getElementById('form-add-user'); const editIndexInput = document.getElementById('edit-user-index'); const formTitle = document.getElementById('user-form-title'); const submitButton = document.getElementById('user-submit-button'); const submitButtonText = document.getElementById('user-submit-button-text'); const cancelButton = document.getElementById('user-cancel-button'); const passwordInput = document.getElementById('new-password'); const errorDiv = document.getElementById('add-user-error'); if (form) form.reset(); if (editIndexInput) editIndexInput.value = '-1'; if (formTitle) formTitle.textContent = 'Agregar Nuevo Usuario'; if (submitButton) { submitButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'focus:ring-yellow-500', 'edit-user-button'); submitButton.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500'); } if (submitButtonText) submitButtonText.textContent = 'Agregar'; if (cancelButton) cancelButton.classList.add('hidden'); if (passwordInput) { passwordInput.placeholder = 'Clave'; passwordInput.required = true; } if (errorDiv) errorDiv.textContent = ''; }
        function handleTramiteSubmit(event) {
             event.preventDefault();
             const formElement = event.target;
             const ci = document.getElementById('ci').value;
             const fechaNac = document.getElementById('fecha-nac').value;
             const apellidoPaterno = document.getElementById('apellido-paterno').value;
             const apellidoMaterno = document.getElementById('apellido-materno').value;
             const nombres = document.getElementById('nombres').value;
             const procedeClub = document.getElementById('procede-club').value;
             const procedeAsociacion = document.getElementById('procede-asociacion').value;
             // Leer valores de los inputs de 1 letra
             const solicita_inscripcion = document.getElementById('solicita_inscripcion_char').value;
             const solicita_pase_interno = document.getElementById('solicita_pase_interno_char').value;
             const solicita_pase_regional = document.getElementById('solicita_pase_regional_char').value;
             const solicita_pase_externo = document.getElementById('solicita_pase_externo_char').value;
             const categoria_extranjero = document.getElementById('categoria_extranjero_char').value;
             const categoria_libertad = document.getElementById('categoria_libertad_char').value;
             const categoria_adulto = document.getElementById('categoria_adulto_char').value;
             const categoria_femenina = document.getElementById('categoria_femenina_char').value;
             const categoria_infantil = document.getElementById('categoria_infantil_char').value;

             const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
             if (!dateRegex.test(fechaNac)) {
                 alert('Ingrese Fecha Nacimiento en formato dd-mm-aaaa.');
                 return;
             }
             // Validaci√≥n simple: al menos un campo de solicita y uno de categor√≠a debe tener algo
             const solicitaValue = [solicita_inscripcion, solicita_pase_interno, solicita_pase_regional, solicita_pase_externo].some(val => val.trim() !== '');
             const categoriaValue = [categoria_extranjero, categoria_libertad, categoria_adulto, categoria_femenina, categoria_infantil].some(val => val.trim() !== '');

             if (!solicitaValue) {
                 alert('Ingrese una marca (ej. "X") en al menos una opci√≥n de "Solicita".');
                 return;
             }
              if (!categoriaValue) {
                 alert('Ingrese una marca (ej. "X") en al menos una opci√≥n de "Categor√≠a".');
                 return;
             }

             players.push({
                 ci,
                 apellidoPaterno,
                 apellidoMaterno,
                 nombres,
                 fechaNac,
                 // Guardar los caracteres ingresados
                 solicita_inscripcion: solicita_inscripcion.trim().toUpperCase(),
                 solicita_pase_interno: solicita_pase_interno.trim().toUpperCase(),
                 solicita_pase_regional: solicita_pase_regional.trim().toUpperCase(),
                 solicita_pase_externo: solicita_pase_externo.trim().toUpperCase(),
                 categoria_extranjero: categoria_extranjero.trim().toUpperCase(),
                 categoria_libertad: categoria_libertad.trim().toUpperCase(),
                 categoria_adulto: categoria_adulto.trim().toUpperCase(),
                 categoria_femenina: categoria_femenina.trim().toUpperCase(),
                 categoria_infantil: categoria_infantil.trim().toUpperCase(),
                 procedeClub,
                 procedeAsociacion,
             });
             if (formElement) {
                 formElement.reset();
             }
             renderPlayerList();
             alert('Tr√°mite guardado.');
         }
        function handleAutorizacionSubmit(event) { event.preventDefault(); const formElement = event.target; const apoderadoNombre = document.getElementById('apoderado-nombre').value; const jugadorNombre = document.getElementById('jugador-nombre-auth').value; const parentesco = document.getElementById('parentesco').value; const apoderadoCi = document.getElementById('apoderado-ci').value; if (parentesco === "") { alert("Seleccione parentesco."); return; } autorizaciones.push({ apoderadoNombre, jugadorNombre, parentesco, apoderadoCi }); if (formElement) { formElement.reset(); } renderPlayerList(); alert('Autorizaci√≥n guardada.'); }

        // --- Funciones de Acci√≥n (generatePdf, delete*) ---
                async function generatePdf(type, index) {
             // Verifica si pdf-lib est√° cargado
             if (typeof PDFLib === 'undefined' || typeof PDFLib.PDFDocument === 'undefined') {
                 alert("La librer√≠a PDF (pdf-lib) no est√° lista. Por favor, espera un momento y vuelve a intentarlo. Si el problema persiste, recarga la p√°gina.");
                 console.error("Error: pdf-lib no est√° definido.");
                 return;
             }
             const { PDFDocument, rgb, StandardFonts } = PDFLib; // Accede a las funciones necesarias

             // URLs de las plantillas PDF en GitHub Pages
             const urlTramite = "https://zkak0.github.io/BotafogoApp/tramite_individual.pdf";
             const urlAutorizacion = "https://zkak0.github.io/BotafogoApp/autorizacion_jugadores.pdf";

             let pdfUrlToLoad;
             let dataToFill;
             let outputFilename;
             let isTramite = false;

             if (type === 'tramite') {
                 if (index < 0 || index >= players.length) { console.error("Err PDF: Idx tr√°mite inv√°lido:", index); alert("Err: Idx tr√°mite inv√°lido."); return; }
                 dataToFill = players[index];
                 pdfUrlToLoad = urlTramite;
                 outputFilename = `tramite_individual_${dataToFill.ci || index}_rellenado.pdf`;
                 isTramite = true;
                 console.log("Preparando PDF Tr√°mite para:", dataToFill.ci);

             } else if (type === 'autorizacion') {
                 if (index < 0 || index >= autorizaciones.length) { console.error("Err PDF: Idx autorizaci√≥n inv√°lido:", index); alert("Err: Idx autorizaci√≥n inv√°lido."); return; }
                  dataToFill = autorizaciones[index];
                  pdfUrlToLoad = urlAutorizacion;
                  outputFilename = `autorizacion_${dataToFill.jugadorNombre || index}_rellenado.pdf`;
                  isTramite = false; // Es autorizaci√≥n
                  console.log("Preparando PDF Autorizaci√≥n para:", dataToFill.jugadorNombre);
             } else {
                 console.error("Err PDF: Tipo desconocido:", type);
                 alert('Err: Tipo PDF desconocido.');
                 return;
             }

             try {
                 // 1. Descargar los bytes del PDF original
                 console.log("Descargando plantilla desde:", pdfUrlToLoad);
                 const existingPdfBytes = await fetch(pdfUrlToLoad).then(res => {
                     if (!res.ok) throw new Error(`Error al descargar plantilla (${res.status}): ${res.statusText}`);
                     return res.arrayBuffer();
                 });
                 console.log("Plantilla descargada (bytes):", existingPdfBytes.byteLength);

                 // 2. Cargar el PDF en pdf-lib
                 const pdfDoc = await PDFDocument.load(existingPdfBytes);
                 const form = pdfDoc.getForm();
                 console.log("PDF cargado en pdf-lib. Formulario obtenido.");

                 // 3. Rellenar los campos usando los NOMBRES INTERNOS CORRECTOS
                 // --- Relleno para Tr√°mite Individual ---
                 if (isTramite) {
                     // *** USA LOS NOMBRES INTERNOS QUE ME PROPORCIONASTE ***
                     const fieldNamesTramite = {
                         ci: 'CEDULA IDENTIDAD',
                         fechaNac: 'FECHA NAC',
                         apellidoPaterno: 'APELLIDO PATERNO',
                         apellidoMaterno: 'APELLIDO MATERNO',
                         nombres: 'NOMBRES',
                         procedeClub: 'PROCEDE DEL CLUB',
                         procedeAsociacion: 'ASOCIACION',
                         // Campos para la 'X' (usando los nombres internos proporcionados)
                         solicita_inscripcion: 'INSCRIPCION',
                         solicita_pase_interno: 'PASE INTERNO',
                         solicita_pase_regional: 'PASE REGIONAL',
                         solicita_pase_externo: 'PASE EXTERNO',
                         categoria_extranjero: 'EXTRANJERO',
                         categoria_libertad: 'LIBERTAD ACCION',
                         categoria_adulto: 'ADULTO',
                         categoria_femenina: 'FEMENINA',
                         categoria_infantil: 'INFANTIL'
                     };

                     // Funci√≥n auxiliar para rellenar campo de texto si existe
                     const fillTextField = (fieldName, text) => {
                         try {
                             const field = form.getTextField(fieldName);
                             field.setText(text || '');
                             console.log(`Campo de texto '${fieldName}' rellenado con: ${text || '(vac√≠o)'}`);
                         } catch (e) {
                             console.warn(`Advertencia: No se encontr√≥ o no se pudo rellenar el campo de texto '${fieldName}'. Error: ${e.message}`);
                         }
                     };

                     // Rellenar campos de texto principales
                     fillTextField(fieldNamesTramite.ci, dataToFill.ci);
                     fillTextField(fieldNamesTramite.fechaNac, dataToFill.fechaNac);
                     fillTextField(fieldNamesTramite.apellidoPaterno, dataToFill.apellidoPaterno);
                     fillTextField(fieldNamesTramite.apellidoMaterno, dataToFill.apellidoMaterno);
                     fillTextField(fieldNamesTramite.nombres, dataToFill.nombres);
                     fillTextField(fieldNamesTramite.procedeClub, dataToFill.procedeClub);
                     fillTextField(fieldNamesTramite.procedeAsociacion, dataToFill.procedeAsociacion);

                     // Rellenar campos de "Solicita" y "Categor√≠a" como texto
                     fillTextField(fieldNamesTramite.solicita_inscripcion, dataToFill.solicita_inscripcion);
                     fillTextField(fieldNamesTramite.solicita_pase_interno, dataToFill.solicita_pase_interno);
                     fillTextField(fieldNamesTramite.solicita_pase_regional, dataToFill.solicita_pase_regional);
                     fillTextField(fieldNamesTramite.solicita_pase_externo, dataToFill.solicita_pase_externo);
                     fillTextField(fieldNamesTramite.categoria_extranjero, dataToFill.categoria_extranjero);
                     fillTextField(fieldNamesTramite.categoria_libertad, dataToFill.categoria_libertad);
                     fillTextField(fieldNamesTramite.categoria_adulto, dataToFill.categoria_adulto);
                     fillTextField(fieldNamesTramite.categoria_femenina, dataToFill.categoria_femenina);
                     fillTextField(fieldNamesTramite.categoria_infantil, dataToFill.categoria_infantil);

                 }
                 // --- Relleno para Autorizaci√≥n ---
                 else if (!isTramite) { // Es autorizaci√≥n
                     // *** USA LOS NOMBRES INTERNOS QUE ME PROPORCIONASTE ***
                     const fieldNamesAuth = {
                         nombreAutorizante: 'NOMBRE AUTORIZANTE',
                         cedulaIdentidad: 'CEDULA IDENTIDAD', // Aseg√∫rate que sea el nombre correcto para este PDF
                         nombreJugador: 'NOMBRE JUGADOR',
                         parentesco: 'PARENTESCO'
                     };

                     // Funci√≥n auxiliar
                     const fillTextFieldAuth = (fieldName, text) => {
                         try {
                             const field = form.getTextField(fieldName);
                             field.setText(text || '');
                             console.log(`Campo de texto (Auth) '${fieldName}' rellenado con: ${text || '(vac√≠o)'}`);
                         } catch (e) {
                             console.warn(`Advertencia (Auth): No se encontr√≥ o no se pudo rellenar el campo de texto '${fieldName}'. Error: ${e.message}`);
                         }
                     };

                     fillTextFieldAuth(fieldNamesAuth.nombreAutorizante, dataToFill.apoderadoNombre);
                     fillTextFieldAuth(fieldNamesAuth.cedulaIdentidad, dataToFill.apoderadoCi);
                     fillTextFieldAuth(fieldNamesAuth.nombreJugador, dataToFill.jugadorNombre);
                     fillTextFieldAuth(fieldNamesAuth.parentesco, dataToFill.parentesco);
                 }

                 // Importante: Aplanar el formulario para que los valores sean visibles en la mayor√≠a de los visores
                 try {
                     form.flatten(); // Aplana los campos rellenados
                     console.log("Formulario aplanado.");
                 } catch (flattenError) {
                     console.warn("Advertencia: No se pudo aplanar el formulario. Los campos podr√≠an no ser visibles en todos los visores.", flattenError);
                 }


                 // 4. Guardar los cambios en bytes
                 const pdfBytes = await pdfDoc.save();
                 console.log("PDF modificado guardado en bytes.");

                 // 5. Crear Blob y URL para abrir/descargar
                 const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                 const blobUrl = URL.createObjectURL(blob);

                 // 6. Abrir en nueva ventana
                 window.open(blobUrl, '_blank');
                 console.log(`Intento de apertura de PDF rellenado para ${outputFilename}`);
                 // No es necesario revocar la URL inmediatamente si se abre en nueva ventana

             } catch (error) {
                 console.error("Error detallado en generatePdf con pdf-lib:", error);
                 alert(`Error al procesar el PDF: ${error.message}. Verifica la consola para m√°s detalles y aseg√∫rate de que los nombres de los campos internos del PDF sean correctos en el c√≥digo.`);
             }
         }
        function deleteTramite(index) { console.log(`Eliminando tr√°mite idx: ${index}`); if (index >= 0 && index < players.length) { players.splice(index, 1); renderPlayerList(); console.log("Tr√°mite eliminado."); } else { console.error("Err deleteTramite: Idx inv√°lido:", index); alert('Err: No se pudo eliminar tr√°mite.'); } }
        function deleteAutorizacion(index) { console.log(`Eliminando autorizaci√≥n idx: ${index}`); if (index >= 0 && index < autorizaciones.length) { autorizaciones.splice(index, 1); renderPlayerList(); console.log("Autorizaci√≥n eliminada."); } else { console.error("Err deleteAutorizacion: Idx inv√°lido:", index); alert('Err: No se pudo eliminar autorizaci√≥n.'); } }
        function deleteUser(index) {
             // L√≥gica para eliminar usuario localmente (INSEGURO)
             console.log(`Intentando eliminar usuario idx: ${index}`);
             if (index >= 0 && index < users.length) {
                 users.splice(index, 1);
                 renderUserManagementForm();
                 console.log("Usuario eliminado (localmente).");
             } else {
                 console.error("Err deleteUser: Idx inv√°lido:", index);
                 alert('Err: No se pudo eliminar el usuario (√≠ndice inv√°lido).');
             }
        }


        // --- Funci√≥n Toggle Sidebar ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            sidebar.classList.toggle('sidebar-collapsed');
        }

        // --- Inicializaci√≥n y Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const menuTramite = document.getElementById('menu-tramite');
            const menuAutorizacion = document.getElementById('menu-autorizacion');
            const menuUsuarios = document.getElementById('menu-usuarios');
            const menuLista = document.getElementById('menu-lista');
            const menuFotoCarnet = document.getElementById('menu-fotocarnet');
            const collapseToggle = document.getElementById('collapse-toggle');
            const contentArea = document.getElementById('content-area');
            const logoutButton = document.getElementById('logout-button');
            const darkModeToggle = document.getElementById('dark-mode-toggle');

            // --- Dark Mode Logic ---
            const applyDarkMode = (isDark) => {
                const html = document.documentElement;
                const icon = darkModeToggle.querySelector('i');
                if (isDark) {
                    html.classList.add('dark');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    html.classList.remove('dark');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            };

            const toggleDarkMode = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
                applyDarkMode(isDark);
            };

            if (darkModeToggle) {
                 darkModeToggle.addEventListener('click', toggleDarkMode);
            }

            // Aplica el modo oscuro al cargar si estaba guardado
            if (localStorage.getItem('darkMode') === 'enabled') {
                 applyDarkMode(true);
            } else {
                 applyDarkMode(false);
            }
            // --- Fin Dark Mode Logic ---


            if (loginForm) { loginForm.addEventListener('submit', handleLoginSubmit); } else { console.error("#login-form no encontrado."); }
            if (menuTramite) { menuTramite.addEventListener('click', (e) => { e.preventDefault(); renderTramiteForm(); }); } else { console.warn("#menu-tramite no encontrado."); }
            if (menuAutorizacion) { menuAutorizacion.addEventListener('click', (e) => { e.preventDefault(); renderAutorizacionForm(); }); } else { console.warn("#menu-autorizacion no encontrado."); }
            if (menuUsuarios) { menuUsuarios.addEventListener('click', (e) => { e.preventDefault(); resetUserForm(); renderUserManagementForm(); }); } else { console.warn("#menu-usuarios no encontrado."); }
            if (menuLista) { menuLista.addEventListener('click', (e) => { e.preventDefault(); renderPlayerList(); }); } else { console.warn("#menu-lista no encontrado."); }
            // Listener para Foto Carnet
            if (menuFotoCarnet) { menuFotoCarnet.addEventListener('click', (e) => { e.preventDefault(); renderFotoCarnetForm(); }); } else { console.warn("#menu-fotocarnet no encontrado."); }
            if (collapseToggle) { collapseToggle.addEventListener('click', toggleSidebar); } else { console.warn("#collapse-toggle no encontrado."); }
            if (logoutButton) { logoutButton.addEventListener('click', handleLogout); } else { console.warn("#logout-button no encontrado."); }

            if (contentArea) {
                contentArea.addEventListener('click', (event) => {
                    const actionButton = event.target.closest('button[data-action]');
                    if (actionButton) {
                        const action = actionButton.dataset.action;
                        const type = actionButton.dataset.type;
                        const indexStr = actionButton.dataset.index;
                        const index = parseInt(indexStr, 10);
                        // Permitir generate-pdf sin √≠ndice v√°lido temporalmente si es necesario
                        if (isNaN(index) && action !== 'generate-pdf') { console.error("Idx inv√°lido:", indexStr); return; }
                        console.log(`Clic en acci√≥n - Acci√≥n: ${action}, Tipo: ${type}, √çndice: ${index}`);
                        if (type === 'user') { if (action === 'delete') { deleteUser(index); } else if (action === 'edit') { populateUserEditForm(index); } }
                        else if (type === 'tramite' && action === 'delete') { deleteTramite(index); }
                        else if (type === 'autorizacion' && action === 'delete') { deleteAutorizacion(index); }
                        else if (action === 'generate-pdf') { generatePdf(type, index); }
                        else { console.warn(`Acci√≥n/Tipo no manejado: ${action}/${type}`); }
                    }
                });
            } else { console.error("#content-area no encontrado."); }

            showLoginScreen();

        }); // Fin DOMContentLoaded

    </script>
</body>
</html>
