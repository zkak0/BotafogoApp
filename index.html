<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deportivo Botafogo - App Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" xintegrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script> 
    <style>
        /* --- Estilos CSS Actualizados --- */
        :root {
            --bg-primary: #f3f4f6; /* Tailwind gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-sidebar: #e5e7eb; /* Tailwind gray-200 */
            --bg-sidebar-hover: #d1d5db; /* Tailwind gray-300 */
            --text-primary: #1f2937; /* Tailwind gray-800 */
            --text-secondary: #6b7280; /* Tailwind gray-500 */
            --text-sidebar: #374151; /* Tailwind gray-700 */
            --text-sidebar-title: #111827; /* Tailwind gray-900 */
            --text-sidebar-hover: #111827; /* Tailwind gray-900 */
            --border-color: #cbd5e1; /* Tailwind slate-300 - More visible general borders */
            --border-input: #94a3b8; /* Tailwind slate-400 - Clearly marked input borders */
            --border-input-focus: #2563eb; /* Tailwind blue-600 */
            --shadow-color: rgba(0, 0, 0, 0.15); /* Slightly more pronounced shadows */
            --link-color: #2563eb; /* Tailwind blue-600 */
            --link-hover-color: #1d4ed8; /* Tailwind blue-700 */
            --button-action-bg: #2563eb; /* Tailwind blue-600 */
            --button-action-hover-bg: #1d4ed8; /* Tailwind blue-700 */
            --sidebar-border-color: #cbd5e1; /* Tailwind slate-300 */
            --button-green-bg: #16a34a; /* Tailwind green-600 */
            --button-green-hover-bg: #15803d; /* Tailwind green-700 */
            --button-cancel-text: #4b5563; /* Tailwind gray-600 */
            --button-cancel-hover-bg: #f3f4f6; /* Tailwind gray-100 */
            --button-generic-bg: #e5e7eb; /* Tailwind gray-200 */
            --button-generic-hover-bg: #d1d5db; /* Tailwind gray-300 */
            --slider-track-bg: #d1d5db; /* Tailwind gray-300 */
        }
        html.dark {
            --bg-primary: #0f172a; /* Tailwind slate-900 - Very dark blue-gray */
            --bg-secondary: #1e293b; /* Tailwind slate-800 - Cards, modals */
            --bg-sidebar: #1e293b; /* Tailwind slate-800 */
            --bg-sidebar-hover: #334155; /* Tailwind slate-700 */
            --text-primary: #f1f5f9; /* Tailwind slate-100 - Light text */
            --text-secondary: #94a3b8; /* Tailwind slate-400 - Softer secondary text */
            --text-sidebar: #cbd5e1; /* Tailwind slate-300 */
            --text-sidebar-title: #f1f5f9; /* Tailwind slate-100 */
            --text-sidebar-hover: #ffffff; /* white */
            --border-color: #334155; /* Tailwind slate-700 - Visible borders */
            --border-input: #475569; /* Tailwind slate-600 - Clearer input borders */
            --border-input-focus: #60a5fa; /* Tailwind blue-400 */
            --shadow-color: rgba(0, 0, 0, 0.3); /* Darker, defined shadows */
            --link-color: #93c5fd; /* Tailwind blue-300 - Brighter blue links */
            --link-hover-color: #60a5fa; /* Tailwind blue-400 */
            --button-action-bg: #2563eb; /* Tailwind blue-600 - Vibrant */
            --button-action-hover-bg: #1d4ed8; /* Tailwind blue-700 */
            --sidebar-border-color: #334155; /* Tailwind slate-700 */
            --button-green-bg: #22c55e; /* Tailwind green-500 */
            --button-green-hover-bg: #16a34a; /* Tailwind green-600 */
            --button-cancel-text: #cbd5e1; /* Tailwind slate-300 */
            --button-cancel-hover-bg: #334155; /* Tailwind slate-700 */
            --button-generic-bg: #334155; /* Tailwind slate-700 */
            --button-generic-hover-bg: #475569; /* Tailwind slate-600 */
            --slider-track-bg: #475569; /* Tailwind slate-600 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        #login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-primary); }
        .login-box { background-color: var(--bg-secondary); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); padding: 2.5rem; border-radius: 0.5rem; width: 100%; max-width: 28rem; text-align: center;}
        .login-logo { max-width: 200px; height: auto; margin-bottom: 1.5rem; margin-left: auto; margin-right: auto; }
        .login-input { border: 1px solid var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); appearance: none; display: block; width: 100%; padding: 0.75rem; border-radius: 0.375rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); margin-bottom: 1rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;}
        .login-input::placeholder { color: var(--text-secondary); }
        .login-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 3px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); } /* Updated to use RGB for focus shadow if needed */
        html.dark .login-input:focus { box-shadow: 0 0 0 3px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        .login-button { display: inline-flex; justify-content: center; width: 100%; padding: 0.75rem 1rem; border: 1px solid transparent; background-color: var(--button-action-bg); color: white; font-weight: 600; font-size: 0.875rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; transition: background-color 0.15s ease-in-out; }
        .login-button:hover { background-color: var(--button-action-hover-bg); }
        .login-error { color: #dc2626; min-height: 1.25rem; }
        #app-screen { display: none; }
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-sidebar); transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar-title { color: var(--text-sidebar-title); font-weight: 700; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav ul li a { padding: 10px 16px; display: flex; align-items: center; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-sidebar); border-radius: 0.375rem; }
        .sidebar-nav ul li a i { margin-right: 10px; font-size: 1.25rem; width: 20px; text-align: center; }
        .sidebar-nav ul li a:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        .sidebar .border-t { border-color: var(--sidebar-border-color); }
        .collapse-button { color: var(--text-sidebar); }
        .collapse-button:hover { color: var(--text-sidebar-hover); }
        #logout-button { color: var(--text-sidebar); padding-top: 0.75rem; padding-bottom: 0.75rem; }
        #logout-button:hover { background-color: var(--bg-sidebar-hover); color: var(--text-sidebar-hover); }
        aside.sidebar-collapsed { width: 80px !important; padding-left: 10px; padding-right: 10px; }
        .sidebar-collapsed .menu-item-text span { display: none; }
        .sidebar-collapsed .sidebar-nav ul li a { justify-content: center; padding: 10px 0; }
        .sidebar-collapsed .sidebar-nav ul li a i { margin-right: 0; }
        .sidebar-collapsed .sidebar-title { display: none; }
        .sidebar-collapsed #logout-button span { display: none; }
        .sidebar-collapsed #logout-button i { margin-right: 0; }
        .flex-container { display: flex; }
        .flex-main { flex-grow: 1; position: relative; background-color: var(--bg-primary); }
        #main-title { color: var(--text-primary); }
        #content-area p { color: var(--text-secondary); }
        #content-area .bg-white { background-color: var(--bg-secondary); }
        #content-area h2 { color: var(--text-primary); }
        #content-area label, #content-area span { color: var(--text-primary); }
        #content-area .text-gray-500 { color: var(--text-secondary); } /* Will be overridden by specific dark mode styles if needed */
        #content-area .bg-gray-50 { background-color: var(--bg-primary); border-color: var(--border-color); } /* Will be overridden by specific dark mode styles if needed */
        #content-area table { border-color: var(--border-color); } /* Use general border color for tables */
        #content-area thead { background-color: var(--bg-secondary); } 
        html.dark #content-area thead { background-color: var(--bg-primary); } 
        #content-area th { color: var(--text-secondary); border-color: var(--border-color); font-weight: 600; }
        #content-area tbody { background-color: var(--bg-secondary); }
        #content-area tbody tr { border-bottom: 1px solid var(--border-color); }
        #content-area tbody tr:last-child { border-bottom: none; }
        #content-area td { color: var(--text-primary); border-color: var(--border-color); }
        #content-area tr:hover { background-color: var(--bg-primary); } /* Light mode table row hover */
        html.dark #content-area tr:hover { background-color: #334155; } /* Tailwind slate-700 for dark mode table row hover */
        ::placeholder { color: var(--text-secondary); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-secondary); }
        ::-ms-input-placeholder { color: var(--text-secondary); }
        .action-button { cursor: pointer; transition: color 0.15s ease-in-out; background: none; border: none; padding: 0.25rem 0.5rem;}
        .hidden-file-input { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-label { cursor: pointer; display: inline-flex; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        .file-input-label:hover { background-color: var(--bg-primary); }
        .file-input-label i { margin-right: 0.5rem; }
        .form-input-base { display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); color: var(--text-primary); background-color: var(--bg-secondary); font-size: 0.875rem; }
        .form-input-base::placeholder { color: var(--text-secondary); }
        .form-input-base:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); }
        html.dark .form-input-base:focus { box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; appearance: none; }
        html.dark .form-select-base { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); } /* Updated dark mode select arrow color */
        .edit-user-button { background-color: #fbbf24; color: #78350f; }
        .edit-user-button:hover { background-color: #f59e0b; }
        html.dark .edit-user-button { background-color: #fcd34d; color: #78350f; }
        html.dark .edit-user-button:hover { background-color: #fbbf24; }
        #add-user-error, #foto-carnet-message, #cedula-message { min-height: 1.25rem; margin-top: 0.5rem;} 
        .action-button[data-action="generate-pdf"] { color: var(--link-color); }
        .action-button[data-action="generate-pdf"]:hover { color: var(--link-hover-color); }
        .action-button[data-action="edit"] { color: #ca8a04; } 
        .action-button[data-action="edit"]:hover { color: #a16207; } 
        html.dark .action-button[data-action="edit"] { color: #fcd34d; } 
        html.dark .action-button[data-action="edit"]:hover { color: #fbbf24; } 
        .action-button[data-action="delete"], .delete-btn { color: #dc2626; } 
        .action-button[data-action="delete"]:hover, .delete-btn:hover { color: #b91c1c; } 
        html.dark .action-button[data-action="delete"], html.dark .delete-btn { color: #f87171; } 
        html.dark .action-button[data-action="delete"]:hover, html.dark .delete-btn:hover { color: #ef4444; } /* Adjusted dark mode delete hover */
        #form-tramite button[type=submit], #form-autorizacion button[type=submit], #form-add-user #user-submit-button[class*="bg-green"], #preview-foto-carnet-button, #save-foto-carnet-button { background-color: var(--button-action-bg); color: white; }
        #form-tramite button[type=submit]:hover, #form-autorizacion button[type=submit]:hover, #form-add-user #user-submit-button[class*="bg-green"]:hover, #preview-foto-carnet-button:hover, #save-foto-carnet-button:hover { background-color: var(--button-action-hover-bg); }
        #form-add-user #user-submit-button { background-color: var(--button-green-bg); color: white; }
        #form-add-user #user-submit-button:hover { background-color: var(--button-green-hover-bg); }
        #form-add-user #user-cancel-button { border: 1px solid var(--border-input); background-color: var(--bg-secondary); color: var(--text-secondary); } /* Ensure border for cancel button */
        #form-add-user #user-cancel-button:hover { background-color: var(--bg-primary); }
        .cropper-container-wrapper { max-width: 500px; height: 400px; margin-top: 0.5rem; border: 1px dashed var(--border-color); background-color: var(--bg-primary); }
        #cropper-image { display: block; max-width: 100%; max-height: 100%; }
        .result-canvas-container { margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-input); background-color: var(--bg-primary); border-radius: 0.375rem; text-align: center; min-height: 150px; }
        #result-canvas { border: 1px solid var(--border-color); max-width: 100%; height: auto; display: none; margin: 0 auto; }
        .button-group button, .button-group .file-input-label { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .button-group button:last-child, .button-group .file-input-label:last-child { margin-right: 0; }
        .form-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .single-char-input { width: 2.25rem; height: 2.25rem; text-align: center; padding: 0.25rem; margin-left: 0.25rem; margin-right: 0.5rem; border-width: 1px; border-radius: 0.375rem; border-color: var(--border-input); background-color: var(--bg-secondary); color: var(--text-primary); text-transform: uppercase; font-size: 0.875rem; }
        .single-char-input:focus { outline: none; border-color: var(--border-input-focus); box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 37, 99, 235), 0.3); }
        html.dark .single-char-input:focus { box-shadow: 0 0 0 2px rgba(var(--border-input-focus-rgb, 96, 165, 250), 0.3); }

        #dark-mode-toggle { position: fixed; top: 1rem; right: 1rem; background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 9999px; padding: 0.5rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; z-index: 50; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; }
        #dark-mode-toggle:hover { background-color: var(--bg-primary); color: var(--text-primary); }
        #dark-mode-toggle i { font-size: 1.1rem; }
        .perspective-canvas-wrapper { width: 100%; max-width: 500px; height: 350px; margin: 1rem auto; border: 1px solid var(--border-input); background-color: var(--bg-secondary); border-radius: 0.375rem; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .perspective-canvas-wrapper canvas { max-width: 100%; max-height: 100%; cursor: crosshair; }
        #cedula-identidad-section .button-group button,
        #cedula-identidad-section .file-input-label-cedula { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); padding: 0.5rem 1rem; border-radius: 0.375rem; margin: 0.25rem; transition: all 0.2s ease; cursor: pointer; display: inline-flex; align-items: center; }
        #cedula-identidad-section .button-group button:hover,
        #cedula-identidad-section .file-input-label-cedula:hover { background-color: var(--button-generic-hover-bg); }
        #cedula-identidad-section #ci-perspective-save-btn,
        #cedula-identidad-section #ci-generate-cedula-pdf-btn { background-color: var(--button-action-bg) !important; color: white !important; }
        #cedula-identidad-section #ci-generate-cedula-pdf-btn[disabled] { background-color: var(--button-generic-bg) !important; color: var(--text-secondary) !important; opacity: 0.5; }
        #cedula-identidad-section #ciCanvasPlaceholderCedula { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); background-color: var(--bg-secondary); }
        .saved-images-container { margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--border-color); }
        .saved-image-item { display: inline-block; margin: 0.5rem; text-align: center; }
        .saved-image-preview { width: 120px; height: auto; max-height: 80px; object-fit: contain; border: 1px solid var(--border-input); margin-bottom: 0.5rem; background-color: var(--bg-primary); }
        .list-thumbnail { max-width: 80px; max-height: 60px; height: auto; object-fit: cover; border-radius: 0.25rem; border: 1px solid var(--border-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--bg-secondary); color: var(--text-primary); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 90%; width: 400px; }
        .modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .modal-content p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal-buttons button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #confirm-delete-btn { background-color: #dc2626; color: white; margin-right: 0.5rem; }
        #confirm-delete-btn:hover { background-color: #b91c1c; }
        #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border: 1px solid var(--border-input); }
        #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }
        html.dark #confirm-delete-btn { background-color: #f87171; }
        html.dark #confirm-delete-btn:hover { background-color: #ef4444; }
        html.dark #cancel-delete-btn { background-color: var(--button-generic-bg); color: var(--text-primary); border-color: var(--border-input); }
        html.dark #cancel-delete-btn:hover { background-color: var(--button-generic-hover-bg); }

        .adjustment-control { display: flex; flex-direction: column; gap: 0.25rem; padding: 0.75rem; border: 1px solid var(--border-input); border-radius: 0.375rem; background-color: var(--bg-secondary); }
        .slider { width: 100%; height: 0.5rem; border-radius: 0.5rem; -webkit-appearance: none; appearance: none; cursor: pointer; background-color: var(--slider-track-bg); }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 9999px; background-color: var(--button-action-bg); cursor: pointer; border: 2px solid var(--bg-secondary); box-shadow: 0 0 2px rgba(0,0,0,0.3); }
        .slider::-moz-range-thumb { width: 1rem; height: 1rem; border-radius: 9999px; background-color: var(--button-action-bg); cursor: pointer; border: 2px solid var(--bg-secondary); box-shadow: 0 0 2px rgba(0,0,0,0.3); }
        
        /* Estilos para layout de dos columnas en Foto Carnet */
        .foto-carnet-layout {
            /* display: flex; Ya no es flex container principal */
            /* flex-wrap: wrap; */
            /* gap: 1.5rem; */
        }
        .foto-carnet-col-main {
            /* flex: 2; */
            /* min-width: 300px; */
        }
        .foto-carnet-col-sidebar { 
            /* Ya no se usa para los controles de ajuste principales */
        }
        .foto-carnet-ajustes-container { 
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--border-input);
            border-radius: 0.375rem;
            background-color: var(--bg-secondary);
        }
        .foto-carnet-ajustes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

    </style>
</head>
<body class="bg-primary">
    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.imgur.com/IAVAqup.jpeg" alt="[Imagen del] Logo Botafogo" class="login-logo" onerror="this.src='https://placehold.co/200x100/cccccc/333333?text=LOGO'; this.onerror=null;">
            <h2 class="text-2xl font-bold text-primary mb-6">Bienvenido a BotafogoApp v3</h2> <form id="login-form">
                <div>
                    <label for="username" class="sr-only">Usuario (RUT)</label>
                    <input type="text" id="username" name="username" class="login-input" placeholder="Usuario (RUT)" required>
                </div>
                <div>
                    <label for="password" class="sr-only">Clave</label>
                    <input type="password" id="password" name="password" class="login-input" placeholder="Clave" required>
                </div>
                <div id="login-error-message" class="login-error mt-2 text-sm"></div>
                <button type="submit" class="login-button mt-4">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="min-h-screen flex-container">
        <aside class="w-64 bg-sidebar text-sidebar p-6 space-y-6 rounded-r-lg flex flex-col justify-between sidebar" id="sidebar">
            <div>
                <div class="text-2xl font-bold mb-6 sidebar-title text-sidebar-title">BotafogoApp v3</div> <nav class="sidebar-nav">
                    <ul class="space-y-2">
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-tramite"><i class="fas fa-file-contract text-lg"></i> <span>Tr√°mite Individual</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-autorizacion"><i class="fas fa-file-signature text-lg"></i> <span>Autorizaci√≥n</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-fotocarnet"><i class="fas fa-id-badge text-lg"></i> <span>Foto Carnet</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-cedula-identidad"><i class="fas fa-id-card text-lg"></i> <span>C√©dula de Identidad</span></a></li>
                        <li><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-lista"><i class="fas fa-list-alt text-lg"></i> <span>Tramites Guardados</span></a></li>
                        <li id="li-menu-usuarios"><a href="#" class="block rounded transition duration-200 px-4 py-2.5 text-sm font-medium hover:bg-sidebar-hover hover:text-sidebar-hover menu-item-text" id="menu-usuarios"><i class="fas fa-users-cog text-lg"></i> <span>Gesti√≥n Usuarios</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="border-t border-t-sidebar-border pt-4 mt-4 flex flex-col items-center">
                <button class="text-sidebar hover:text-sidebar-hover focus:outline-none collapse-button mb-4" id="collapse-toggle" title="Colapsar/Expandir Men√∫">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <button class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-md text-sidebar hover:bg-sidebar-hover hover:text-sidebar-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-sidebar focus:ring-white" id="logout-button">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-8 flex-main bg-primary overflow-y-auto">
            <button id="dark-mode-toggle" title="Cambiar modo claro/oscuro" class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-moon"></i>
            </button>
            <h1 class="text-3xl font-bold mb-6 text-primary" id="main-title">Bienvenido</h1>
            <div id="content-area" class="text-secondary">
                <p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>
            </div>
        </main>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmar Eliminaci√≥n</h3>
            <p id="delete-modal-message">¬øEst√°s seguro de que deseas eliminar este elemento?</p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn">Confirmar Eliminaci√≥n</button>
                <button id="cancel-delete-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN SUPABASE ==========
        const SUPABASE_URL = 'https://nqwdsutnoscagzsgpssv.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2RzdXRub3NjYWd6c2dwc3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2MTExMTYsImV4cCI6MjA2MzE4NzExNn0.3uiBrCxxwfuNYotqkYF68yp-XthI8jZt3obxVa2l2us'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Datos Globales ---
        let cropperInstance = null;
        let isCropperScriptLoaded = false;
        let itemToDelete = { id: null, type: null, name: '' };
        // Ajustes para Foto Carnet
        let fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };


        // --- Funciones Auxiliares ---
        function isValidEmail(email) { // Aunque no se usa para login, puede ser √∫til para validaci√≥n de email en gesti√≥n de usuarios
            if (!email || typeof email !== 'string') return false;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function formatRut(rutInput) {
            if (!rutInput) return;
            let rut = rutInput.value.replace(/[^0-9kK]/g, '').toLowerCase();
            let formattedRut = '';
            if (rut.length > 1) {
                let dv = rut.slice(-1);
                let body = rut.slice(0, -1);
                let bodyFormatted = "";
                while (body.length > 3) {
                    bodyFormatted = "." + body.slice(-3) + bodyFormatted;
                    body = body.slice(0, -3);
                }
                bodyFormatted = body + bodyFormatted;
                formattedRut = bodyFormatted + '-' + dv;
            } else {
                formattedRut = rut;
            }
            rutInput.value = formattedRut.toUpperCase();
        }

        function formatUsernameRut(rutInput) { 
            if (!rutInput) return;
            let value = rutInput.value.replace(/[^0-9kK-]/g, ''); 
            const parts = value.split('-');
            let body = parts[0].replace(/[^0-9kK]/g, ''); 
            let dv = '';
            if (parts.length > 1) {
                dv = parts.slice(1).join('').replace(/[^0-9kK]/g, ''); 
                if (dv.length > 1) dv = dv.charAt(0); 
            }
            value = body;
            if (dv.match(/^[0-9kK]$/i)) { 
                value += '-' + dv;
            } else if (dv) { 
                 value = body;
            }
            rutInput.value = value.toUpperCase();
        }
        
        function formatLoginUsername(inputElement) { 
            if (!inputElement) return;
            let value = inputElement.value;
            value = value.replace(/[^0-9kK-]/gi, ""); 
            let firstHyphenIndex = value.indexOf('-');
            if (firstHyphenIndex !== -1) {
                let part1 = value.substring(0, firstHyphenIndex + 1);
                let part2 = value.substring(firstHyphenIndex + 1).replace(/-/g, "");
                value = part1 + part2;
            }
            inputElement.value = value.toUpperCase();
        }

        function formatFechaNacimiento(dateInput) {
            if (!dateInput) return;
            let date = dateInput.value.replace(/[^0-9]/g, '');
            let formattedDate = '';
            if (date.length >= 2) {
                formattedDate += date.substring(0, 2);
                if (date.length >= 4) {
                    formattedDate += '-' + date.substring(2, 4);
                    if (date.length >= 8) {
                        formattedDate += '-' + date.substring(4, 8);
                    } else if (date.length > 4) {
                        formattedDate += '-' + date.substring(4);
                    }
                } else if (date.length > 2) {
                    formattedDate += '-' + date.substring(2);
                }
            } else {
                formattedDate = date;
            }
            dateInput.value = formattedDate.substring(0, 10);
        }
        
        function showTemporaryMessage(elementId, message, isError = false, duration = 3000) {
            const messageDiv = document.getElementById(elementId);
            if (messageDiv) {
                messageDiv.textContent = message;
                messageDiv.className = `text-sm mt-2 min-h-[1.25rem] ${isError ? 'text-red-600' : 'text-green-600'}`;
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'text-sm mt-2 min-h-[1.25rem]'; 
                }, duration);
            }
        }

        // --- Funciones del Modal de Confirmaci√≥n ---
        function showDeleteConfirmModal(id, type, itemName) {
            itemToDelete = { id, type, name: itemName };
            const modal = document.getElementById('delete-confirm-modal');
            const messageElement = document.getElementById('delete-modal-message');
            messageElement.textContent = `¬øEst√°s seguro de que deseas eliminar "${itemName}"? Esta acci√≥n no se puede deshacer.`;
            if (modal) modal.style.display = 'flex';
        }

        function hideDeleteConfirmModal() {
            const modal = document.getElementById('delete-confirm-modal');
            if (modal) modal.style.display = 'none';
            itemToDelete = { id: null, type: null, name: '' }; 
        }

        async function proceedWithDeletion() {
            if (!itemToDelete.id || !itemToDelete.type) return;
            console.log(`[proceedWithDeletion] Confirmado. Eliminando ${itemToDelete.type} con ID: ${itemToDelete.id}`);

            let error;
            let tableName = '';
            let idField = 'id'; 

            switch (itemToDelete.type) {
                case 'user':
                    tableName = 'users'; // Tabla public.users
                    idField = 'username'; // Se elimina por username (RUT) de public.users
                    break;
                case 'tramite':
                    tableName = 'players';
                    break;
                case 'autorizacion':
                    tableName = 'autorizaciones';
                    break;
                case 'fotocarnet': 
                    tableName = 'fotocarnets';
                    break;
                case 'cedula': 
                    tableName = 'cedulas_identidad';
                    break;
                default:
                    console.error("Tipo de eliminaci√≥n desconocido:", itemToDelete.type);
                    hideDeleteConfirmModal();
                    return;
            }

            const { error: deleteError } = await supabaseClient
                .from(tableName)
                .delete()
                .eq(idField, itemToDelete.id);
            error = deleteError;

            if (error) {
                console.error(`[proceedWithDeletion] Error de Supabase al eliminar ${itemToDelete.type}:`, error);
                const modalMessage = document.getElementById('delete-modal-message');
                if(modalMessage) modalMessage.textContent = `Error al eliminar: ${error.message}. Int√©ntalo de nuevo.`;
                // No ocultar modal en error para que el usuario vea el mensaje
            } else {
                console.log(`[proceedWithDeletion] ${itemToDelete.type} eliminado de Supabase:`, itemToDelete.id);
                if (itemToDelete.type === 'user') {
                    renderUserManagementForm(); // Recargar lista de usuarios
                } else { 
                    renderPlayerList(); // Recargar lista de jugadores/autorizaciones/etc.
                }
                hideDeleteConfirmModal(); // Ocultar modal solo si tiene √©xito
            }
        }
        
        // --- Funciones de Navegaci√≥n y Estado de la UI ---
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            const menuUsuariosLi = document.getElementById('li-menu-usuarios');
            if (menuUsuariosLi) {
                menuUsuariosLi.style.display = 'none';
            }
        }

        function showAppScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if(mainTitle) mainTitle.innerText = 'Bienvenido';
            if(contentArea) contentArea.innerHTML = '<p class="text-lg">Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>';
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Volvemos a usar currentUser
            const menuUsuariosLi = document.getElementById('li-menu-usuarios');
            if (menuUsuariosLi) {
                menuUsuariosLi.style.display = (currentUser && currentUser.role === 'admin') ? 'list-item' : 'none';
            }
        }

        // --- Funciones de Renderizado de Contenido ---
        function downloadDataUrlAsPdf(dataUrl, filename) { // Para PDF
            if (!dataUrl) return;
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadDataUrlAsImage(dataUrl, filename) { // Para Imagen (ej. PNG)
            if (!dataUrl) return;
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename; // Ej: "foto_carnet.png"
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function renderPlayerList() { 
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); 
            if (!currentUser) { showLoginScreen(); return; }

            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Tramites Guardados'; 

            let listHtml = `<div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md space-y-8">`; 

            // --- Secci√≥n Tr√°mites Individuales ---
            let playersQuery = supabaseClient.from('players').select('*');
            if (currentUser && currentUser.role !== 'admin') { 
                playersQuery = playersQuery.eq('user_id', currentUser.id); 
            }
            const { data: playersData, error: playersError } = await playersQuery;
            
            listHtml += `
                <div class="p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Tr√°mites Individuales</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary dark:bg-gray-700"> <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">C√©dula</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Paterno</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">A. Materno</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombres</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Fec. Nac.</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th>
                                ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                            </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;
            if (playersError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '7' : '6'}" class="px-6 py-4 text-center text-red-500">Error cargando tr√°mites: ${playersError.message}</td></tr>`;
            } else if (!playersData || playersData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '7' : '6'}" class="px-6 py-4 text-center text-secondary">No hay tr√°mites registrados.</td></tr>`;
            } else {
                playersData.forEach((p) => {
                    listHtml += `<tr class="hover:bg-primary dark:hover:bg-gray-700">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.ci || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellido_paterno || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.apellido_materno || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.nombres || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${p.fecha_nac || ''}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color"><button class="action-button" data-action="generate-pdf" data-type="tramite" data-id="${p.id}" title="Generar PDF Tr√°mite"><i class="fas fa-file-pdf fa-lg"></i></button></td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${p.id}" data-type="tramite" data-name="${p.nombres || p.ci}" title="Eliminar Tr√°mite">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;

            // --- Secci√≥n Autorizaciones ---
            let autorizacionesQuery = supabaseClient.from('autorizaciones').select('*');
            if (currentUser && currentUser.role !== 'admin') { 
                autorizacionesQuery = autorizacionesQuery.eq('user_id', currentUser.id); 
            }
            const { data: autorizacionesData, error: authError } = await autorizacionesQuery;
            listHtml += `
                <div class="p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Autorizaciones</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Apoderado</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">CI Apod.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Jugador</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Parentesco</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">PDF</th>
                                    ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;
            if (authError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '6' : '5'}" class="px-6 py-4 text-center text-red-500">Error cargando autorizaciones: ${authError.message}</td></tr>`;
            } else if (!autorizacionesData || autorizacionesData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '6' : '5'}" class="px-6 py-4 text-center text-secondary">No hay autorizaciones registradas.</td></tr>`;
            } else {
                autorizacionesData.forEach((a) => {
                    listHtml += `<tr class="hover:bg-primary dark:hover:bg-gray-700">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderado_nombre || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.apoderado_ci || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.jugador_nombre || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${a.parentesco || ''}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color"><button class="action-button" data-action="generate-pdf" data-type="autorizacion" data-id="${a.id}" title="Generar PDF Autorizaci√≥n"><i class="fas fa-file-pdf fa-lg"></i></button></td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${a.id}" data-type="autorizacion" data-name="${a.jugador_nombre || 'Autorizaci√≥n'}" title="Eliminar Autorizaci√≥n">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;

            // --- Secci√≥n Fotos Carnet ---
            let fotocarnetsQuery = supabaseClient.from('fotocarnets').select('*');
            if (currentUser && currentUser.role !== 'admin') {
                fotocarnetsQuery = fotocarnetsQuery.eq('user_id', currentUser.id); 
            }
            const { data: fotocarnetsData, error: fotocarnetsError } = await fotocarnetsQuery;
            listHtml += `
                <div class="p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">Fotos Carnet</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Jugador</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">RUT Jugador</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Fecha Creaci√≥n</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Descargar</th>
                                    ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;
            if (fotocarnetsError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '5' : '4'}" class="px-6 py-4 text-center text-red-500">Error cargando fotos carnet: ${fotocarnetsError.message}</td></tr>`;
            } else if (!fotocarnetsData || fotocarnetsData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '5' : '4'}" class="px-6 py-4 text-center text-secondary">No hay fotos carnet guardadas.</td></tr>`;
            } else {
                fotocarnetsData.forEach((fc) => {
                    const createdAt = fc.created_at ? new Date(fc.created_at).toLocaleDateString('es-CL') : 'N/A';
                    const downloadImageFilename = `fotocarnet_${(fc.nombre_completo_jugador || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date(fc.created_at || Date.now()).toISOString().split('T')[0]}.png`;
                    listHtml += `<tr class="hover:bg-primary dark:hover:bg-gray-700">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${fc.nombre_completo_jugador || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${fc.rut_jugador || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${createdAt}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color">
                                        <button class="action-button" onclick="downloadDataUrlAsImage('${fc.imagen_dataurl}', '${downloadImageFilename}')" title="Descargar Foto Carnet">
                                            <i class="fas fa-download fa-lg"></i>
                                        </button>
                                    </td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${fc.id}" data-type="fotocarnet" data-name="Foto de ${fc.nombre_completo_jugador}" title="Eliminar Foto Carnet">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;

            // --- Secci√≥n C√©dulas de Identidad ---
            let cedulasQuery = supabaseClient.from('cedulas_identidad').select('*');
            if (currentUser && currentUser.role !== 'admin') {
                cedulasQuery = cedulasQuery.eq('user_id', currentUser.id); 
            }
            const { data: cedulasData, error: cedulasError } = await cedulasQuery;

            listHtml += `
                <div class="p-4 border border-border-color rounded-lg bg-primary">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-primary">C√©dulas de Identidad</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-secondary dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Jugador</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Fecha Creaci√≥n</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Descargar PDF</th>
                                    ${currentUser.role === 'admin' ? '<th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;
            if (cedulasError) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '4' : '3'}" class="px-6 py-4 text-center text-red-500">Error cargando c√©dulas: ${cedulasError.message}</td></tr>`;
            } else if (!cedulasData || cedulasData.length === 0) {
                listHtml += `<tr><td colspan="${currentUser.role === 'admin' ? '4' : '3'}" class="px-6 py-4 text-center text-secondary">No hay c√©dulas de identidad guardadas.</td></tr>`;
            } else {
                cedulasData.forEach((cd) => {
                    const createdAt = cd.created_at ? new Date(cd.created_at).toLocaleDateString('es-CL') : 'N/A';
                    const downloadFilename = `cedula_${(cd.nombre_jugador || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date(cd.created_at || Date.now()).toISOString().split('T')[0]}.pdf`;
                    listHtml += `<tr class="hover:bg-primary dark:hover:bg-gray-700">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${cd.nombre_jugador || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${createdAt}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color">
                                        <button class="action-button" onclick="downloadDataUrlAsPdf('${cd.pdf_dataurl}', '${downloadFilename}')" title="Descargar PDF C√©dula">
                                            <i class="fas fa-file-pdf fa-lg"></i> </button>
                                    </td>
                                    ${currentUser.role === 'admin' ? 
                                    `<td class="px-4 py-4 text-center"><button class="action-button delete-btn" data-action="delete" data-id="${cd.id}" data-type="cedula" data-name="C√©dula de ${cd.nombre_jugador}" title="Eliminar C√©dula">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button></td>` : ''}
                                </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;

            listHtml += `</div>`; 
            contentArea.innerHTML = listHtml;
        }

        function renderTramiteForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Tr√°mite Individual';
            const inputBaseClasses = "form-input-base";
            const singleCharInputClasses = "single-char-input";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Jugador</h2>
                    <form id="form-tramite">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label for="ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                                <input type="text" id="ci" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                            <div>
                                <label for="fecha-nac" class="block text-sm font-medium text-secondary mb-1">Fecha Nacimiento:</label>
                                <input type="text" id="fecha-nac" class="${inputBaseClasses}" placeholder="dd-mm-aaaa" required maxlength="10">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="apellido-paterno" class="block text-sm font-medium text-secondary mb-1">Apellido Paterno:</label>
                                <input type="text" id="apellido-paterno" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="apellido-materno" class="block text-sm font-medium text-secondary mb-1">Apellido Materno:</label>
                                <input type="text" id="apellido-materno" class="${inputBaseClasses}" required>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                            <input type="text" id="nombres" class="${inputBaseClasses}" required>
                        </div>
                        <div class="mb-6">
                            <span class="block text-sm font-medium text-secondary mb-2">Solicita (Marcar con 'X'):</span>
                            <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-3 items-center">
                                <div class="flex items-center"> <input type="text" id="solicita_inscripcion_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Inscripci√≥n</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_interno_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Interno</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_regional_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Regional</span> </div>
                                <div class="flex items-center"> <input type="text" id="solicita_pase_externo_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Pase Externo</span> </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <span class="block text-sm font-medium text-secondary mb-2">Categor√≠a (Marcar con 'X'):</span>
                            <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-x-4 gap-y-3 items-center">
                                <div class="flex items-center"> <input type="text" id="categoria_extranjero_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Extranjero</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_libertad_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Libertad Acci√≥n</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_adulto_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Adulto</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_femenina_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Femenina</span> </div>
                                <div class="flex items-center"> <input type="text" id="categoria_infantil_char" maxlength="1" class="${singleCharInputClasses}"> <span class="ml-2 text-sm text-primary">Infantil</span> </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="procede-club" class="block text-sm font-medium text-secondary mb-1">Procede del Club:</label>
                                <input type="text" id="procede-club" class="${inputBaseClasses}">
                            </div>
                            <div>
                                <label for="procede-asociacion" class="block text-sm font-medium text-secondary mb-1">Asociaci√≥n de Procedencia:</label>
                                <input type="text" id="procede-asociacion" class="${inputBaseClasses}">
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Tr√°mite</button>
                        </div>
                    </form>
                </div>`;
            const form = document.getElementById('form-tramite');
            if (form) form.addEventListener('submit', handleTramiteSubmit);
            const ciInput = document.getElementById('ci');
            if (ciInput) ciInput.addEventListener('input', () => formatRut(ciInput));
            const fechaNacInput = document.getElementById('fecha-nac');
            if (fechaNacInput) fechaNacInput.addEventListener('input', () => formatFechaNacimiento(fechaNacInput));
            const inputsToUpper = ['apellido-paterno', 'apellido-materno', 'nombres', 'procede-club', 'procede-asociacion'];
            inputsToUpper.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
            const singleCharInputs = document.querySelectorAll('.single-char-input');
            singleCharInputs.forEach(input => {
                input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
        }

        function renderAutorizacionForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Autorizaci√≥n de Jugadores';
            const inputBaseClasses = "form-input-base";
            const selectBaseClasses = inputBaseClasses + " form-select-base";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary">Datos del Autorizante</h2>
                    <form id="form-autorizacion">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                            <div class="md:col-span-2">
                                <label for="apoderado-nombre" class="block text-sm font-medium text-secondary mb-1">Nombre del Apoderado:</label>
                                <input type="text" id="apoderado-nombre" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="apoderado-ci" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                                <input type="text" id="apoderado-ci" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-end">
                            <div class="md:col-span-2">
                                <label for="jugador-nombre-auth" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador:</label>
                                <input type="text" id="jugador-nombre-auth" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="parentesco" class="block text-sm font-medium text-secondary mb-1">Parentesco:</label>
                                <select id="parentesco" class="${selectBaseClasses}" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hermana">Hermana</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Tutor Legal">Tutor Legal</option>
                                    <option value="Abuelo">Abuelo</option>
                                    <option value="Abuela">Abuela</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Guardar Autorizaci√≥n</button>
                        </div>
                    </form>
                </div>`;
            const form = document.getElementById('form-autorizacion');
            if (form) form.addEventListener('submit', handleAutorizacionSubmit);
            const apoderadoCiInput = document.getElementById('apoderado-ci');
            if (apoderadoCiInput) apoderadoCiInput.addEventListener('input', () => formatRut(apoderadoCiInput));
            ['apoderado-nombre', 'jugador-nombre-auth'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            });
        }

        async function renderUserManagementForm() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || currentUser.role !== 'admin') {
                const contentArea = document.getElementById('content-area');
                if (contentArea) contentArea.innerHTML = '<p class="text-red-500 text-center font-semibold p-4">Acceso restringido a administradores.</p>';
                return;
            }
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Gesti√≥n de Usuarios';
            const inputBaseClasses = "form-input-base";

            const { data: usersData, error: usersError } = await supabaseClient.from('users').select('*'); // Tabla public.users
            if (usersError) {
                contentArea.innerHTML = `<p class="text-red-500">Error cargando usuarios: ${usersError.message}</p>`;
                return;
            }

            // FORMULARIO DE GESTI√ìN DE USUARIOS (SIN CAMPO EMAIL_AUTH POR AHORA, YA QUE EL LOGIN NO LO USA)
            let formHtml = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md mb-8">
                    <h2 id="user-form-title" class="text-lg sm:text-xl font-semibold mb-4 text-primary">Agregar Nuevo Usuario</h2>
                    <form id="form-add-user">
                        <input type="hidden" id="edit-user-id" value=""> <div class="mb-4">
                            <label for="new-fullname" class="block text-sm font-medium text-secondary mb-1">Nombre Completo:</label>
                            <input type="text" id="new-fullname" class="${inputBaseClasses}" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                             <div>
                                <label for="new-username" class="block text-sm font-medium text-secondary mb-1">Usuario:</label>
                                <input type="text" id="new-username" class="${inputBaseClasses}" placeholder="Ej: 12345678-K" required>
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-secondary mb-1">Clave:</label>
                                <input type="password" id="new-password" class="${inputBaseClasses}" placeholder="(En blanco para no cambiar al editar)">
                            </div>
                            <div class="flex flex-col">
                                <button type="submit" id="user-submit-button" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2">
                                    <span id="user-submit-button-text">Agregar</span>
                                </button>
                                <button type="button" id="user-cancel-button" class="hidden w-full mt-2 inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Cancelar Edici√≥n
                                </button>
                            </div>
                        </div>
                         <div class="mb-4">
                            <label for="new-role" class="block text-sm font-medium text-secondary mb-1">Rol:</label>
                            <select id="new-role" class="${inputBaseClasses} form-select-base">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div id="add-user-error" class="text-sm mt-1 min-h-[1.25rem]"></div>
                    </form>
                </div>`;

            let listHtml = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">Usuarios Registrados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color border border-border-input">
                            <thead class="bg-primary dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Nombre Completo</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Usuario (RUT)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Rol</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider border-r border-border-color">Editar</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Eliminar</th>
                                </tr>
                            </thead>
                            <tbody class="bg-secondary divide-y divide-border-color">`;
            if (!usersData || usersData.length === 0) {
                listHtml += '<tr><td colspan="5" class="px-6 py-4 text-center text-secondary">No hay usuarios registrados.</td></tr>';
            } else {
                usersData.forEach((user) => { // user de public.users
                    listHtml += `<tr class="hover:bg-primary dark:hover:bg-gray-700">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.nombre_completo || ''}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.username}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-primary border-r border-border-color">${user.role || 'user'}</td>
                                    <td class="px-4 py-4 text-center border-r border-border-color">
                                        <button class="action-button" data-action="edit" data-type="user" data-id="${user.id}" title="Editar Usuario">
                                            <i class="fas fa-edit fa-lg"></i>
                                        </button>
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        <button class="action-button delete-btn" data-action="delete" data-type="user" data-id="${user.username}" data-name="${user.nombre_completo || user.username}" title="Eliminar Usuario de public.users">
                                            <i class="fas fa-user-times fa-lg"></i>
                                        </button>
                                    </td>
                                </tr>`;
                });
            }
            listHtml += `</tbody></table></div></div>`;
            contentArea.innerHTML = formHtml + listHtml;
            resetUserForm(); 
            const addUserForm = document.getElementById('form-add-user');
            if (addUserForm) addUserForm.addEventListener('submit', handleAddUserSubmit);
            const cancelEditButton = document.getElementById('user-cancel-button');
            if(cancelEditButton) cancelEditButton.addEventListener('click', resetUserForm);
            const newUsernameInput = document.getElementById('new-username');
            if (newUsernameInput) newUsernameInput.addEventListener('input', () => formatUsernameRut(newUsernameInput));
            const newFullnameInput = document.getElementById('new-fullname');
            if (newFullnameInput) newFullnameInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        }

        function renderFotoCarnetForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;

            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch (e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }
            fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };


            mainTitle.innerText = 'Generar Foto Carnet';
            const inputBaseClasses = "form-input-base";
            contentArea.innerHTML = `
                <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-5xl mx-auto">
                    <div class="form-section pt-0 border-t-0">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">1. Sube y Ajusta tu Foto</h2>
                        <div class="mb-4 button-group">
                            <input type="file" id="image-upload" class="hidden-file-input" accept="image/*">
                            <label for="image-upload" class="file-input-label">
                                <i class="fas fa-upload"></i> <span>Seleccionar Foto</span>
                            </label>
                        </div>
                        <div class="cropper-container-wrapper mb-4 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                             <img id="cropper-image" src="" alt=" Sube una imagen para empezar.">
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">2. Ingresa tus Datos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="foto-nombres" class="block text-sm font-medium text-secondary mb-1">Nombres:</label>
                                <input type="text" id="foto-nombres" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="foto-apellidos" class="block text-sm font-medium text-secondary mb-1">Apellidos:</label>
                                <input type="text" id="foto-apellidos" class="${inputBaseClasses}" required>
                            </div>
                            <div>
                                <label for="foto-rut" class="block text-sm font-medium text-secondary mb-1">C√©dula de Identidad:</label>
                                <input type="text" id="foto-rut" class="${inputBaseClasses}" placeholder="" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-primary">3. Previsualizaci√≥n y Ajustes</h2>
                        <div class="result-canvas-container mb-6">
                            <canvas id="result-canvas"></canvas>
                            <p id="canvas-placeholder" class="text-secondary">Aqu√≠ aparecer√° la foto generada.</p>
                        </div>
                        
                        <div class="foto-carnet-ajustes-container mb-6">
                            <h3 class="text-md font-medium text-primary mb-3 text-center">Ajustes de Imagen</h3>
                            <div class="foto-carnet-ajustes-grid">
                                <div class="adjustment-control">
                                    <label for="fcBrightness" class="block text-sm font-medium text-primary">Brillo: <span id="fcBrightnessValue">0</span>%</label>
                                    <input type="range" id="fcBrightness" min="-50" max="50" value="0" class="slider">
                                </div>
                                <div class="adjustment-control">
                                    <label for="fcContrast" class="block text-sm font-medium text-primary">Contraste: <span id="fcContrastValue">100</span>%</label>
                                    <input type="range" id="fcContrast" min="50" max="150" value="100" class="slider">
                                </div>
                                <div class="adjustment-control">
                                    <label for="fcSharpness" class="block text-sm font-medium text-primary">Nitidez: <span id="fcSharpnessValue">0</span>%</label>
                                    <input type="range" id="fcSharpness" min="0" max="100" value="0" class="slider">
                                </div>
                                </div>
                        </div>
                        <div class="button-group mb-4 flex justify-center">
                             <button type="button" id="preview-foto-carnet-button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50" disabled>
                                <i class="fas fa-eye mr-2"></i>Previsualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section text-center">
                         <button type="button" id="save-foto-carnet-button" class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" disabled>
                            <i class="fas fa-save mr-2"></i>Guardar Foto
                        </button>
                        <div id="foto-carnet-message" class="text-sm mt-2 min-h-[1.25rem]"></div>
                    </div>
                </div>`;
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js', setupFotoCarnetListeners);
        }
        
        function loadScript(src, callback) {
            const existingScript = document.querySelector(`script[src="${src}"]`);
            if (existingScript) {
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                const checkGlobalVar = (varName, cb) => {
                    if (typeof window[varName] !== 'undefined') { if (cb) cb(); }
                    else { setTimeout(() => checkGlobalVar(varName, cb), 100); }
                };
                if (src.includes('cropper')) checkGlobalVar('Cropper', callback);
                else if (src.includes('numeric')) checkGlobalVar('numeric', callback); 
                else if (callback) callback();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.defer = true;
            script.onload = () => {
                if (src.includes('cropper')) isCropperScriptLoaded = true;
                if (callback) callback();
            };
            script.onerror = () => {
                console.error(`Error al cargar el script: ${src}`);
                const contentArea = document.getElementById('content-area');
                if (contentArea) {
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'text-red-500 text-center font-bold p-4';
                    errorMsg.textContent = `Error cr√≠tico: No se pudo cargar la librer√≠a ${src.split('/').pop()}. Algunas funcionalidades podr√≠an no estar disponibles. Intente recargar la p√°gina.`;
                    contentArea.prepend(errorMsg);
                }
                if (src.includes('cropper')) {
                    const previewButton = document.getElementById('preview-foto-carnet-button');
                    if(previewButton) previewButton.disabled = true;
                    const cropperContainer = document.querySelector('.cropper-container-wrapper');
                    if(cropperContainer) cropperContainer.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: Herramienta de recorte no cargada.</p>';
                }
            };
            document.body.appendChild(script);
        }
        
        function setupFotoCarnetListeners() {
            if (typeof Cropper === 'undefined') {
                console.error("Cropper no est√° definido. La funcionalidad de recorte de imagen no estar√° disponible.");
                const cropperContainer = document.querySelector('.cropper-container-wrapper');
                if (cropperContainer) {
                    cropperContainer.innerHTML = '<p class="text-red-600 font-bold text-center p-4">Error: La herramienta de recorte de imagen no pudo cargarse. Intente recargar la p√°gina.</p>';
                }
                const previewButton = document.getElementById('preview-foto-carnet-button');
                if (previewButton) previewButton.disabled = true;
                const saveButton = document.getElementById('save-foto-carnet-button');
                if (saveButton) saveButton.disabled = true;
                return;
            }
            const imageUpload = document.getElementById('image-upload');
            const previewButton = document.getElementById('preview-foto-carnet-button');
            const saveButton = document.getElementById('save-foto-carnet-button');
            const rutInput = document.getElementById('foto-rut');
            const textInputs = ['foto-nombres', 'foto-apellidos', 'foto-rut'];

            if (imageUpload) imageUpload.addEventListener('change', handleImageUploadWithCropper);
            if (previewButton) previewButton.addEventListener('click', () => generateFotoCarnetWithCropper(true)); 
            if (saveButton) saveButton.addEventListener('click', () => generateFotoCarnetWithCropper(false));
            
            if (rutInput) {
                rutInput.addEventListener('input', () => {
                    formatRut(rutInput);
                    checkEnableFotoCarnetButtons();
                });
            }
            textInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', (e) => {
                        if (id !== 'foto-rut') e.target.value = e.target.value.toUpperCase();
                        checkEnableFotoCarnetButtons();
                    });
                }
            });

            // Event listeners para los controles de ajuste de imagen de Foto Carnet
            document.getElementById('fcBrightness')?.addEventListener('input', (e) => {
                fc_currentAdjustments.brightness = parseInt(e.target.value);
                document.getElementById('fcBrightnessValue').textContent = e.target.value;
                if (cropperInstance && cropperInstance.canvasData) { 
                     generateFotoCarnetWithCropper(true); 
                }
            });
            document.getElementById('fcContrast')?.addEventListener('input', (e) => {
                fc_currentAdjustments.contrast = parseInt(e.target.value) / 100;
                document.getElementById('fcContrastValue').textContent = e.target.value;
                if (cropperInstance && cropperInstance.canvasData) {
                     generateFotoCarnetWithCropper(true);
                }
            });
            document.getElementById('fcSharpness')?.addEventListener('input', (e) => {
                fc_currentAdjustments.sharpness = parseInt(e.target.value);
                document.getElementById('fcSharpnessValue').textContent = e.target.value;
                if (cropperInstance && cropperInstance.canvasData) {
                     generateFotoCarnetWithCropper(true);
                }
            });
            // Listener para Temperatura eliminado

            checkEnableFotoCarnetButtons();
        }

        function checkEnableFotoCarnetButtons() {
            const previewButton = document.getElementById('preview-foto-carnet-button');
            const saveButton = document.getElementById('save-foto-carnet-button');
            
            const nombres = document.getElementById('foto-nombres')?.value.trim();
            const apellidos = document.getElementById('foto-apellidos')?.value.trim();
            const rut = document.getElementById('foto-rut')?.value.trim();
            const isCropperReady = cropperInstance !== null && typeof cropperInstance.getCroppedCanvas === 'function';
            const resultCanvas = document.getElementById('result-canvas');
            const isPreviewGenerated = resultCanvas && resultCanvas.style.display === 'block' && resultCanvas.width > 0;

            if (previewButton) {
                previewButton.disabled = !(isCropperReady && nombres && apellidos && rut);
            }
            if (saveButton) {
                saveButton.disabled = !(isPreviewGenerated && nombres && apellidos && rut);
            }
        }


        function handleImageUploadWithCropper(event) {
            const file = event.target.files[0];
            const imageElement = document.getElementById('cropper-image');
            const resultCanvas = document.getElementById('result-canvas');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');

            if (cropperInstance) {
                try { cropperInstance.destroy(); } catch(e) { console.warn("Error al destruir Cropper:", e); }
                cropperInstance = null;
            }
            if (resultCanvas) {
                const ctx = resultCanvas.getContext('2d');
                ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                resultCanvas.style.display = 'none';
                if(canvasPlaceholder) canvasPlaceholder.style.display = 'block';
            }
            
            // Resetear sliders y valores de ajuste de Foto Carnet
            document.getElementById('fcBrightness').value = 0;
            document.getElementById('fcContrast').value = 100;
            document.getElementById('fcSharpness').value = 0;
            // Control de Temperatura ya no existe
            fc_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 }; // Mantener temperature en 0
            document.getElementById('fcBrightnessValue').textContent = '0';
            document.getElementById('fcContrastValue').textContent = '100';
            document.getElementById('fcSharpnessValue').textContent = '0';
            // Label de Temperatura ya no existe

            checkEnableFotoCarnetButtons();

            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageElement.src = e.target.result;
                    imageElement.alt = "[Imagen del] Imagen cargada para recortar";
                    if (typeof Cropper === 'undefined') {
                        const errorDiv = document.querySelector('.cropper-container-wrapper') || document.getElementById('content-area');
                        if (errorDiv) errorDiv.innerHTML = '<p class="text-red-500 text-center font-bold p-2">Error: La librer√≠a de recorte no se carg√≥. Intente recargar.</p>';
                        return;
                    }
                    try {
                        cropperInstance = new Cropper(imageElement, {
                            aspectRatio: 3 / 4, 
                            viewMode: 1,        
                            dragMode: 'move',  
                            autoCropArea: 0.9, 
                            background: false, 
                            zoomable: true,
                            movable: true,
                            cropBoxResizable: true,
                            ready: () => {
                                checkEnableFotoCarnetButtons();
                                generateFotoCarnetWithCropper(true); 
                            },
                            crop: () => { 
                                generateFotoCarnetWithCropper(true);
                                checkEnableFotoCarnetButtons();
                            }
                        });
                    } catch (error) {
                        const errorDiv = document.querySelector('.cropper-container-wrapper') || document.getElementById('content-area');
                        if (errorDiv) errorDiv.innerHTML = `<p class="text-red-500 text-center font-bold p-2">Error al inicializar recorte: ${error.message}</p>`;
                        imageElement.src = ""; imageElement.alt = "[Imagen del] Error al cargar imagen.";
                    }
                };
                reader.readAsDataURL(file);
            } else {
                imageElement.src = ""; 
                imageElement.alt = " Sube una imagen para empezar.";
                if(file) {
                     const errorDiv = document.querySelector('.cropper-container-wrapper') || document.getElementById('content-area');
                     if (errorDiv) errorDiv.insertAdjacentHTML('afterbegin', '<p class="text-yellow-500 text-center font-bold p-2">Por favor, selecciona un archivo de imagen v√°lido (ej: JPG, PNG).</p>');
                }
                checkEnableFotoCarnetButtons();
            }
        }
        
        // Funciones de ajuste de imagen para Foto Carnet (fc_)
        function fc_applyImageAdjustments(imageData) {
            if (!imageData) return;
            const pixels = imageData.data;
            const brightness = fc_currentAdjustments.brightness;
            const contrast = fc_currentAdjustments.contrast;
            for (let i = 0; i < pixels.length; i += 4) {
                let r = pixels[i], g = pixels[i+1], b = pixels[i+2];
                r = (r - 128) * contrast + 128; g = (g - 128) * contrast + 128; b = (b - 128) * contrast + 128;
                r += brightness; g += brightness; b += brightness;
                pixels[i] = Math.min(255, Math.max(0, r));
                pixels[i+1] = Math.min(255, Math.max(0, g));
                pixels[i+2] = Math.min(255, Math.max(0, b));
            }
            // Ajuste de Temperatura eliminado de aqu√≠ tambi√©n
            // const tempAdjust = fc_currentAdjustments.temperature;
            // for (let i = 0; i < pixels.length; i += 4) {
            //     pixels[i] = Math.min(255, Math.max(0, pixels[i] + tempAdjust));
            //     pixels[i+2] = Math.min(255, Math.max(0, pixels[i+2] - tempAdjust));
            // }
            if (fc_currentAdjustments.sharpness > 0) { 
                fc_applySharpness(imageData);
            }
        }

        function fc_applySharpness(imageData) {
            const sharpnessFactor = fc_currentAdjustments.sharpness / 100;
            if (sharpnessFactor <= 0) return;
            const center = 1 + 4 * sharpnessFactor; 
            const surround = -0.5 * sharpnessFactor; 
            const kernel = [surround, surround, surround, surround, center, surround, surround, surround, surround];
            const pixels = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const tempData = new Uint8ClampedArray(pixels); // Copia para leer valores originales
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) { // Para R, G, B
                        let sum = 0;
                        let ki = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += tempData[idx] * kernel[ki++];
                            }
                        }
                        const idxCurrent = (y * width + x) * 4 + c;
                        pixels[idxCurrent] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
        }


        async function generateFotoCarnetWithCropper(isPreview = false) { 
            if (!cropperInstance || typeof cropperInstance.getCroppedCanvas !== 'function') {
                if (!isPreview) showTemporaryMessage('foto-carnet-message', "Por favor, sube y ajusta una imagen primero.", true);
                return;
            }
            const nombres = document.getElementById('foto-nombres').value.trim();
            const apellidos = document.getElementById('foto-apellidos').value.trim();
            const rut = document.getElementById('foto-rut').value.trim();
            if (!nombres || !apellidos || !rut) {
                 if (!isPreview) showTemporaryMessage('foto-carnet-message', "Completa Nombres, Apellidos y RUT.", true);
            }

            let croppedCanvas;
            try {
                croppedCanvas = cropperInstance.getCroppedCanvas({
                    width: 300, 
                    imageSmoothingEnabled: true, 
                    imageSmoothingQuality: 'high',
                });
                if (!croppedCanvas || !croppedCanvas.width || !croppedCanvas.height) throw new Error("El √°rea recortada es inv√°lida o el cropper no est√° listo.");
            } catch (error) {
                if (!isPreview) showTemporaryMessage('foto-carnet-message', `Error al recortar: ${error.message}.`, true);
                console.error("Error en getCroppedCanvas:", error);
                return;
            }
            
            const resultCanvas = document.getElementById('result-canvas');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const ctx = resultCanvas.getContext('2d');
            
            const tempAdjustedCanvas = document.createElement('canvas');
            tempAdjustedCanvas.width = croppedCanvas.width;
            tempAdjustedCanvas.height = croppedCanvas.height;
            const tempAdjustedCtx = tempAdjustedCanvas.getContext('2d');
            tempAdjustedCtx.drawImage(croppedCanvas, 0, 0);
            
            const imageData = tempAdjustedCtx.getImageData(0, 0, tempAdjustedCanvas.width, tempAdjustedCanvas.height);
            fc_applyImageAdjustments(imageData); 
            tempAdjustedCtx.putImageData(imageData, 0, 0);

            const photoWidth = 300; 
            const photoHeight = 400; 
            resultCanvas.width = photoWidth;
            resultCanvas.height = photoHeight;
            ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            ctx.drawImage(tempAdjustedCanvas, 0, 0, resultCanvas.width, resultCanvas.height); 

            if (nombres && apellidos && rut) {
                const textLineHeight = Math.max(22, photoWidth * 0.08);
                const textPaddingVertical = Math.max(15, photoWidth * 0.05);
                const fontSize = Math.max(20, photoWidth * 0.065);
                const numTextLines = 3;
                const textStripHeight = (textLineHeight * numTextLines) + (textPaddingVertical * 2);
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                const stripY = resultCanvas.height - textStripHeight;
                ctx.fillRect(0, stripY, resultCanvas.width, textStripHeight);
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textBaseY = stripY + textPaddingVertical;
                const textY1 = textBaseY + (textLineHeight / 2);
                const textY2 = textY1 + textLineHeight;
                const textY3 = textY2 + textLineHeight;
                ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                ctx.fillText(nombres.toUpperCase(), resultCanvas.width / 2, textY1);
                ctx.fillText(apellidos.toUpperCase(), resultCanvas.width / 2, textY2);
                ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                ctx.fillText(rut.toUpperCase(), resultCanvas.width / 2, textY3);
            }
            
            resultCanvas.style.display = 'block';
            if(canvasPlaceholder) canvasPlaceholder.style.display = 'none';
            checkEnableFotoCarnetButtons(); 

            if (isPreview) { 
                return;
            }

            // L√≥gica de guardado (solo si no es preview)
            if (!nombres || !apellidos || !rut) { // Re-validar antes de guardar
                showTemporaryMessage('foto-carnet-message', "Completa Nombres, Apellidos y RUT antes de guardar.", true);
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser')); 
            if (!currentUser || !currentUser.id) {
                showTemporaryMessage('foto-carnet-message', "Error de sesi√≥n. Intenta reingresar.", true);
                console.error("Error: currentUser o currentUser.id no disponible en generateFotoCarnetWithCropper");
                return;
            }

            const imagen_dataurl = resultCanvas.toDataURL('image/png');
            const fotoCarnetData = {
                user_id: currentUser.id, 
                nombre_completo_jugador: `${nombres} ${apellidos}`.trim(),
                rut_jugador: rut,
                imagen_dataurl: imagen_dataurl
            };

            const { data, error } = await supabaseClient
                .from('fotocarnets')
                .insert([fotoCarnetData]);

            if (error) {
                console.error("Error al guardar foto carnet en Supabase:", error);
                showTemporaryMessage('foto-carnet-message', `Error al guardar: ${error.message}`, true);
            } else {
                showTemporaryMessage('foto-carnet-message', "Foto carnet generada y guardada exitosamente.", false);
            }
        }
        
        // --- L√≥gica para C√©dula Identidad (Correcci√≥n de Perspectiva y Guardado) ---
        let ci_perspectiveImage = new Image();
        let ci_perspectivePoints = []; 
        let ci_perspectiveOriginalCanvas, ci_perspectiveTransformedCanvas;
        let ci_perspectiveCtxOriginal, ci_perspectiveCtxTransformed;
        let ci_savedFoto1DataUrl = null, ci_savedFoto2DataUrl = null; 
        let ci_currentSelectedFoto = 'foto1'; 
        const CI_FINAL_WIDTH = 340; 
        const CI_FINAL_HEIGHT = 227; 
        let ci_currentAdjustments = {
            brightness: 0, contrast: 1, sharpness: 0, temperature: 0
        };

        function renderCedulaIdentidadForm() {
            const mainTitle = document.getElementById('main-title');
            const contentArea = document.getElementById('content-area');
            if (!mainTitle || !contentArea) return;
            mainTitle.innerText = 'Modificaci√≥n y Guardado de C√©dula de Identidad';
            contentArea.innerHTML = `
                <div id="cedula-identidad-section" class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <div class="mb-4"> <label for="nombre-jugador-cedula" class="block text-sm font-medium text-secondary mb-1">Nombre del Jugador (solo para registro):</label>
                        <input type="text" id="nombre-jugador-cedula" class="form-input-base" placeholder="" required>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <span class="text-sm font-medium text-primary">Subir para:</span>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="fotoCedulaSelect" value="foto1" class="form-radio h-4 w-4 text-blue-600" checked>
                                <span class="ml-2 text-sm text-primary">Foto 1 (Anverso)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="fotoCedulaSelect" value="foto2" class="form-radio h-4 w-4 text-blue-600">
                                <span class="ml-2 text-sm text-primary">Foto 2 (Reverso)</span>
                            </label>
                        </div>
                        <div class="button-group">
                            <input type="file" id="ciPerspectiveImageInput" class="hidden" accept="image/*">
                            <label for="ciPerspectiveImageInput" class="file-input-label-cedula"><i class="fas fa-upload mr-2"></i>Seleccionar Archivo</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-lg font-medium text-primary mb-2">Foto Original (Marcar 4 esquinas)</h3>
                            <div class="perspective-canvas-wrapper" id="ciOriginalCanvasContainer">
                                <canvas id="ciPerspectiveOriginalCanvas"></canvas>
                                <div id="ciCanvasPlaceholderCedula" class="text-sm">Sube una imagen para comenzar</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-primary mb-2">Foto Corregida</h3>
                            <div class="perspective-canvas-wrapper"><canvas id="ciPerspectiveTransformedCanvas"></canvas></div>
                        </div>
                    </div>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 mb-6">
                        <div class="adjustment-control">
                            <label for="ciBrightness" class="block text-sm font-medium text-primary">Brillo: <span id="ciBrightnessValue">0</span>%</label>
                            <input type="range" id="ciBrightness" min="-50" max="50" value="0" class="slider">
                        </div>
                        <div class="adjustment-control">
                            <label for="ciContrast" class="block text-sm font-medium text-primary">Contraste: <span id="ciContrastValue">100</span>%</label>
                            <input type="range" id="ciContrast" min="50" max="150" value="100" class="slider">
                        </div>
                        <div class="adjustment-control">
                            <label for="ciSharpness" class="block text-sm font-medium text-primary">Nitidez: <span id="ciSharpnessValue">0</span>%</label>
                            <input type="range" id="ciSharpness" min="0" max="100" value="0" class="slider">
                        </div>
                        <div class="adjustment-control">
                            <label for="ciTemperature" class="block text-sm font-medium text-primary">Temperatura: <span id="ciTemperatureValue">0</span></label>
                            <input type="range" id="ciTemperature" min="-100" max="100" value="0" class="slider">
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-2">
                        <button id="ci-perspective-save-btn" class="px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-save mr-2"></i>Guardar Imagen Corregida</button>
                        <button id="ci-perspective-reset-points-btn" class="px-4 py-2 rounded-md"><i class="fas fa-undo mr-2"></i>Reiniciar Puntos</button>
                    </div>
                    <div class="saved-images-container mt-8">
                        <h3 class="text-lg font-medium text-primary mb-4">Im√°genes Guardadas para PDF</h3>
                        <div id="ciSavedImagesList" class="flex flex-wrap gap-4 items-start"></div>
                        <button id="ci-generate-cedula-pdf-btn" class="mt-4 px-4 py-2 rounded-md disabled:opacity-50" disabled><i class="fas fa-file-pdf mr-2"></i>Generar y Guardar PDF</button>
                    </div>
                    <div id="cedula-message" class="text-sm mt-2 min-h-[1.25rem]"></div> </div>`;
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js', initializeCedulaIdentidadLogic);
        }

        function initializeCedulaIdentidadLogic() {
            if (typeof numeric === 'undefined') { 
                const cedulaSection = document.getElementById('cedula-identidad-section');
                if(cedulaSection) cedulaSection.innerHTML = '<p class="text-red-500 font-bold text-center p-4">Error: Falta la librer√≠a \'numeric.js\'. Recargue la p√°gina.</p>';
                return; 
            }
            ci_perspectiveImage = new Image(); ci_perspectivePoints = []; ci_savedFoto1DataUrl = null; ci_savedFoto2DataUrl = null; ci_currentSelectedFoto = 'foto1';
            ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
            
            ci_perspectiveOriginalCanvas = document.getElementById('ciPerspectiveOriginalCanvas');
            ci_perspectiveTransformedCanvas = document.getElementById('ciPerspectiveTransformedCanvas');
            if (!ci_perspectiveOriginalCanvas || !ci_perspectiveTransformedCanvas) { console.error("Error: Canvas de c√©dula no encontrado."); return; }
            ci_perspectiveCtxOriginal = ci_perspectiveOriginalCanvas.getContext('2d');
            ci_perspectiveCtxTransformed = ci_perspectiveTransformedCanvas.getContext('2d');

            document.getElementById('nombre-jugador-cedula')?.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
                ci_updatePDFButtonState(); 
            });
            document.getElementById('ciPerspectiveImageInput')?.addEventListener('change', ci_handleImageUpload);
            ci_perspectiveOriginalCanvas.addEventListener('click', ci_handleCanvasClick);
            document.getElementById('ci-perspective-save-btn')?.addEventListener('click', ci_saveImage);
            document.getElementById('ci-generate-cedula-pdf-btn')?.addEventListener('click', ci_generateAndSavePDF); 
            document.getElementById('ci-perspective-reset-points-btn')?.addEventListener('click', () => {
                ci_perspectivePoints = []; 
                ci_drawPerspectivePointsAndLines();
                if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
                const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
                document.getElementById('ciBrightness').value = 0;
                document.getElementById('ciContrast').value = 100;
                document.getElementById('ciSharpness').value = 0;
                document.getElementById('ciTemperature').value = 0;
                ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
                document.getElementById('ciBrightnessValue').textContent = '0';
                document.getElementById('ciContrastValue').textContent = '100';
                document.getElementById('ciSharpnessValue').textContent = '0';
                document.getElementById('ciTemperatureValue').textContent = '0';
            });
            document.querySelectorAll('input[name="fotoCedulaSelect"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    ci_currentSelectedFoto = e.target.value; 
                    ci_resetPerspectiveView(false); 
                    if (ci_perspectiveImage.src) ci_drawImage();
                });
            });

            ['ciBrightness', 'ciContrast', 'ciSharpness', 'ciTemperature'].forEach(sliderId => {
                document.getElementById(sliderId)?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    const spanId = sliderId + 'Value';
                    document.getElementById(spanId).textContent = value;
                    if (sliderId === 'ciContrast') ci_currentAdjustments.contrast = value / 100;
                    else ci_currentAdjustments[sliderId.replace('ci','').toLowerCase()] = value;
                    
                    if (ci_perspectiveTransformedCanvas.width > 0 && ci_perspectiveImage.src && ci_perspectivePoints.length === 4) {
                        ci_applyPerspectiveTransform();
                    }
                });
            });

            const initialRadio = document.querySelector('input[name="fotoCedulaSelect"]:checked');
            if (initialRadio) ci_currentSelectedFoto = initialRadio.value;
            ci_updatePDFButtonState();
            ci_updateSavedImagesList();
        }
        
        function ci_handleImageUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            if (!file.type.match('image.*')) { 
                showTemporaryMessage('cedula-message', "Por favor, selecciona un archivo de imagen.", true);
                return; 
            }
            if (file.size > 5 * 1024 * 1024) {
                showTemporaryMessage('cedula-message', "El archivo es demasiado grande (m√°ximo 5MB).", true);
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                ci_perspectiveImage.onload = () => {
                    ci_updateCanvasDimensions(); 
                    ci_drawImage(); 
                    document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'none', 'important');
                    ci_perspectivePoints = []; 
                    if(ci_perspectiveCtxTransformed && ci_perspectiveTransformedCanvas) ci_perspectiveCtxTransformed.clearRect(0,0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
                    const saveButton = document.getElementById('ci-perspective-save-btn'); if(saveButton) saveButton.disabled = true;
                    document.getElementById('ciBrightness').value = 0;
                    document.getElementById('ciContrast').value = 100;
                    document.getElementById('ciSharpness').value = 0;
                    document.getElementById('ciTemperature').value = 0;
                    ci_currentAdjustments = { brightness: 0, contrast: 1, sharpness: 0, temperature: 0 };
                    document.getElementById('ciBrightnessValue').textContent = '0';
                    document.getElementById('ciContrastValue').textContent = '100';
                    document.getElementById('ciSharpnessValue').textContent = '0';
                    document.getElementById('ciTemperatureValue').textContent = '0';
                };
                ci_perspectiveImage.onerror = () => {
                    document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important');
                    showTemporaryMessage('cedula-message', "Error al cargar la imagen. Intente con otro archivo.", true);
                }
                ci_perspectiveImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function ci_updateCanvasDimensions() {
            const container = document.getElementById('ciOriginalCanvasContainer');
            if (!container || !ci_perspectiveImage.width || !ci_perspectiveImage.height) return; 
            const aspectRatio = ci_perspectiveImage.width / ci_perspectiveImage.height;
            let newWidth = container.clientWidth;
            let newHeight = newWidth / aspectRatio;
            if (newHeight > container.clientHeight) {
                newHeight = container.clientHeight;
                newWidth = newHeight * aspectRatio;
            }
            if (ci_perspectiveOriginalCanvas) { 
                ci_perspectiveOriginalCanvas.width = newWidth; 
                ci_perspectiveOriginalCanvas.height = newHeight; 
            }
        }

        function ci_drawImage() {
            if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas || !ci_perspectiveImage.src) return;
            ci_perspectiveCtxOriginal.clearRect(0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
            ci_perspectiveCtxOriginal.drawImage(ci_perspectiveImage, 0, 0, ci_perspectiveImage.width, ci_perspectiveImage.height, 0, 0, ci_perspectiveOriginalCanvas.width, ci_perspectiveOriginalCanvas.height);
        }

        function ci_handleCanvasClick(e) {
            if (ci_perspectivePoints.length >= 4 || !ci_perspectiveImage.src || !ci_perspectiveOriginalCanvas) return;
            const rect = ci_perspectiveOriginalCanvas.getBoundingClientRect();
            const scaleX = ci_perspectiveOriginalCanvas.width / rect.width;
            const scaleY = ci_perspectiveOriginalCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            ci_perspectivePoints.push({ x, y });
            ci_drawPerspectivePointsAndLines();
            if (ci_perspectivePoints.length === 4) {
                ci_applyPerspectiveTransform();
                const saveButton = document.getElementById('ci-perspective-save-btn'); if (saveButton) saveButton.disabled = false;
            }
        }

        function ci_drawPerspectivePointsAndLines() {
            if (!ci_perspectiveCtxOriginal || !ci_perspectiveOriginalCanvas) return;
            ci_drawImage();
            ci_perspectiveCtxOriginal.strokeStyle = 'rgba(255,0,0,0.9)'; 
            ci_perspectiveCtxOriginal.lineWidth = 2; 
            ci_perspectiveCtxOriginal.fillStyle = 'rgba(255,0,0,0.7)';
            ci_perspectivePoints.forEach((p, i) => {
                ci_perspectiveCtxOriginal.beginPath(); 
                ci_perspectiveCtxOriginal.arc(p.x, p.y, 6, 0, Math.PI*2);
                ci_perspectiveCtxOriginal.fill(); 
                ci_perspectiveCtxOriginal.stroke();
                if (i > 0) {
                    ci_perspectiveCtxOriginal.beginPath(); 
                    ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[i-1].x, ci_perspectivePoints[i-1].y); 
                    ci_perspectiveCtxOriginal.lineTo(p.x, p.y); 
                    ci_perspectiveCtxOriginal.stroke();
                }
            });
            if (ci_perspectivePoints.length === 4) { 
                ci_perspectiveCtxOriginal.beginPath(); 
                ci_perspectiveCtxOriginal.moveTo(ci_perspectivePoints[3].x, ci_perspectivePoints[3].y); 
                ci_perspectiveCtxOriginal.lineTo(ci_perspectivePoints[0].x, ci_perspectivePoints[0].y); 
                ci_perspectiveCtxOriginal.stroke(); 
            }
        }
        
        async function ci_applyPerspectiveTransform() {
            if (ci_perspectivePoints.length < 4 || !ci_perspectiveImage.src || !numeric) return;
            const orderedPoints = ci_orderPoints(ci_perspectivePoints);
            if (!orderedPoints || orderedPoints.some(p => p === undefined)) { 
                showTemporaryMessage('cedula-message', "Error al ordenar puntos. Intente de nuevo.", true);
                ci_perspectivePoints = []; ci_drawPerspectivePointsAndLines(); return; 
            }
            const srcPoints = orderedPoints.map(p => ({ 
                x: (p.x / ci_perspectiveOriginalCanvas.width) * ci_perspectiveImage.width, 
                y: (p.y / ci_perspectiveOriginalCanvas.height) * ci_perspectiveImage.height 
            }));
            const dstPoints = [
                {x:0, y:0}, {x:CI_FINAL_WIDTH, y:0}, 
                {x:CI_FINAL_WIDTH, y:CI_FINAL_HEIGHT}, {x:0, y:CI_FINAL_HEIGHT}
            ];
            try {
                const matrix = ci_computePerspectiveMatrix(srcPoints, dstPoints);
                if (!matrix) { 
                    showTemporaryMessage('cedula-message', "Error al calcular transformaci√≥n. Verifique puntos.", true);
                    return; 
                }
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = ci_perspectiveImage.width; 
                tempCanvas.height = ci_perspectiveImage.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(ci_perspectiveImage, 0, 0);
                ci_perspectiveTransformedCanvas.width = CI_FINAL_WIDTH;
                ci_perspectiveTransformedCanvas.height = CI_FINAL_HEIGHT;
                ci_perspectiveCtxTransformed.clearRect(0,0,CI_FINAL_WIDTH,CI_FINAL_HEIGHT);
                const imgData = ci_perspectiveCtxTransformed.createImageData(CI_FINAL_WIDTH,CI_FINAL_HEIGHT); 
                const pixels = imgData.data;
                const invMatrix = numeric.inv(matrix);
                for (let y = 0; y < CI_FINAL_HEIGHT; y++) {
                    for (let x = 0; x < CI_FINAL_WIDTH; x++) {
                        const pDest = [x, y, 1];
                        const pSrcHom = numeric.dot(invMatrix, pDest);
                        const srcX = pSrcHom[0] / pSrcHom[2];
                        const srcY = pSrcHom[1] / pSrcHom[2];
                        if (srcX >= 0 && srcX < ci_perspectiveImage.width && srcY >= 0 && srcY < ci_perspectiveImage.height) {
                            const srcPixelData = tempCtx.getImageData(Math.floor(srcX), Math.floor(srcY), 1, 1).data;
                            const destIdx = (y * CI_FINAL_WIDTH + x) * 4;
                            pixels[destIdx]   = srcPixelData[0];
                            pixels[destIdx+1] = srcPixelData[1];
                            pixels[destIdx+2] = srcPixelData[2];
                            pixels[destIdx+3] = 255;
                        }
                    }
                }
                ci_perspectiveCtxTransformed.putImageData(imgData, 0, 0); 
                ci_applyImageAdjustments(); 
            } catch(err) { 
                showTemporaryMessage('cedula-message', `Error en transformaci√≥n: ${err.message}`, true);
                console.error("Error en ci_applyPerspectiveTransform:", err);
            }
        }

        function ci_applyImageAdjustments() {
            if (!ci_perspectiveTransformedCanvas || ci_perspectiveTransformedCanvas.width === 0) return;
            const imageData = ci_perspectiveCtxTransformed.getImageData(0, 0, ci_perspectiveTransformedCanvas.width, ci_perspectiveTransformedCanvas.height);
            const pixels = imageData.data;
            const brightness = ci_currentAdjustments.brightness;
            const contrast = ci_currentAdjustments.contrast;
            for (let i = 0; i < pixels.length; i += 4) {
                let r = pixels[i], g = pixels[i+1], b = pixels[i+2];
                r = (r - 128) * contrast + 128; g = (g - 128) * contrast + 128; b = (b - 128) * contrast + 128;
                r += brightness; g += brightness; b += brightness;
                pixels[i] = Math.min(255, Math.max(0, r));
                pixels[i+1] = Math.min(255, Math.max(0, g));
                pixels[i+2] = Math.min(255, Math.max(0, b));
            }
            const tempAdjust = ci_currentAdjustments.temperature;
            for (let i = 0; i < pixels.length; i += 4) {
                pixels[i] = Math.min(255, Math.max(0, pixels[i] + tempAdjust));
                pixels[i+2] = Math.min(255, Math.max(0, pixels[i+2] - tempAdjust));
            }
            if (ci_currentAdjustments.sharpness > 0) { 
                ci_applySharpness(imageData);
            }
            ci_perspectiveCtxTransformed.putImageData(imageData, 0, 0);
        }

        function ci_applySharpness(imageData) {
            const sharpnessFactor = ci_currentAdjustments.sharpness / 100;
            if (sharpnessFactor <= 0) return;
            const center = 1 + 4 * sharpnessFactor; 
            const surround = -0.5 * sharpnessFactor; 
            const kernel = [surround, surround, surround, surround, center, surround, surround, surround, surround];
            const pixels = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const tempData = new Uint8ClampedArray(pixels);
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0, ki = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += tempData[idx] * kernel[ki++];
                            }
                        }
                        const idxCurrent = (y * width + x) * 4 + c;
                        pixels[idxCurrent] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
        }

        function ci_computePerspectiveMatrix(src, dst) {
            const A = [], B = [];
            for(let i = 0; i < 4; i++) {
                const x = src[i].x, y = src[i].y, u = dst[i].x, v = dst[i].y;
                A.push([x, y, 1, 0, 0, 0, -u*x, -u*y]);
                A.push([0, 0, 0, x, y, 1, -v*x, -v*y]);
                B.push(u); B.push(v);
            }
            try {
                const X = numeric.solve(A, B);
                return [[X[0],X[1],X[2]], [X[3],X[4],X[5]], [X[6],X[7],1]];
            } catch(e) {
                console.error("Error en numeric.solve:", e);
                showTemporaryMessage('cedula-message', "Error matem√°tico. Verifique puntos.", true);
                return null;
            }
        }

        function ci_orderPoints(points) {
            points.sort((a, b) => (a.x + a.y) - (b.x + b.y));
            let [tl, p2, p3, br] = points;
            let others = [p2, p3].sort((a, b) => (a.y - a.x) - (b.y - b.x));
            let tr = others[0], bl = others[1];
            if ([tl, tr, br, bl].some(p => p === undefined)) {
                console.warn("Fallback de ordenaci√≥n de puntos.");
                const center = points.reduce((acc,p)=>({x:acc.x+p.x/4, y:acc.y+p.y/4}),{x:0,y:0});
                return points.sort((a,b)=>Math.atan2(a.y-center.y,a.x-center.x) - Math.atan2(b.y-center.y,b.x-center.x));
            }
            return [tl, tr, br, bl];
        }

        function ci_saveImage() { 
            if (!ci_perspectiveTransformedCanvas || ci_perspectiveTransformedCanvas.width === 0) { 
                showTemporaryMessage('cedula-message', "No hay imagen corregida para guardar.", true);
                return; 
            }
            const dataUrl = ci_perspectiveTransformedCanvas.toDataURL('image/png');
            if (ci_currentSelectedFoto === 'foto1') ci_savedFoto1DataUrl = dataUrl; 
            else ci_savedFoto2DataUrl = dataUrl;
            ci_updateSavedImagesList();
            ci_updatePDFButtonState();
            const imageInput = document.getElementById('ciPerspectiveImageInput'); if(imageInput) imageInput.value = '';
            ci_resetPerspectiveView(true);
            if (ci_currentSelectedFoto === 'foto1' && !ci_savedFoto2DataUrl) { 
                const radioFoto2 = document.querySelector('input[name="fotoCedulaSelect"][value="foto2"]'); 
                if (radioFoto2) radioFoto2.checked = true; 
                ci_currentSelectedFoto = 'foto2'; 
            } else if (ci_currentSelectedFoto === 'foto2' && !ci_savedFoto1DataUrl) {
                const radioFoto1 = document.querySelector('input[name="fotoCedulaSelect"][value="foto1"]'); 
                if (radioFoto1) radioFoto1.checked = true; 
                ci_currentSelectedFoto = 'foto1';
            }
            showTemporaryMessage('cedula-message', "Imagen corregida guardada temporalmente.", false);
        }

        function ci_updateSavedImagesList() {
            const container = document.getElementById('ciSavedImagesList'); if (!container) return; 
            container.innerHTML = '';
            const placeholderStyle = "width:120px;height:100px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border-input);border-radius:0.375rem;background-color:var(--bg-primary);";
            container.innerHTML += ci_savedFoto1DataUrl ? 
                `<div class="saved-image-item"><img src="${ci_savedFoto1DataUrl}" class="saved-image-preview" alt="[Imagen del] Anverso C√©dula"><p class="text-sm text-primary mt-1">Anverso</p></div>` : 
                `<div class="saved-image-item" style="${placeholderStyle}"><span class="text-xs text-secondary">Anverso (Vac√≠o)</span></div>`;
            container.innerHTML += ci_savedFoto2DataUrl ? 
                `<div class="saved-image-item"><img src="${ci_savedFoto2DataUrl}" class="saved-image-preview" alt="[Imagen del] Reverso C√©dula"><p class="text-sm text-primary mt-1">Reverso</p></div>` : 
                `<div class="saved-image-item" style="${placeholderStyle}"><span class="text-xs text-secondary">Reverso (Vac√≠o)</span></div>`;
        }

        async function ci_generateAndSavePDF() { 
            const nombreJugadorInput = document.getElementById('nombre-jugador-cedula');
            const nombre_jugador = nombreJugadorInput?.value.trim().toUpperCase();

            if (!nombre_jugador) {
                showTemporaryMessage('cedula-message', "Por favor, ingresa el nombre del jugador.", true);
                nombreJugadorInput?.focus();
                return;
            }
            if (!ci_savedFoto1DataUrl || !ci_savedFoto2DataUrl) { 
                showTemporaryMessage('cedula-message', "Debe guardar ambas caras de la c√©dula primero.", true);
                return; 
            }
            if (!PDFLib || !PDFLib.PDFDocument) { 
                showTemporaryMessage('cedula-message', "Librer√≠a PDF no lista. Intente de nuevo.", true);
                return; 
            }
            const { PDFDocument } = PDFLib;
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || !currentUser.id) {
                showTemporaryMessage('cedula-message', "Error de sesi√≥n. Intenta reingresar.", true);
                console.error("Error: currentUser o currentUser.id no disponible en ci_generateAndSavePDF");
                return;
            }

            try {
                const pdfDoc = await PDFDocument.create();
                const page = pdfDoc.addPage([595, 842]);
                const margin = 50;
                const imageDisplayWidth = 290;

                const anversoBytes = await fetch(ci_savedFoto1DataUrl).then(r=>r.arrayBuffer());
                const anversoImg = await pdfDoc.embedPng(anversoBytes);
                const anversoDims = anversoImg.scaleToFit(imageDisplayWidth, (imageDisplayWidth / CI_FINAL_WIDTH) * CI_FINAL_HEIGHT);
                page.drawImage(anversoImg, { x: margin, y: page.getHeight() - margin - anversoDims.height, width: anversoDims.width, height: anversoDims.height });
                page.drawText(`Anverso C√©dula - ${nombre_jugador}`, {x:margin, y:page.getHeight()-margin-anversoDims.height-15, size:10});

                const reversoBytes = await fetch(ci_savedFoto2DataUrl).then(r=>r.arrayBuffer());
                const reversoImg = await pdfDoc.embedPng(reversoBytes);
                const reversoDims = reversoImg.scaleToFit(imageDisplayWidth, (imageDisplayWidth / CI_FINAL_WIDTH) * CI_FINAL_HEIGHT);
                page.drawImage(reversoImg, { x: margin, y: page.getHeight() - margin - anversoDims.height - 30 - reversoDims.height, width: reversoDims.width, height: reversoDims.height });
                page.drawText(`Reverso C√©dula - ${nombre_jugador}`, {x:margin, y:page.getHeight()-margin-anversoDims.height-30-reversoDims.height-15, size:10});

                const pdf_dataurl = await pdfDoc.saveAsBase64({ dataUri: true });
                
                const cedulaData = {
                    user_id: currentUser.id, // Usar el ID de public.users
                    nombre_jugador: nombre_jugador,
                    pdf_dataurl: pdf_dataurl
                };
                const { data, error } = await supabaseClient
                    .from('cedulas_identidad')
                    .insert([cedulaData]);

                if (error) {
                    console.error("Error al guardar PDF de c√©dula en Supabase:", error);
                    showTemporaryMessage('cedula-message', `Error al guardar PDF: ${error.message}`, true);
                } else {
                    showTemporaryMessage('cedula-message', "PDF de c√©dula generado y guardado exitosamente.", false);
                }

            } catch(e) { 
                showTemporaryMessage('cedula-message', `Error al generar PDF: ${e.message}`, true);
                console.error("Error en ci_generateAndSavePDF:", e);
            }
        }

        function ci_updatePDFButtonState() {
            const btn = document.getElementById('ci-generate-cedula-pdf-btn'); 
            const nombreJugador = document.getElementById('nombre-jugador-cedula')?.value.trim();
            if(btn) btn.disabled = !(ci_savedFoto1DataUrl && ci_savedFoto2DataUrl && nombreJugador);
        }

        function ci_resetPerspectiveView(clearFullImage = true) {
            if (clearFullImage && ci_perspectiveImage) { 
                ci_perspectiveImage.src = '';
                document.getElementById('ciCanvasPlaceholderCedula')?.style.setProperty('display', 'flex', 'important');
            }
            if (ci_perspectiveOriginalCanvas && ci_perspectiveCtxOriginal && clearFullImage) {
                ci_perspectiveCtxOriginal.clearRect(0,0,ci_perspectiveOriginalCanvas.width,ci_perspectiveOriginalCanvas.height);
            }
            ci_perspectivePoints = [];
            if (ci_perspectiveTransformedCanvas && ci_perspectiveCtxTransformed) {
                ci_perspectiveCtxTransformed.clearRect(0,0,ci_perspectiveTransformedCanvas.width,ci_perspectiveTransformedCanvas.height);
            }
            const saveBtn = document.getElementById('ci-perspective-save-btn'); if(saveBtn) saveBtn.disabled = true;
            if (!clearFullImage && ci_perspectiveImage.src && ci_perspectiveCtxOriginal) {
                ci_drawImage();
            }
            ci_updatePDFButtonState(); 
        }

        // --- Handler Functions ---
        window.handleLoginSubmit = async function(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('username'); // Este es el RUT
            const passwordInput = document.getElementById('password');
            const errorMessage = document.getElementById('login-error-message');
            errorMessage.textContent = '';

            const username = usernameInput.value; // RUT del usuario
            const password = passwordInput.value;

            console.log('[handleLoginSubmit] Intentando login con C√©dula (username) procesada:', username);

            const { data: user, error } = await supabaseClient
                .from('users') 
                .select('*') 
                .eq('username', username) 
                .single();

            if (error || !user) {
                errorMessage.textContent = 'Usuario (RUT) no encontrado o error de conexi√≥n.';
                console.error('[handleLoginSubmit] Error fetching from public.users or user not found:', error);
                return;
            }
            
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', passwordData);
            const enteredPasswordHash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

            if (enteredPasswordHash === user.password_hash) {
                console.log('[handleLoginSubmit] Credenciales v√°lidas para (public.users):', user.username);
                localStorage.setItem('currentUser', JSON.stringify(user)); // Guardar usuario de public.users
                
                usernameInput.value = ''; 
                passwordInput.value = '';
                showAppScreen();
            } else {
                console.warn('[handleLoginSubmit] Contrase√±a incorrecta para (public.users):', username);
                errorMessage.textContent = 'Credenciales inv√°lidas.';
            }
        };

        function handleLogout() {
            localStorage.removeItem('currentUser'); // Limpiar usuario de public.users
            // No es necesario llamar a supabaseClient.auth.signOut() si no se us√≥ para login
            console.log("Sesi√≥n local cerrada.");
            showLoginScreen();
        }
        
        async function handleAddUserSubmit(event) {
            event.preventDefault();
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || currentUser.role !== 'admin') {
                showTemporaryMessage('add-user-error', 'Acceso no autorizado para esta acci√≥n.', true);
                return;
            }

            const nombre_completo = document.getElementById('new-fullname').value.trim();
            const username_rut = document.getElementById('new-username').value.trim(); // RUT
            const password = document.getElementById('new-password').value;
            const role_public_users = document.getElementById('new-role').value; // Rol para public.users
            const errorDivId = 'add-user-error';
            const editPublicUserId = document.getElementById('edit-user-id').value; 

            showTemporaryMessage(errorDivId, '', false, 0); 

            if (!nombre_completo || !username_rut || !role_public_users) {
                showTemporaryMessage(errorDivId, 'Nombre Completo, Usuario (RUT) y Rol son requeridos.', true);
                return;
            }
            
            let password_hash = null;
            if (password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                password_hash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            if (editPublicUserId) { // MODO EDICI√ìN
                const publicUserUpdateData = {
                    nombre_completo: nombre_completo,
                    username: username_rut,
                    role: role_public_users,
                };
                 if (password_hash) { 
                    publicUserUpdateData.password_hash = password_hash;
                }

                const { error: updatePublicUserError } = await supabaseClient
                    .from('users')
                    .update(publicUserUpdateData)
                    .eq('id', editPublicUserId);

                if (updatePublicUserError) {
                    console.error("Error al actualizar usuario en public.users:", updatePublicUserError);
                    showTemporaryMessage(errorDivId, 'Error al actualizar datos: ' + updatePublicUserError.message, true);
                } else {
                    showTemporaryMessage(errorDivId, 'Usuario actualizado exitosamente.', false);
                    setTimeout(() => renderUserManagementForm(), 1500);
                }
            } else { // MODO AGREGAR NUEVO USUARIO
                if (!password_hash) { // La contrase√±a es obligatoria para nuevos usuarios
                    showTemporaryMessage(errorDivId, 'La clave es requerida para nuevos usuarios.', true);
                    return;
                }
                
                const { error: insertPublicUserError } = await supabaseClient
                    .from('users') 
                    .insert([{
                        username: username_rut, 
                        password_hash: password_hash, 
                        nombre_completo: nombre_completo,
                        role: role_public_users
                        // No se incluye email_auth ya que no se usa en este flujo de login
                    }]);

                if (insertPublicUserError) {
                    console.error("Error al registrar usuario en public.users:", insertPublicUserError);
                     if (insertPublicUserError.message.includes('duplicate key value violates unique constraint')) {
                         showTemporaryMessage(errorDivId, 'Error: El usuario (RUT) ya existe.', true);
                    } else {
                        showTemporaryMessage(errorDivId, 'Error al registrar usuario: ' + insertPublicUserError.message, true);
                    }
                } else {
                    showTemporaryMessage(errorDivId, 'Usuario registrado exitosamente.', false);
                    setTimeout(() => renderUserManagementForm(), 1500);
                }
            }
        }
        
        async function populateUserEditForm(publicUserId) { 
            const { data: user, error } = await supabaseClient.from('users').select('*').eq('id', publicUserId).single();
            if (error || !user) { 
                showTemporaryMessage('add-user-error', 'No se pudo cargar el usuario para editar.', true);
                return; 
            }
            document.getElementById('new-fullname').value = user.nombre_completo || '';
            document.getElementById('new-username').value = user.username; // RUT
            // No se rellena el campo email_auth ya que fue eliminado del formulario
            document.getElementById('new-password').value = '';
            document.getElementById('new-password').placeholder = 'Nueva Clave (o dejar en blanco)';
            document.getElementById('new-role').value = user.role || 'user';
            document.getElementById('edit-user-id').value = user.id; 

            document.getElementById('user-form-title').textContent = 'Editar Usuario';
            const submitButton = document.getElementById('user-submit-button');
            submitButton.classList.remove('bg-button-green-bg', 'hover:bg-button-green-hover-bg');
            submitButton.classList.add('edit-user-button');
            document.getElementById('user-submit-button-text').textContent = 'Guardar Cambios';
            document.getElementById('user-cancel-button').classList.remove('hidden');
            showTemporaryMessage('add-user-error', '', false, 0);
            document.getElementById('new-fullname').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('new-fullname').focus();
        }

        function resetUserForm() {
            const form = document.getElementById('form-add-user');
            if (form) form.reset();
            document.getElementById('edit-user-id').value = '';
            document.getElementById('user-form-title').textContent = 'Agregar Nuevo Usuario';
            const submitButton = document.getElementById('user-submit-button');
            if (submitButton) {
                submitButton.classList.remove('edit-user-button');
                submitButton.classList.add('bg-button-green-bg', 'hover:bg-button-green-hover-bg');
            }
            document.getElementById('user-submit-button-text').textContent = 'Agregar';
            document.getElementById('user-cancel-button').classList.add('hidden');
            const passwordInput = document.getElementById('new-password');
            if (passwordInput) passwordInput.placeholder = '(dejar en blanco para no cambiar al editar)';
            const roleInput = document.getElementById('new-role');
            if (roleInput) roleInput.value = 'user';
            showTemporaryMessage('add-user-error', '', false, 0);
        }

        async function handleTramiteSubmit(event) {
            event.preventDefault();
            const formTramite = document.getElementById('form-tramite');
            let messageDiv = formTramite.parentNode.querySelector('.form-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'text-sm mt-2 min-h-[1.25rem] form-message';
                formTramite.parentNode.insertBefore(messageDiv, formTramite.nextSibling);
            }
            messageDiv.id = 'tramite-form-message'; 

            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || !currentUser.id) { 
                showTemporaryMessage(messageDiv.id, "Debes iniciar sesi√≥n para guardar un tr√°mite.", true);
                return;
            }

            const tramiteData = {
                ci: document.getElementById('ci').value,
                fecha_nac: document.getElementById('fecha-nac').value,
                apellido_paterno: document.getElementById('apellido-paterno').value,
                apellido_materno: document.getElementById('apellido-materno').value,
                nombres: document.getElementById('nombres').value,
                solicita_inscripcion: document.getElementById('solicita_inscripcion_char').value.trim().toUpperCase() || null,
                solicita_pase_interno: document.getElementById('solicita_pase_interno_char').value.trim().toUpperCase() || null,
                solicita_pase_regional: document.getElementById('solicita_pase_regional_char').value.trim().toUpperCase() || null,
                solicita_pase_externo: document.getElementById('solicita_pase_externo_char').value.trim().toUpperCase() || null,
                categoria_extranjero: document.getElementById('categoria_extranjero_char').value.trim().toUpperCase() || null,
                categoria_libertad: document.getElementById('categoria_libertad_char').value.trim().toUpperCase() || null,
                categoria_adulto: document.getElementById('categoria_adulto_char').value.trim().toUpperCase() || null,
                categoria_femenina: document.getElementById('categoria_femenina_char').value.trim().toUpperCase() || null,
                categoria_infantil: document.getElementById('categoria_infantil_char').value.trim().toUpperCase() || null,
                procede_club: document.getElementById('procede-club').value,
                procede_asociacion: document.getElementById('procede-asociacion').value,
                user_id: currentUser.id // ID de la tabla public.users
            };

            const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
            if (!dateRegex.test(tramiteData.fecha_nac)) { 
                showTemporaryMessage(messageDiv.id, 'Formato de Fecha de Nacimiento incorrecto. Use DD-MM-AAAA.', true);
                return; 
            }
            const solicitaValue = Object.keys(tramiteData).filter(k => k.startsWith('solicita_') && tramiteData[k]).length > 0;
            const categoriaValue = Object.keys(tramiteData).filter(k => k.startsWith('categoria_') && tramiteData[k]).length > 0;
            if (!solicitaValue) { 
                showTemporaryMessage(messageDiv.id, 'Debe marcar al menos una opci√≥n en "Solicita".', true);
                return; 
            }
            if (!categoriaValue) { 
                showTemporaryMessage(messageDiv.id, 'Debe marcar al menos una opci√≥n en "Categor√≠a".', true);
                return; 
            }
            
            const { error } = await supabaseClient.from('players').insert([tramiteData]);

            if (error) {
                console.error('[handleTramiteSubmit] Error al guardar tr√°mite:', error);
                showTemporaryMessage(messageDiv.id, 'Error al guardar tr√°mite: ' + error.message, true);
            } else { 
                showTemporaryMessage(messageDiv.id, 'Tr√°mite guardado exitosamente!', false);
                formTramite.reset();
                setTimeout(() => renderPlayerList(), 1500);
            }
        }

        async function handleAutorizacionSubmit(event) { 
            event.preventDefault();
            const formAuth = document.getElementById('form-autorizacion');
            let messageDiv = formAuth.parentNode.querySelector('.form-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'text-sm mt-2 min-h-[1.25rem] form-message';
                formAuth.parentNode.insertBefore(messageDiv, formAuth.nextSibling);
            }
            messageDiv.id = 'auth-form-message';

            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || !currentUser.id) { 
                showTemporaryMessage(messageDiv.id, "Debes iniciar sesi√≥n para guardar una autorizaci√≥n.", true);
                return;
            }
            
            const autorizacionData = {
                apoderado_nombre: document.getElementById('apoderado-nombre').value,
                apoderado_ci: document.getElementById('apoderado-ci').value,
                jugador_nombre: document.getElementById('jugador-nombre-auth').value,
                parentesco: document.getElementById('parentesco').value,
                user_id: currentUser.id // ID de la tabla public.users
            };

            if (autorizacionData.parentesco === "") {
                showTemporaryMessage(messageDiv.id, "Por favor, seleccione un parentesco.", true);
                return;
            }
            
            const { error } = await supabaseClient
                .from('autorizaciones')
                .insert([autorizacionData]);

            if (error) {
                console.error('[handleAutorizacionSubmit] Error al guardar autorizaci√≥n:', error);
                showTemporaryMessage(messageDiv.id, 'Error al guardar autorizaci√≥n: ' + error.message, true);
            } else {
                showTemporaryMessage(messageDiv.id, 'Autorizaci√≥n guardada exitosamente!', false);
                formAuth.reset();
                setTimeout(() => renderPlayerList(), 1500);
            }
        }

        async function generatePdf(type, id) { 
            // ... (sin cambios, ya que esta funci√≥n no depende del tipo de login)
            const contentArea = document.getElementById('content-area');
            let tempMessageDiv = document.getElementById('global-temp-message');
            if (!tempMessageDiv) {
                tempMessageDiv = document.createElement('div');
                tempMessageDiv.id = 'global-temp-message';
                tempMessageDiv.className = 'text-sm p-2 text-center fixed top-4 left-1/2 -translate-x-1/2 rounded shadow-lg z-50';
                document.body.appendChild(tempMessageDiv);
            }
            
            const showTempGlobalMessage = (message, isError = false) => {
                tempMessageDiv.textContent = message;
                tempMessageDiv.className = `text-sm p-2 text-center fixed top-4 left-1/2 -translate-x-1/2 rounded shadow-lg z-50 ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                setTimeout(() => { tempMessageDiv.style.display = 'none'; }, 3000); 
                tempMessageDiv.style.display = 'block';
            };
            
            if (typeof PDFLib === 'undefined' || !PDFLib.PDFDocument) { 
                showTempGlobalMessage("La librer√≠a PDF no est√° lista. Intente de nuevo.", true);
                return; 
            }
            const { PDFDocument } = PDFLib;
            const urlTramite = "https://zkak0.github.io/BotafogoApp/tramite_individual.pdf";
            const urlAutorizacion = "https://zkak0.github.io/BotafogoApp/autorizacion_jugadores.pdf";
            let pdfUrlToLoad, dataToFill, outputFilename, isTramite = false;

            if (type === 'tramite') {
                isTramite = true;
                const { data, error } = await supabaseClient.from('players').select('*').eq('id', id).single();
                if (error || !data) { 
                    showTempGlobalMessage("Error: Tr√°mite no encontrado en la base de datos.", true);
                    return; 
                }
                dataToFill = data; pdfUrlToLoad = urlTramite;
                outputFilename = `tramite_${(data.ci || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.pdf`;
            } else if (type === 'autorizacion') {
                const { data, error } = await supabaseClient.from('autorizaciones').select('*').eq('id', id).single();
                if (error || !data) { 
                    showTempGlobalMessage("Error: Autorizaci√≥n no encontrada en la base de datos.", true);
                    return; 
                }
                dataToFill = data; pdfUrlToLoad = urlAutorizacion;
                outputFilename = `autorizacion_${(dataToFill.jugador_nombre || 'jugador').replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.pdf`;
            } else { 
                showTempGlobalMessage('Error: Tipo de PDF desconocido.', true);
                return; 
            }

            try {
                const existingPdfBytes = await fetch(pdfUrlToLoad).then(res => {
                    if (!res.ok) throw new Error(`Error al descargar la plantilla PDF (${res.status})`); return res.arrayBuffer();
                });
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();

                if (isTramite) {
                    const fieldMap = {
                        ci: 'CEDULA IDENTIDAD', fechaNac: 'FECHA NAC', apellidoPaterno: 'APELLIDO PATERNO',
                        apellidoMaterno: 'APELLIDO MATERNO', nombres: 'NOMBRES', procedeClub: 'PROCEDE DEL CLUB',
                        procedeAsociacion: 'ASOCIACION', solicita_inscripcion: 'INSCRIPCION',
                        solicita_pase_interno: 'PASE INTERNO', solicita_pase_regional: 'PASE REGIONAL',
                        solicita_pase_externo: 'PASE EXTERNO', categoria_extranjero: 'EXTRANJERO',
                        categoria_libertad: 'LIBERTAD ACCION', categoria_adulto: 'ADULTO',
                        categoria_femenina: 'FEMENINA', categoria_infantil: 'INFANTIL'
                    };
                    const dataForPdf = { 
                        ci: dataToFill.ci, fechaNac: dataToFill.fecha_nac, apellidoPaterno: dataToFill.apellido_paterno,
                        apellidoMaterno: dataToFill.apellido_materno, nombres: dataToFill.nombres,
                        procedeClub: dataToFill.procede_club, procedeAsociacion: dataToFill.procede_asociacion,
                        solicita_inscripcion: dataToFill.solicita_inscripcion, solicita_pase_interno: dataToFill.solicita_pase_interno,
                        solicita_pase_regional: dataToFill.solicita_pase_regional, solicita_pase_externo: dataToFill.solicita_pase_externo,
                        categoria_extranjero: dataToFill.categoria_extranjero, categoria_libertad: dataToFill.categoria_libertad,
                        categoria_adulto: dataToFill.categoria_adulto, categoria_femenina: dataToFill.categoria_femenina,
                        categoria_infantil: dataToFill.categoria_infantil
                    };
                    Object.keys(fieldMap).forEach(key => {
                        try {
                            const field = form.getTextField(fieldMap[key]);
                            field.setText((dataForPdf[key] || '').toString()); 
                            field.setAlignment(PDFLib.TextAlignment.Center); 
                        } catch (e) { console.warn(`Campo no encontrado o error al rellenar (Tr√°mite) '${fieldMap[key]}': ${e.message}`); }
                    });
                } else { 
                    const fieldMapAuth = { nombreAutorizante: 'NOMBRE AUTORIZANTE', cedulaIdentidad: 'CEDULA IDENTIDAD', nombreJugador: 'NOMBRE JUGADOR', parentesco: 'PARENTESCO' };
                    const authDataMap = { 
                        nombreAutorizante: dataToFill.apoderado_nombre, 
                        cedulaIdentidad: dataToFill.apoderado_ci, 
                        nombreJugador: dataToFill.jugador_nombre, 
                        parentesco: dataToFill.parentesco 
                    };
                    Object.keys(fieldMapAuth).forEach(key => {
                        try {
                            const field = form.getTextField(fieldMapAuth[key]);
                            field.setText((authDataMap[key] || '').toString());
                            field.setAlignment(PDFLib.TextAlignment.Center);
                        } catch (e) { console.warn(`Campo no encontrado o error al rellenar (Autorizaci√≥n) '${fieldMapAuth[key]}': ${e.message}`); }
                    });
                }
                try { form.flatten(); } catch (e) { console.warn("Error al aplanar el PDF (flatten):", e); } 
                
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob); link.download = outputFilename;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                URL.revokeObjectURL(link.href); 
            } catch (error) { 
                showTempGlobalMessage(`Error al procesar el PDF: ${error.message}. Aseg√∫rese de que las plantillas PDF son accesibles.`, true);
            }
        }

        async function deleteTramite(tramiteId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || currentUser.role !== 'admin') {
                showTemporaryMessage(document.getElementById('content-area').id, 'Solo los administradores pueden eliminar tr√°mites.', true); 
                return;
            }
            const { data: tramiteData, error: fetchError } = await supabaseClient
                .from('players')
                .select('nombres, ci')
                .eq('id', tramiteId)
                .single();
            
            let itemName = `el tr√°mite ID ${tramiteId.substring(0,8)}...`; 
            if (tramiteData) {
                itemName = `el tr√°mite de ${tramiteData.nombres || tramiteData.ci}`;
            } else if (fetchError && fetchError.code !== 'PGRST116') { 
                console.error('Error al buscar informaci√≥n del tr√°mite para eliminar:', fetchError);
            }
            showDeleteConfirmModal(tramiteId, 'tramite', itemName);
        }
        
        async function deleteAutorizacion(autorizacionId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser
            if (!currentUser || currentUser.role !== 'admin') {
                showTemporaryMessage(document.getElementById('content-area').id, 'Solo los administradores pueden eliminar autorizaciones.', true);
                return;
            }
            const { data: authData, error: fetchError } = await supabaseClient
                .from('autorizaciones')
                .select('jugador_nombre')
                .eq('id', autorizacionId)
                .single();

            let itemName = `la autorizaci√≥n ID ${autorizacionId.substring(0,8)}...`;
            if (authData && authData.jugador_nombre) {
                itemName = `la autorizaci√≥n para ${authData.jugador_nombre}`;
            } else if (fetchError && fetchError.code !== 'PGRST116') {
                 console.error('Error al buscar informaci√≥n de la autorizaci√≥n para eliminar:', fetchError);
            }
            showDeleteConfirmModal(autorizacionId, 'autorizacion', itemName);
        }

        async function deleteUser(username_rut) { 
            console.log('[deleteUser] Iniciando para C√©dula/Username (RUT):', username_rut);
            const currentUser = JSON.parse(localStorage.getItem('currentUser')); // Usar currentUser

            if (!currentUser) {
                console.error('[deleteUser] Error: No hay datos de usuario actual.');
                showTemporaryMessage('add-user-error', 'Debes iniciar sesi√≥n.', true);
                return;
            }
            if (currentUser.username === username_rut) { 
                showTemporaryMessage('add-user-error', 'No puedes eliminar tu propia cuenta.', true);
                return;
            }
            if (currentUser.role !== 'admin') {
                showTemporaryMessage('add-user-error', 'Acceso no autorizado.', true);
                return;
            }
            
            const { data: userToDeleteData, error: fetchErr } = await supabaseClient
                .from('users')
                .select('nombre_completo') 
                .eq('username', username_rut) 
                .single();

            let itemName = `al usuario con RUT ${username_rut}`;
            if (userToDeleteData && userToDeleteData.nombre_completo) {
                itemName = userToDeleteData.nombre_completo; 
            }
            
            if (fetchErr && fetchErr.code !== 'PGRST116') { 
                 console.error('[deleteUser] Error al buscar informaci√≥n del usuario a eliminar de public.users:', fetchErr);
                 showTemporaryMessage('add-user-error', 'Error al buscar usuario: ' + fetchErr.message, true);
                 return;
            }
            if (!userToDeleteData && !fetchErr) { // Si no hay error pero no hay datos, el usuario no existe
                showTemporaryMessage('add-user-error', 'Usuario no encontrado para eliminar.', true);
                return;
            }
            
            showDeleteConfirmModal(username_rut, 'user', itemName);
        }

        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('sidebar-collapsed');
        }
        
        // --- INICIO: L√≥gica para C√©dula Identidad (Correcci√≥n de Perspectiva) ---
        // (Misma l√≥gica que antes, sin cambios en esta secci√≥n)
        // ...
        // --- FIN: L√≥gica para C√©dula Identidad ---

        // --- Inicializaci√≥n y Listeners Globales ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const usernameLoginInput = document.getElementById('username'); 
            const menuTramite = document.getElementById('menu-tramite');
            const menuAutorizacion = document.getElementById('menu-autorizacion');
            const menuUsuarios = document.getElementById('menu-usuarios');
            const menuLista = document.getElementById('menu-lista');
            const menuFotoCarnet = document.getElementById('menu-fotocarnet');
            const menuCedulaIdentidad = document.getElementById('menu-cedula-identidad');
            const collapseToggle = document.getElementById('collapse-toggle');
            const contentArea = document.getElementById('content-area');
            const logoutButton = document.getElementById('logout-button');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const confirmDeleteButton = document.getElementById('confirm-delete-btn');
            const cancelDeleteButton = document.getElementById('cancel-delete-btn');

            if(confirmDeleteButton) confirmDeleteButton.addEventListener('click', proceedWithDeletion);
            if(cancelDeleteButton) cancelDeleteButton.addEventListener('click', hideDeleteConfirmModal);

            const htmlElement = document.documentElement;
            const darkModeIcon = darkModeToggle.querySelector('i');
            const applyDarkMode = (isDark) => {
                htmlElement.classList.toggle('dark', isDark);
                darkModeIcon.classList.toggle('fa-sun', isDark);
                darkModeIcon.classList.toggle('fa-moon', !isDark);
            };
            const preferredDarkMode = localStorage.getItem('darkMode');
            applyDarkMode(preferredDarkMode === 'enabled');
            darkModeToggle.addEventListener('click', () => {
                const isDark = htmlElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
                applyDarkMode(isDark);
            });

            if (loginForm) loginForm.addEventListener('submit', window.handleLoginSubmit); 
            if (usernameLoginInput) usernameLoginInput.addEventListener('input', () => formatLoginUsername(usernameLoginInput));

            if (menuTramite) menuTramite.addEventListener('click', (e) => { e.preventDefault(); renderTramiteForm(); });
            if (menuAutorizacion) menuAutorizacion.addEventListener('click', (e) => { e.preventDefault(); renderAutorizacionForm(); });
            if (menuUsuarios) menuUsuarios.addEventListener('click', (e) => { e.preventDefault(); renderUserManagementForm(); });
            if (menuLista) menuLista.addEventListener('click', (e) => { e.preventDefault(); renderPlayerList(); });
            if (menuFotoCarnet) menuFotoCarnet.addEventListener('click', (e) => { e.preventDefault(); renderFotoCarnetForm(); });
            if (menuCedulaIdentidad) menuCedulaIdentidad.addEventListener('click', (e) => { e.preventDefault(); renderCedulaIdentidadForm(); });
            
            if (collapseToggle) collapseToggle.addEventListener('click', toggleSidebar);
            if (logoutButton) logoutButton.addEventListener('click', handleLogout);

            if (contentArea) {
                contentArea.addEventListener('click', async (event) => { 
                    const targetButton = event.target.closest('button.delete-btn, button.action-button[data-action="generate-pdf"], button.action-button[data-action="edit"]');
                    if (!targetButton) return;
                
                    const action = targetButton.dataset.action;
                    const type = targetButton.dataset.type;
                    const id = targetButton.dataset.id; 
                    const name = targetButton.dataset.name || `elemento ID ${id ? (typeof id === 'string' ? id.substring(0,8) + "..." : id) : "desconocido"}`;
                                                                    
                    if (action === 'delete') {
                        if (type === 'user' && id) { deleteUser(id); } 
                        else if (type === 'tramite' && id) { deleteTramite(id); }
                        else if (type === 'autorizacion' && id) { deleteAutorizacion(id); }
                        else if (type === 'fotocarnet' && id) { 
                            showDeleteConfirmModal(id, 'fotocarnet', name);
                        } else if (type === 'cedula' && id) { 
                            showDeleteConfirmModal(id, 'cedula', name);
                        }
                    } else if (action === 'edit' && type === 'user' && id) { 
                        populateUserEditForm(id);
                    } else if (action === 'generate-pdf' && id && (type === 'tramite' || type === 'autorizacion')) { 
                        generatePdf(type, id);
                    }
                });
            }

            // Verificar sesi√≥n local al cargar la p√°gina
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try { 
                    const user = JSON.parse(storedUser);
                    if (user && user.id) { // Verificar que el usuario y su ID existan
                        showAppScreen();
                    } else {
                        localStorage.removeItem('currentUser');
                        showLoginScreen();
                    }
                }
                catch (e) {
                    localStorage.removeItem('currentUser'); 
                    showLoginScreen(); 
                }
            } else {
                showLoginScreen();
            }
        });
    </script>
</body>
</html>
